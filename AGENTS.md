# Unsafe Code Lab

Educational security project teaching authorization confusion vulnerabilities through a SpongeBob-themed SaaS food ordering tutorial.

## Quick Reference

### Project Structure

```
spec/                           # E2E specs (uctest) - language-agnostic tests
  spec.yml                      # Inheritance configuration
  v301/                         # Version directories (vXYY = section X, exercise YY)

vulnerabilities/python/flask/confusion/webapp/
  r01_input_source_confusion/   # Section directories
    e01_dual_parameters/        # Exercise directories
    http/                       # Interactive demos (httpyac)
      common/setup.http         # Shared variables & helpers
      e01/                      # Exercise demos
        e01_*.exploit.http      # Shows vulnerability
        e01_*.fixed.http        # Shows fix

docs/confusion_curriculum/      # Authoritative curriculum design
docs/ai/                        # AI-specific documentation
```

### CLI Tools

| Command           | Purpose                    | Example            |
| ----------------- | -------------------------- | ------------------ |
| `ucdemo`          | Run demos                  | `ucdemo r03/e05`   |
| `uctest`          | Run specs                  | `uctest v301/`     |
| `ucsync`          | Regenerate inherited specs | `ucsync v302`      |
| `uclogs`          | View Docker logs           | `uclogs --tail=50` |
| `ucup` / `ucdown` | Start/stop services        | `ucup -d`          |

Additional helpers:

- `ucdemo <target> [--bail -v]` to run demos; `ucsync [versions]` regenerates inherited specs; `uclogs [-f|--tail=80]` tails compose logs.
- `uclint` for spec lint; `uv run docs verify` to validate generated READMEs.
- Source `tools/dev/unsafe-code-dev.sh` for navigation helpers like `ucfocus` and `ucgo`.

### Version Numbering

`vXYY` where X = section (1-5), YY = exercise (00-09)

| Section | Topic                    | Versions  |
| ------- | ------------------------ | --------- |
| r01     | Input source confusion   | v100-v108 |
| r02     | Authentication confusion | v201-v206 |
| r03     | Authorization confusion  | v301-v307 |
| r04     | Cardinality confusion    | v401-v405 |
| r05     | Normalization issues     | v501-v509 |

## Core Philosophy

### Documentation ≠ Gospel

Plans in `docs/confusion_curriculum/` and READMEs were written before implementation. They contain mistakes discovered only during coding.

**You are empowered to**: Adjust plans when implementation reveals better approaches. The test: Would a real developer plausibly write this code?

### Non-Negotiable Invariants

- TDD is sacred: exploit/fix demos and specs must fail when behavior is missing or broken. Never mute, skip, or weaken assertions.
- Inheritance-first specs: prefer adding new files over editing/deleting inherited ones; exclude only when behavior truly diverges.
- One vulnerability concept per exercise; keep vulns subtle and realistic. Tag the vulnerable function with `# @unsafe {...}` to anchor reviewers.
- Attacker always uses their own credentials; SpongeBob never attacks.
- HTTP assertions need explicit operators and unquoted RHS values.
- `~*.http` files are generated by `ucsync`—never edit them directly.

### Empirical Over Theoretical

Run tools to validate understanding:

- `ucdemo` to see actual demo failures
- `uctest` to verify spec behavior
- `uclogs` to see server errors
- `diff -r` to see actual code differences

When tests fail, check BOTH: syntax issue OR real problem in code.

## Core Invariants

### TDD Rules (Never Violate)

- Tests define intended behavior—failing tests are signals, not problems
- NEVER disable (`@disabled`), mock, or remove assertions to get green
- If test fails: (1) fix code, (2) fix test if wrong, (3) acknowledge incomplete

### Character Rules

**Attacker uses THEIR OWN credentials.** The exploit demonstrates application confusion, not password theft.

| Character | Role                    | Email                     |
| --------- | ----------------------- | ------------------------- |
| SpongeBob | Victim (NEVER attacker) | spongebob@krusty-krab.sea |
| Squidward | Insider attacker        | squidward@krusty-krab.sea |
| Plankton  | External attacker       | plankton@chum-bucket.sea  |
| Patrick   | VIP victim              | patrick@rock.sea          |
| Mr. Krabs | Business target         | krabs@krusty-krab.sea     |
| Sandy     | Technical user          | sandy@treedome.sea        |

**Attack relationships:**

- Squidward → SpongeBob (spite), Mr. Krabs (grievance)
- Plankton → Mr. Krabs (rivalry), Patrick (easy target)

**Narrative guidance:**

- Titles and impacts stay business-focused, not technical jargon.
- Rotate attacker/victim/impact combos across exercises to avoid repetition.

### Inheritance Rules (Critical Philosophy)

E2E specs model **SaaS evolution**. Real apps add features; they rarely break backwards compatibility.

**Design principle**: Each .http file should be as small as possible. Group assertions by **lifecycle**—assertions that appear at the same exercise AND disappear at the same exercise belong together.

**The optimization target**: Maximum inheritance. The vast majority of exercise transitions (X → X+1) should:

- Add new .http files alongside inherited ones
- NOT override or exclude previous specs
- Only exclude when behavior truly breaks (exceedingly rare)

**Implementation**:

- Never edit `~` prefixed files—run `ucsync` instead
- Override by creating file without `~` prefix
- Import from canonical locations (happy.http)
- Delegate to utils.cjs helpers aggressively

**The diff -r mandate**: After ANY exercise change, run `diff -r` between current and previous. Every externally visible change needs a spec.

### Vulnerability Scope & Markers

- Keep each exercise focused on a single confusion concept; avoid piling on multiple unrelated bugs.
- Place a nearby `# @unsafe {...}` tag so future maintainers can spot the intended vulnerable code quickly.

## Decision Matrix

### When Something Fails

1. **Demo fails** → `ucdemo <target> --bail -v`, then `uclogs --tail=50`
2. **Spec fails** → Check if `~` file (inherited) or local; read parent README
3. **500 error** → Usually missing operator in assertion (`== true`)
4. **Assertion mismatch** → Check for quotes on RHS; check spec/demo syntax match

### Adding New Exercise

1. Copy previous exercise directory
2. Wire blueprint in section `routes.py`
3. Update `spec/spec.yml` (inherit + exclude previous vuln)
4. Run `ucsync`
5. Write demos (TDD—expect failures first)
6. Implement vulnerability
7. Verify demos pass
8. Create specs for new behavior

## Fast Workflows

- Fix failing demo: `ucdemo <target> --bail -v` → classify syntax vs behavior → `uclogs --tail=80` → fix root cause → rerun.
- Fix failing spec: `uctest <path|@tag> -v` → if inherited, check parent and spec.yml overrides/exclusions → `ucsync` → rerun → confirm README intent.
- Add new exercise: copy previous, wire blueprint, update spec.yml (inherit + exclusions), `ucsync`; write `.exploit.http`/`.fixed.http` to fail first → implement vuln → make exploit pass → implement fix → make fixed pass → port to specs → `diff -r` previous vs new and spec every external change.
- Backfill specs: attempt inheriting later specs into earlier versions; fix code when drift is accidental; keep failures that reveal real vulns.

## Doc Map

- Curriculum: `docs/confusion_curriculum/*.md`, `docs/confusion_curriculum/endpoint_index.md`
- Section plans: `vulnerabilities/.../rXX_*/README.md`
- Playbook: `docs/ai/unsafe-lab-playbook.md`
- Specs & helpers: `spec/spec.yml`, `spec/utils.cjs`, `spec/**/*.http`
- Demos: `vulnerabilities/.../http/**/*.http`, per-section `http/common/setup.http`
- Runbooks/decision trees: `docs/ai/runbooks.md`, `docs/ai/decision-trees.md`, `docs/ai/spec-vs-demo.md`

## File Editing Guidelines

### Demo Files (vulnerabilities/.../http/\*.http)

- Use `response.parsedBody.field`
- Use raw `Authorization:` headers
- Reset state with `seedBalance()` helper
- Keep to 2-3 `console.info()` max
- httpyac auto-prefixes `@host`—never write `{{host}}/path`

### Spec Files (spec/*/*.http)

- Use `$(response).field("x")`
- Use `{{auth.basic("user")}}` helpers
- Seed inside named requests, not file scope
- Tags managed by `ucsync`—never hand-edit in `~` files

### HTTP Guardrails

- Demos (`ucdemo`/httpyac): assert with `?? status == 200` and `?? body field == value`; read bodies via `response.parsedBody`. httpyac auto-prefixes `@host`, so never write `{{host}}/path`.
- Specs (`uctest`): prefer `$(response)` helpers (`status()`, `field("x")`, `hasOnlyUserData()`, etc.).
- Variable scope: `{{ }}` blocks at file scope run once; blocks after `###` run per request. Use `exports.*` only inside `{{ }}`.
- Assertions always need an operator and typically an unquoted RHS.

## Quality Checklist

Before completing any task:

- [ ] Tests pass (`uctest`, `ucdemo`)
- [ ] No `~` files edited directly
- [ ] Character logic correct (attacker uses own creds)
- [ ] One concept per exercise
- [ ] Vulnerabilities are subtle (production-quality code)
- [ ] Variety in impacts (not same result repeated)
