---
name: spec-inheritance
description: Managing E2E spec inheritance via spec.yml and ucsync. Auto-invoke for "ref not found" errors, ucsync usage, exclusion decisions, spec.yml configuration, or when working with inherited (~) files. Do NOT use for writing test content - use http-e2e-specs skill instead.
---

# Spec Inheritance Management

Manage E2E spec inheritance, version relationships, and the ucsync tool.

## When to Use This Skill

- "ref not found" errors in tests
- Working with `spec.yml` configuration
- Deciding whether to exclude vs fix
- Understanding `~` prefixed files
- Running `ucsync` commands
- Troubleshooting inheritance chains

## When NOT to Use

- **Writing test content** → use `http-e2e-specs` skill
- **Assertion syntax issues** → use `http-assertion-gotchas` skill
- **Interactive demos** → use `http-interactive-demos` skill

## The Golden Rule

> **When an inherited test fails: SUSPECT THE SOURCE CODE FIRST**

Inherited tests worked in parent version. If they fail now:
1. Did refactoring accidentally fix a vulnerability?
2. Did an API change break the attack vector?
3. Is the test actually correct and code needs to stay vulnerable?

**Only exclude after confirming the test should not apply.**

## Understanding `~` Files

Files prefixed with `~` are **inherited from parent versions**:

```
spec/v302/cart/checkout/post/
├── ~happy.http      # Inherited from v301 - NEVER EDIT
├── ~authn.http      # Inherited from v301 - NEVER EDIT
├── authz.http       # Local override - can edit
└── exploit.http     # New for v302 - can edit
```

**Rules:**
- `~` files are READ-ONLY
- They are regenerated by `ucsync`
- To customize: create local file without `~` prefix
- To exclude: add to `spec.yml` exclusions

## spec.yml Structure

```yaml
v302:
  inherits: v301                    # Parent version
  tags: [r03, v302]                 # Applied to all tests
  tag_rules:
    "**/authn.http": [authn]        # Pattern-based tags
    "**/happy.http": [happy]
  exclude:                          # Tests that don't apply
    - "cart/create/post/validation.http::Empty restaurant_id"
```

### Inheritance Resolution

```
v303 inherits v302 inherits v301 inherits common
     ↓
For each test file:
1. Check v303 for local version
2. If not found, check v302
3. If not found, check v301
4. If not found, check common
5. Create ~file.http symlink to found version
```

## ucsync Commands

```bash
# Regenerate all inherited files for a version
ucsync v302

# Check inheritance health (dry run)
ucsync v302 --check

# Force regeneration (removes stale ~files)
ucsync v302 --force

# Sync all versions
ucsync --all
```

## Exclusion Format

```yaml
exclude:
  # Exclude entire file
  - "path/to/file.http"

  # Exclude specific test within file
  - "path/to/file.http::Test Title Here"

  # Pattern-based exclusion
  - "cart/**/validation.http"
```

## Decision Tree: Exclude vs Fix

```
Inherited test fails
│
├── Is the vulnerability STILL supposed to exist?
│   ├── YES → Fix SOURCE CODE to restore vulnerability
│   └── NO → Exclude the test
│
├── Did API signature change?
│   ├── YES → Create local override with updated calls
│   └── NO → Check assertion logic
│
└── Is test checking something version-specific?
    ├── YES → Exclude with comment explaining why
    └── NO → Debug further
```

See [decision-tree.md](decision-tree.md) for detailed flowchart.

## Common Scenarios

### Scenario 1: "ref not found" Error

```
Error: Reference 'cart_created' not found
```

**Diagnosis:**
1. Check if referenced test exists in inheritance chain
2. Check if referenced test was excluded
3. Check import chain (`@import` statements)

**Fix:**
```bash
# Check what's available
ucsync v302 --check

# If ref was in excluded file, either:
# a) Remove exclusion
# b) Create local fixture with same @name
```

### Scenario 2: Inherited Test Suddenly Fails

**First:** Check git diff for source code changes!

```bash
git diff HEAD~5 -- vulnerabilities/python/flask/.../
```

Common causes:
- Refactoring fixed the vulnerability accidentally
- API response format changed
- Auth mechanism was updated

### Scenario 3: Need to Customize Inherited Test

1. Create local file (without `~` prefix)
2. Copy content from inherited version
3. Make modifications
4. Run `ucsync` to clean up `~` version

```bash
# Copy inherited to local
cp spec/v302/cart/post/~happy.http spec/v302/cart/post/happy.http

# Edit local version
# ...

# Regenerate (removes now-shadowed ~file)
ucsync v302
```

## Import Chain Pattern

```http
# spec/v302/_imports.http
# @import ../common.http

# spec/v302/cart/_imports.http
# @import ../_imports.http

# spec/v302/cart/checkout/post/_imports.http
# @import ../../_imports.http

# spec/v302/cart/checkout/post/happy.http
# @import ./_imports.http
```

When files are inherited and deleted locally, update imports:
```http
# Before (local file existed)
# @import ./happy.http

# After (file now inherited)
# @import ./~happy.http
```

## Quality Checklist

Before excluding a test:
- [ ] Confirmed vulnerability should NOT exist in this version?
- [ ] Checked source code for accidental fixes?
- [ ] Documented WHY in exclusion comment?
- [ ] Ran `ucsync` after spec.yml changes?

## See Also

- [decision-tree.md](decision-tree.md) - Detailed decision flowchart
- `http-e2e-specs` skill - Writing test content
- `uclab-tools` skill - CLI tool reference
