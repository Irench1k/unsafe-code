model: haiku
---
# E2E Spec Sync Manager

Manage version inheritance and tag synchronization via the `ucsync` tool.

## Before Starting

Read these to understand the inheritance system:
- `spec/spec.yml` - Version configuration
- `spec/README.md` - Inheritance section

## Commands

```bash
# Generate inherited files + sync tags (all versions)
ucsync

# Specific version only
ucsync v302

# Preview changes (dry run)
ucsync -n

# Remove all generated files
ucsync clean
```

## spec.yml Format

```yaml
v301:
  description: "Dual-Auth Refund Approval"  # Human-readable
  inherits: v206                            # Parent version
  tags: [r03, v301]                         # Applied to ALL tests
  exclude:                                  # Skip from parent
    - auth/login/post/vuln-session-overwrite.http
  tag_rules:                                # Pattern-based tags
    "**/authn.http": [authn]
    "**/authz.http": [authz]
    "**/happy.http": [happy]
    "**/vuln-*.http": [vulnerable]
    "cart/**": [cart]
    "orders/**": [orders]
```

## Inheritance Rules

### File Generation
| Parent Has | Child Has | Result |
|-----------|-----------|--------|
| `happy.http` | nothing | Generate `~happy.http` |
| `happy.http` | `happy.http` (local) | Use local, warn to add to exclude |
| `happy.http` | in `exclude:` | Skip, no generation |

### Infrastructure Files (no ~ prefix)
- `_imports.http` - Import chains
- `_fixtures.http` - Named fixtures

These are copied as-is, not prefixed.

### Import Rewriting
When generating `~foo.http`, imports are rewritten:
```http
# Original (in parent)
# @import ./bar.http

# Generated (in child ~foo.http)
# @import ./~bar.http    # If bar.http is also inherited
# @import ./bar.http     # If child has local bar.http override
```

## Tag Computation

Tags are computed by combining:
1. Version-level tags (`tags: [r03, v301]`)
2. Pattern-matched tags from `tag_rules`
3. Inherited rules from parent versions

**All matching tags applied to ALL requests in matching files.**

## Common Tasks

### Add New Version

```bash
# 1. Add to spec.yml
v303:
  inherits: v302
  tags: [r03, v303]

# 2. Generate files
ucsync v303
```

### Exclude a File (Fixed Vuln)

```yaml
v302:
  inherits: v301
  exclude:
    - orders/refund-status/patch/vuln-dual-auth-refund.http
```

Then run `ucsync v302` to remove the `~` version.

### Acknowledge Local Override

When you create a local file that shadows inherited:
```
Warning: Local override 'cart/create/post/happy.http' shadows inherited file.
Add to 'exclude:' in spec.yml to acknowledge.
```

Add to `exclude:` to silence and document intent:
```yaml
v301:
  exclude:
    - cart/create/post/happy.http  # Multi-tenant override
```

### Add New Tag Rule

```yaml
v301:
  tag_rules:
    "**/multi-tenant.http": [multi-tenant]  # New pattern
```

Then run `ucsync` to update all `@tag` lines.

## Warning Messages

| Warning | Action |
|---------|--------|
| "Local override shadows inherited" | Add to `exclude:` in spec.yml |
| "Orphaned inherited file" | Parent file was removed; run `ucsync clean` |
| "Import target not found" | Check import paths in source file |

## Verification

After running ucsync:
```bash
# Check generated files exist
ls spec/v301/cart/create/post/~*.http

# Verify tags were updated
grep "@tag" spec/v301/cart/create/post/happy.http

# Run tests to ensure imports work
uctest v301/cart/create -k
```

## Important Notes

1. **Never edit `~` prefix files** - They're regenerated by ucsync
2. **Never edit `@tag` lines** - Managed by ucsync via spec.yml
3. **Run ucsync after spec.yml changes** - To propagate updates
4. **Inherited files are git-tracked** - Commit them after generation
