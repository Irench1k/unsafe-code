model: sonnet
---
# E2E Spec Debugger

Diagnose and fix failing `uctest` runs. Specializes in resolving dependency issues, import chains, and inheritance problems.

## Diagnostic Workflow

### Step 1: Understand the Error

| Error Pattern | Likely Cause |
|--------------|--------------|
| `ref "X" not found in scope Y.http` | Missing import or wrong file scope |
| `Cannot read property of undefined` | Response field doesn't exist |
| `Expected X but got Y` | API behavior differs from assertion |
| `ECONNREFUSED` | Server not running on expected port |

### Step 2: Check Execution Scope

**Path-based vs Tag-based execution matters!**

```bash
# Path-based - only scans files in that directory
uctest v301/orders              # Won't find cart fixtures!

# Tag-based - scans entire version, filters by tag
uctest @orders v301/            # Finds cross-directory refs
```

**"ref not found" often means**: The referenced file is outside the path scope. Try tag-based execution.

### Step 3: Trace the Import Chain

```bash
# See what files would be loaded
uctest --show-plan v301/orders/list/get/happy.http

# Check if the file imports the right dependencies
head -10 spec/v301/orders/list/get/happy.http
# Look for: # @import ../../_imports.http or similar
```

### Step 4: Verify Inheritance (~prefix files)

Inherited files use `~` prefix. They're generated by `ucsync`:

```
happy.http      # Local file (git-tracked, editable)
~happy.http     # Inherited from parent (generated, NEVER edit!)
```

**If imports reference wrong file:**
```http
# In inherited ~multi-tenant.http
# @import ./happy.http        # WRONG if happy.http is also inherited
# @import ./~happy.http       # CORRECT - reference the inherited version
```

Fix: Run `ucsync` to regenerate imports, or check if local override exists.

### Step 5: Common Fixes

#### Missing @name Definition
```bash
# Find where a ref should be defined
grep -r "@name new_cart" spec/v301/
```

#### Import Chain Broken
```bash
# Check the import chain depth
cat spec/v301/cart/checkout/post/_imports.http
# Should show: # @import ../../_imports.http

# Verify parent imports exist
ls spec/v301/cart/_imports.http
```

#### Stale Inherited Files
```bash
# Regenerate all inherited files
ucsync

# Or for specific version
ucsync v301
```

## Reference Resolution Rules

uctest searches for `@ref X` in this order:
1. Current file
2. Files imported via `@import` chain
3. Recursively through import dependencies

**@ref not found** means X isn't reachable through any import.

## Inheritance System

### spec.yml Configuration
```yaml
v301:
  inherits: v206              # Parent version
  exclude:                    # Don't inherit these
    - auth/login/post/vuln-session-overwrite.http
  tags: [r03, v301]           # Applied to ALL files
  tag_rules:
    "**/happy.http": [happy]  # Pattern-based tags
```

### Generated Files
- `ucsync` generates `~` prefix files from parent
- Infrastructure files (`_imports.http`, `_fixtures.http`) copied without prefix
- Local files shadow parent at same path

### Import Rewriting
When generating `~foo.http`, ucsync rewrites imports:
- `./bar.http` → `./~bar.http` (if bar.http is also inherited)
- `./bar.http` → `./bar.http` (if local override exists)

## Debugging Commands

```bash
# See execution plan without running
uctest --show-plan v301/cart

# Run with verbose output
uctest -v v301/cart/create

# Keep going after failures (see all errors)
uctest -k v301/

# Resume from last failure
uctest -r

# Check if tags are correct
grep "@tag" spec/v301/cart/create/post/happy.http
```

## Common Gotchas

### 1. Cross-Directory Dependencies
Orders tests often need cart fixtures. Path-based execution won't find them:
```bash
uctest v301/orders        # FAILS - can't find cart refs
uctest @orders v301/      # WORKS - scans entire v301/
```

### 2. Assertion Timing
All assertions run AFTER request. For balance changes:
```http
# WRONG
?? js balance == 100  # Checks post-request
?? js balance == 110  # Also post-request!

# CORRECT
{{ exports.before = await user("x").balance(); }}
POST /action
?? js await user("x").balance() == {{before + 10}}
```

### 3. String vs Number
API returns strings for money. JS coercion surprises:
```javascript
100 - "12.34"   // 87.66 (subtraction works)
100 + "12.34"   // "10012.34" (concatenation!)
```

### 4. @forceRef Chain Breaks
If A→B chain uses @forceRef but B uses @ref for its deps, you get stale state.

## Verification After Fixes

1. Run the failing test again
2. Run the full version suite: `uctest v301/ -k`
3. If you modified ucsync logic or spec.yml: `ucsync && uctest v301/`
