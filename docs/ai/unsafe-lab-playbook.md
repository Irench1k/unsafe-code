# Unsafe Code Lab Playbook (AI Operators)

Single-page orientation for new AI sessions working in this repo. Read this first, then jump to the linked deep-dive docs when needed.

---

## 0) Start-of-Session Checklist

- Confirm you are in `unsafe-code` (look for `vulnerabilities/python/flask/confusion/webapp`).
- Read `AGENTS.md` (repo) for the mental model and editing locks.
- Skim this playbook end-to-end once; revisit sections as needed.
- If touching `.http` files, open the HTTP syntax rules below before editing.
- If specs fail, run `uclogs --tail=80` after the failing test to capture the app side.

---

## 1) Core Invariants (Never Break)

- **TDD**: Exploit/fix tests must fail when behavior is missing or broken. Never mute tests, `@disabled`, or delete assertions to get green.
- **Inheritance-first**: Specs are designed to inherit. Prefer new files over edits/removals; exclude only when behavior truly diverges.
- **One concept per exercise**: Each `eNN_*` introduces exactly one confusion pattern; keep implementations and demos focused.
- **Subtle vulns**: Production-quality code with hidden flaws, annotated with `# @unsafe { ... }` near the vulnerable function.
- **Attacker uses own credentials**: Password theft is out-of-bounds; SpongeBob is never an attacker. Plankton/Squidward attack Krabs/Patrick/SpongeBob per relationship map.

---

## 2) HTTP Editing Guardrails (Specs vs Demos)

| Context | Status | Body access | Assertion form |
|---------|--------|-------------|----------------|
| **Demo** (`ucdemo`/httpyac) | `?? status == 200` | `response.parsedBody.field` | `?? js response.parsedBody.email == plankton@chum-bucket.sea` |
| **Spec** (`uctest`) | `?? js $(response).status() == 200` | `$(response).field("email")` | `?? js $(response).hasOnlyUserData("plankton") == true` |

- No quotes on RHS: `?? js $(response).field("status") == pending` (NOT `"pending"`).
- Assertions need an operator (`==`, `>`, etc.) or they become request bodies and 500.
- httpyac auto-prefixes `@host`; never write `GET {{host}}/path`.
- File-level `{{ }}` runs once; request-level `{{ }}` runs per request. Use `exports.*` only inside `{{ }}`.
- Never edit `~*.http` (generated by `ucsync`).

Deep dive: `docs/codex_handover/01_HTTP_SYNTAX.md` (for now) and `docs/ai/spec-vs-demo.md`.

---

## 3) Tool Belt (run from anywhere unless noted)

- `ucdemo <target>` – run demos (`r03/e05`, `.`); `--bail` to stop early.
- `uctest <path|@tag>` – run specs; auto `cd spec/`. Use `-k` to keep going.
- `ucsync [versions]` – regenerate inherited specs; NEVER hand-edit `~` files.
- `uclogs [-f|--tail=50]` – docker compose logs (compose at `vulnerabilities/.../compose.yml`).
- `ucup` / `ucdown` – start/stop services (works from subdirs).
- `uclint` – lint specs; `uv run docs verify` – check README generation.
- Navigation helpers (`ucfocus`, `ucgo`) via `tools/dev/unsafe-code-dev.sh`.

---

## 4) Workflow Cheatsheets (see docs/ai/runbooks.md for detail)

**Fix failing demo**
1. `ucdemo target --bail -v`; classify (syntax vs behavior).
2. Check logs (`uclogs --tail=80`).
3. Syntax issues: quotes/operator/host/prefix/imports. Behavior issues: fix app.
4. Re-run demo.

**Fix failing spec**
1. `uctest failing/http -v`; identify if file is inherited (`~`).
2. Check `ucsync -n` and README intent; fix code or add override/exclusion.
3. Re-run `ucsync`; `uctest`.

**Add new exercise (clone + TDD)**
1. Copy previous exercise dir; wire blueprint in section `routes.py`.
2. Update `spec/spec.yml` (inherits previous, add tags/exclusions), run `ucsync`.
3. Write `.exploit.http` / `.fixed.http` (narrative titles, attacker uses own creds); run `ucdemo` expecting failures first.
4. Implement endpoints + `@unsafe` vuln; rerun `ucdemo` until exploit passes.
5. Implement fix; `ucdemo` both files pass.
6. Port exploit/fix into specs (vuln_* + fix coverage); add happy/validation for new behaviors; run `uctest`.
7. Diff previous exercise to capture all externally visible changes; add specs for each.

**Backport/extend specs**
1. List endpoints/behaviors in target old version.
2. Try inheriting existing specs; copy/split as needed.
3. If failures expose new bugs, prefer fixing code over dropping inheritance unless README says otherwise.

---

## 5) Characters & Narrative Rules

- Attacker creds only; never steal passwords.
- SpongeBob = victim only. Plankton attacks Krabs/Patrick; Squidward attacks SpongeBob/Krabs.
- Titles/impact statements are behavioral/business, not technical jargon.
- Rotate attacker/victim/impact across exercises to avoid staleness.

Quick refs: `docs/codex_handover/07_CHARACTERS.md` (until we delete), `AGENTS.md`.

---

## 6) Document Map (read on demand)

- **Authoritative plan**: `vulnerabilities/.../rXX_*/README.md`, `docs/confusion_curriculum/*.md`.
- **Specs & helpers**: `spec/spec.yml`, `spec/utils.cjs`, `spec/**/*.http`.
- **Demos**: `vulnerabilities/.../http/**/*.http`, section `http/common/setup.http`.
- **Runbooks/decision trees**: `docs/ai/runbooks.md`, `docs/ai/decision-trees.md`, `docs/ai/spec-vs-demo.md`.
- **Tools**: `docs/codex_handover/04_TOOLS.md` (to be merged here) and `tools/dev/README.md`.

---

## 7) Diagnostics & Anti-Patterns

- 500 after adding assertion → missing operator.
- Values look equal but assertion fails → quotes on RHS.
- `ref not found` → check `@name` + imports + `ucsync -n`.
- Demo uses `$(response)` → wrong context.
- Using `/account/credits` for reset → wrong; use `seedBalance()` or platform helpers.
- Hardcoded menu IDs → fetch `/menu` and compute.

---

## 8) Default Moves When Unsure

1. Re-read section README + curriculum doc for that exercise.
2. Compare current behavior to previous exercise via `diff -r`.
3. Prefer making code match intended behavior rather than weakening tests.
4. If behavior truly changed, add exclusions and document why.
5. Keep specs small, import-heavy, and inheritance-friendly.

---

## 9) State Management Quick Tips

- Seed balances in-request using platform helpers, not at file scope.
- Cookies: `refreshCookie` only after login/mutating POST; cookieJar disabled in demos.
- For racey state, prefer `@forceRef` chains; if A uses `@forceRef B`, then B must `@forceRef` its deps.

---

Use this playbook as the entry point; update it whenever you learn a new pitfall. When it diverges, fix the document—do not rely on memory.
