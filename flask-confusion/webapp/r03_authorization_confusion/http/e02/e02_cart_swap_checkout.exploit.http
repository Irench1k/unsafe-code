# @import ../common/setup.http
@host = {{base_host}}/v302

### Menu items
GET /menu

{{
  await seedBalance("v302", "plankton@chum-bucket.sea", 100);

  exports.ultimate_krabby_feast = response.parsedBody.find(i => i.name.includes("Ultimate Krabby"));
  exports.fries = response.parsedBody.find(i => i.name == "Fries");

  console.info(`Fries: ${exports.fries.id} (${exports.fries.price})`);
  console.info(`Ultimate Krabby Feast: ${exports.ultimate_krabby_feast.id} (${exports.ultimate_krabby_feast.price})`);
}}

### Previous orders
GET /orders
Authorization: {{plankton_auth}}


### He creates a cart with an expensive meal (e.g. Ultimate Krabby Feast)
# Note: via mobile app that uses Basic Auth
# @name expensive_cart
POST /cart?restaurant_id=1
Authorization: {{plankton_auth}}

###
POST /cart/{{expensive_cart.cart_id}}/items
Content-Type: application/json
Authorization: {{plankton_auth}}

{ "item_id": "{{ultimate_krabby_feast.id}}" }


### Plankton logs in to get cookie session
POST /auth/login
Content-Type: application/json

{
  "email": "plankton@chum-bucket.sea",
  "password": "i_love_my_wife"
}

@session = {{refreshCookie(response)}}

### Then he creates another cart with just Fries - without finishing the expensive cart
# @name cheap_cart
POST /cart?restaurant_id=1
Cookie: {{session}}

@session = {{refreshCookie(response, session)}}

###
POST /cart/{{cheap_cart.cart_id}}/items
Content-Type: application/json
Cookie: {{session}}

{ "item_id": "{{fries.id}}" }

@session = {{refreshCookie(response, session)}}

### Plankton sends a confusing checkout request
# Cheap cart is still in session, but the path points to the expensive cart
POST /cart/{{expensive_cart.cart_id}}/checkout
Content-Type: application/json
Cookie: {{session}}

{
  "tip": "0",
  "delivery_address": "Chum Bucket"
}

?? status == 201
?? body total == {{parseFloat(fries.price) + 5.00}}

### He was only charged for the cheap cart from his session
GET /account/info
Cookie: {{session}}


### Order contains the expensive items
GET /orders
Cookie: {{session}}
