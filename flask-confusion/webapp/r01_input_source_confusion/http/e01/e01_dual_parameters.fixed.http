# @import ../common/setup.http
@host = {{base_host}}/v102

# Sandy fixes the vulnerability: the legacy `item` parameter is now ignored.

{{
  await seedBalance("v102", "sandy", 100);
}}


### Check Sandy's balance (seeded for idempotent demo)
GET /account/credits
Authorization: {{sandy_auth}}

?? status == 200


### Get the menu to identify cheap vs expensive items
# @name menu
GET /menu

{{
  const { cheap, expensive } = pickMenuExtremes(response.parsedBody);
  exports.cheap_item = cheap;
  exports.expensive_item = expensive;
}}

?? status == 200

{{
  console.info(`Menu: ${cheap_item.name} ($${cheap_item.price}) vs ${expensive_item.name} ($${expensive_item.price})`);
}}


### Get Sandy's balance before the test
# @name initial_balance
GET /account/credits
Authorization: {{sandy_auth}}

?? status == 200

{{
  console.info(`Balance BEFORE: $${response.parsedBody.balance}`);
}}


### Sandy verifies that sending both parameters charges the expensive item price
POST /orders
Authorization: {{sandy_auth}}
Content-Type: application/x-www-form-urlencoded

item={{cheap_item.id}}&items={{expensive_item.id}}&delivery_address=Treedome

?? status == 201
?? js response.parsedBody.total == {{expensive_item.price}}
?? js response.parsedBody.items[0].price == {{expensive_item.price}}


### Verify the balance was deducted correctly
GET /account/credits
Authorization: {{sandy_auth}}

?? status == 200

{{
  const before = parseFloat(initial_balance.balance);
  const after = parseFloat(response.parsedBody.balance);
  console.info(`FIX CONFIRMED: Paid $${(before - after).toFixed(2)} for ${expensive_item.name} worth $${expensive_item.price}`);
}}


### Verify order history shows the correct item
GET /orders
Authorization: {{sandy_auth}}

?? status == 200
