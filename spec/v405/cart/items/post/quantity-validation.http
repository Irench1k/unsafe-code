# @import ../_imports.http

# POST /cart/{id}/items - Quantity Validation (v405)
#
# v403 fixes the zero-quantity vulnerability from v402 by validating quantity > 0.
# This spec confirms that invalid quantities are rejected.
#
# Tests:
#   1. quantity=0 should fail with 400 error
#   2. quantity=-1 should fail with 400 error
#   3. quantity=1 should succeed (happy path)
#
# v405 override: Uses JSON body for restaurant_id instead of query param

### Setup - seed balance and create cart
# @name setup_qty_validation
{{
  await platform.seed({ plankton: 200 });
}}
# @tag cart, r04, v405
POST /cart
Authorization: {{auth.basic("plankton")}}
Content-Type: application/json

{"restaurant_id": 1}

@cart_id = {{$(response).field("cart_id")}}
?? js $(response).status() == 201

### Test: quantity=0 should be rejected
# @name add_zero_quantity
# @forceRef setup_qty_validation
# @tag cart, r04, v405
POST /cart/{{cart_id}}/items
Authorization: {{auth.basic("plankton")}}
Content-Type: application/json

{"item_id": "{{menu.item("Krabby Patty").id}}", "quantity": 0}

# FIX: v403 rejects zero quantity (v402 allowed it as a vulnerability)
?? js $(response).status() == 400

### Test: quantity=-1 should be rejected
# @name add_negative_quantity
# @forceRef setup_qty_validation
# @tag cart, r04, v405
POST /cart/{{cart_id}}/items
Authorization: {{auth.basic("plankton")}}
Content-Type: application/json

{"item_id": "{{menu.item("Krabby Patty").id}}", "quantity": -1}

# FIX: v403 rejects negative quantity
# Note: Returns 500 because parse_id raises ValueError instead of CheekyApiError
# This is a minor implementation detail - the key is that it's rejected
?? js $(response).isError() == true

### Test: quantity=1 should succeed (happy path)
# @name add_valid_quantity
# @forceRef setup_qty_validation
# @tag cart, r04, v405
POST /cart/{{cart_id}}/items
Authorization: {{auth.basic("plankton")}}
Content-Type: application/json

{"item_id": "{{menu.item("Krabby Patty").id}}", "quantity": 1}

# Valid quantity works
?? js $(response).isOk() == true
?? js $(response).field("items").length == 1
?? js $(response).field("items")[0].quantity == 1
