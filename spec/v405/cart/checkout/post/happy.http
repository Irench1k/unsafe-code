# @import ../_imports.http
# @import ../../items/post/~happy.http

# POST /cart/{id}/checkout happy path (v405 native)
# Override to use JSON body format for cart creation (v405 requires restaurant_id in body)
#
# Exports (for @forceRef by other tests):
#   new_order - Completed order (canonical fixture for orders tests)

### Checkout - Basic Auth + JSON
# @name new_order
# @forceRef cart_with_item
{{
  await platform.seedCredits("patrick", 200);
}}
# @tag cart, happy, r04, v405
POST /cart/{{cart_id}}/checkout
Authorization: {{auth.basic("patrick")}}
Content-Type: application/json

{ "delivery_address": "124 Conch Street, Bikini Bottom", "tip": 1 }

@order_id = {{$(response).field("order_id")}}
?? js $(response).status() == 201
?? js $(response).hasFields("order_id", "total", "items") == true


### Create second cart for multi-item checkout test (JSON body format)
# @name multi_cart
# @tag cart, happy, r04, v405
POST /cart
Authorization: {{auth.basic("patrick")}}
Content-Type: application/json

{"restaurant_id": 1}

@multi_cart_id = {{$(response).field("cart_id")}}
?? js $(response).status() == 201


### Add first item to multi-item cart
# @name multi_cart_item1
# @forceRef multi_cart
# @tag cart, happy, r04, v405
POST /cart/{{multi_cart_id}}/items
Authorization: {{auth.basic("patrick")}}
Content-Type: application/json

{ "item_id": "{{menu.item("Krabby Patty").id}}" }

?? js $(response).isOk() == true


### Add second item to multi-item cart
# @name multi_cart_item2
# @forceRef multi_cart_item1
# @tag cart, happy, r04, v405
POST /cart/{{multi_cart_id}}/items
Authorization: {{auth.basic("patrick")}}
Content-Type: application/json

{ "item_id": "{{menu.item("Fries").id}}" }

?? js $(response).isOk() == true
?? js $(response).field("items").length == 2


### Multi-item checkout - Cookie Auth + JSON
# @name multi_order
# @forceRef multi_cart_item2
{{
  await platform.seedCredits("patrick", 200);
}}
# @tag cart, happy, r04, v405
POST /cart/{{multi_cart_id}}/checkout
Cookie: {{auth.login("patrick")}}
Content-Type: application/json

{ "delivery_address": "Under the Rock", "tip": 2 }

?? js $(response).status() == 201
?? js $(response).hasFields("order_id", "total", "items") == true
?? js $(response).field("items").length == 2
