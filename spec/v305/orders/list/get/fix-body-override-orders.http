# @import ../_imports.http

# =============================================================================
# FIX VERIFICATION: R03 Body Override No Longer Leaks Orders (v305)
# =============================================================================
#
# DESCRIPTION:
#   v305 removes the call to bind_to_restaurant() in list_orders() and uses
#   only g.restaurant_id from the authenticated API key. This ensures the
#   restaurant_id in the request body is IGNORED.
#
# WHAT WAS FIXED:
#   The handler no longer inspects request containers (query, form, JSON body)
#   for restaurant_id. It trusts only the authenticated API key.
#
# VERIFICATION:
#   Plankton (Chum Bucket owner):
#   1. Authenticates with his Chum Bucket API key (restaurant_id=2)
#   2. Sends GET /orders with JSON body: {"restaurant_id": 1}
#   3. Handler ignores body and uses g.restaurant_id from API key
#   4. Plankton sees ONLY Chum Bucket orders (empty, since none exist)
#
# STATUS: FIXED in v305 (exploit fails, body parameter ignored)
# =============================================================================

# =============================================================================
# SETUP: Create some orders at Krusty Krab
# =============================================================================

### Seed the database with fresh state
# @name seed
{{
  await platform.seed();
}}
# @ucskip
# @tag orders, r03, v305
GET /orders
X-API-Key: {{auth.restaurant("krusty_krab")}}


### SpongeBob places an order at Krusty Krab
# @name spongebob_order
# @forceRef seed
{{
  const cookie = await auth.login("spongebob");
  exports.spongebobCookie = cookie;
}}
# @tag orders, r03, v305
POST /cart
Cookie: {{spongebobCookie}}
Content-Type: application/json

{ "restaurant_id": 1 }


### Add item to cart
# @name add_item
# @forceRef spongebob_order
# @tag orders, r03, v305
POST /cart/{{$(spongebob_order).field("cart_id")}}/items
Cookie: {{spongebobCookie}}
Content-Type: application/json

{ "item_id": 1 }


### Checkout
# @name checkout
# @forceRef add_item
# @tag orders, r03, v305
POST /cart/{{$(spongebob_order).field("cart_id")}}/checkout
Cookie: {{spongebobCookie}}
Content-Type: application/json

{ "delivery_address": "124 Conch Street" }


# =============================================================================
# FIX VERIFICATION: Body override attempt is ignored
# =============================================================================

### Plankton verifies his Chum Bucket key only shows Chum Bucket orders
# @name baseline
# @forceRef checkout
# @tag orders, r03, v305
GET /orders
X-API-Key: {{auth.restaurant("chum_bucket")}}

# Baseline: Should see ONLY Chum Bucket orders (none from Krusty Krab)
?? js $(response).isOk() == true
# All orders returned (if any) must be from Chum Bucket (restaurant_id=2)
?? js $(response).body().every(o => o.restaurant_id === 2) == true
# Specifically: no Krusty Krab orders should be visible
?? js $(response).body().filter(o => o.restaurant_id === 1).length == 0


### FIX VERIFICATION: Plankton's body override attempt is IGNORED
# The API key says "Chum Bucket" and the body says "Krusty Krab"
# But v305 ignores the body and uses only g.restaurant_id from the API key
# @name fix_verification
# @forceRef baseline
# @tag orders, r03, v305
GET /orders
X-API-Key: {{auth.restaurant("chum_bucket")}}
Content-Type: application/json

{ "restaurant_id": 1 }

# FIXED: Exploit fails - body parameter ignored, sees only own restaurant
?? js $(response).isOk() == true
# All orders returned (if any) must be from Chum Bucket
?? js $(response).body().every(o => o.restaurant_id === 2) == true
# The body's restaurant_id=1 was IGNORED - no Krusty Krab orders visible
?? js $(response).body().filter(o => o.restaurant_id === 1).length == 0
