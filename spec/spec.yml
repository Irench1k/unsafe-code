# E2E Spec Suite Configuration (Nested Layout)
#
# Each version is a directory with nested structure:
#   v301/
#     _imports.http
#     account/credits/get/
#       happy.http
#       authn.http
#     orders/refund-status/patch/
#       vuln-dual-auth-refund.http
#
# Inheritance:
#   - Child versions inherit entire directory tree from parent
#   - Inherited files get ~ prefix: ~happy.http
#   - Infrastructure files (_imports.http, _fixtures.http) copied without prefix
#   - New/override files in child take precedence
#   - Use 'exclude' to skip specific paths from parent
#
# File naming:
#   - New specs: path/to/file.http (git-tracked)
#   - Inherited: path/to/~file.http (generated)
#
# Tag Management:
#   ucsync OWNS all @tag lines in .http files. Tags are computed from:
#   1. Version-level: tags: [r03, v301]  → all tests in version get these
#   2. Pattern-level: tag_rules with glob patterns → matching files get extra tags
#   3. Inherited: child versions inherit parent's tags + tag_rules
#
#   Pattern syntax (fnmatch-style):
#     "auth/**"           → all files under auth/
#     "**/authn.http"     → all authn.http files anywhere
#     "orders/refund/**"  → specific path
#     "**/vuln-*.http"    → filename pattern
#
# Run: ucsync (or uv run ucsync)

# =============================================================================
# Authentication Confusion (r02) - Full inheritance chain
# =============================================================================

v201:
  description: Session Hijack (r02/e01) - Base version
  tags: [r02, v201]

  # Pattern-based tag additions (glob patterns)
  tag_rules:
    # By test type (filename convention)
    "**/authn.http": [authn]          # Authentication boundary tests
    "**/authz.http": [authz]          # Authorization tests
    "**/happy.http": [happy]          # Happy path tests
    "**/vuln-*.http": [vulnerable]    # Vulnerability demonstrations

    # By resource (directory)
    "auth/**": [auth]                 # Auth endpoints
    "account/**": [account]           # Account endpoints
    "cart/**": [cart]                 # Cart endpoints
    "orders/**": [orders]             # Order endpoints
    "menu/**": [menu]                 # Menu endpoints

v202:
  inherits: v201
  description: Credit Top-ups (r02/e02)
  tags: [r02, v202]

v203:
  inherits: v202
  description: Fake Header Refund (r02/e03)
  tags: [r02, v203]

v204:
  inherits: v203
  description: Manager Mode (r02/e04)
  tags: [r02, v204]

v205:
  inherits: v204
  description: Session Overwrite Vulnerability (r02/e05)
  tags: [r02, v205]

v206:
  inherits: v205
  description: Session Overwrite Fixed (r02/e06)
  tags: [r02, v206]
  exclude:
    # v206 fixes the session overwrite vulnerability
    - auth/login/post/vuln-session-overwrite.http

# =============================================================================
# Authorization Confusion (r03) - Multi-tenant versions
# =============================================================================

v301:
  description: Dual-Auth Refund Approval
  tags: [r03, v301]
  inherits: v206
  exclude:
    # v301 introduces multi-restaurant model (requires restaurant_id parameter)
    # These files use POST /cart without restaurant_id - must be overridden
    - cart/create/post/happy.http
    - cart/checkout/post/pollution.http
    - cart/items/post/pollution.http
    # v301 returns tip as decimal string "0.00" vs v206's numeric 0
    - cart/checkout/post/validation.http

  # Pattern-based tag additions (glob patterns)
  tag_rules:
    # By test type (filename convention)
    "**/authn.http": [authn]          # Authentication boundary tests
    "**/authz.http": [authz]          # Authorization tests
    "**/happy.http": [happy]          # Happy path tests
    "**/vuln-*.http": [vulnerable]    # Vulnerability demonstrations

    # By resource (directory)
    "auth/**": [auth]                 # Auth endpoints
    "account/**": [account]           # Account endpoints
    "cart/**": [cart]                 # Cart endpoints
    "orders/**": [orders]             # Order endpoints
    "menu/**": [menu]                 # Menu endpoints
    "restaurants/**": [restaurants]   # Restaurant endpoints

v302:
  inherits: v301
  description: Cart Swap Checkout (session vs path confusion)
  tags: [r03, v302]
  exclude:
    # v302 fixes the dual-auth vulnerability, so exclude that vuln test
    - orders/refund-status/patch/vuln-dual-auth-refund.http
    # exclude obsolete validation test as v302 now accepts JSON as well
    - account/credits/post/validation.http
  # Inherits tag_rules from v301
  # New files in v302/:
  #   - cart/create/post/v302.http (session cart behavior)
  #   - cart/checkout/post/vuln-cart-swap-checkout.http (new vulnerability)
  #   - orders/refund-status/patch/v302.http (tests the fix)
