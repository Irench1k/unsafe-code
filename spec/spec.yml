# E2E Spec Suite Configuration (Nested Layout)
#
# Each version is a directory with nested structure:
#   v301/
#     _imports.http
#     account/credits/get/
#       happy.http
#       authn.http
#     orders/refund-status/patch/
#       vuln-dual-auth-refund.http
#
# Inheritance:
#   - Child versions inherit entire directory tree from parent
#   - Inherited files get ~ prefix: ~happy.http
#   - Infrastructure files (_imports.http, _fixtures.http) copied without prefix
#   - New/override files in child take precedence
#   - Use 'exclude' to skip specific paths from parent
#
# File naming:
#   - New specs: path/to/file.http (git-tracked)
#   - Inherited: path/to/~file.http (generated)
#
# Tag Management:
#   ucsync OWNS all @tag lines in .http files. Tags are computed from:
#   1. Version-level: tags: [r03, v301]  → all tests in version get these
#   2. Pattern-level: tag_rules with glob patterns → matching files get extra tags
#   3. Inherited: child versions inherit parent's tags + tag_rules
#
#   Pattern syntax (fnmatch-style):
#     "auth/**"           → all files under auth/
#     "**/authn.http"     → all authn.http files anywhere
#     "orders/refund/**"  → specific path
#     "**/vuln-*.http"    → filename pattern
#
# Run: ucsync (or uv run ucsync)

# =============================================================================
# Authentication Confusion (r02) - Full inheritance chain
# =============================================================================

v201:
  description: Session Hijack (r02/e01) - Base version
  tags: [r02, v201]

  # Pattern-based tag additions (glob patterns)
  tag_rules:
    # By test type (filename convention)
    "**/authn.http": [authn]          # Authentication boundary tests
    "**/authz.http": [authz]          # Authorization tests
    "**/happy.http": [happy]          # Happy path tests
    "**/vuln-*.http": [vulnerable]    # Vulnerability demonstrations

    # By resource (directory)
    "auth/**": [auth]                 # Auth endpoints
    "account/**": [account]           # Account endpoints
    "cart/**": [cart]                 # Cart endpoints
    "orders/**": [orders]             # Order endpoints
    "menu/**": [menu]                 # Menu endpoints

v202:
  inherits: v201
  description: Credit Top-ups (r02/e02)
  tags: [r02, v202]
  exclude:
    # e02 accidentally fixed the session hijack by checking cookie auth before
    # instantiating Basic Auth (no g.email poisoning)
    - orders/list/get/vuln-session-hijack.http

v203:
  inherits: v202
  description: Fake Header Refund (r02/e03)
  tags: [r02, v203]
  # Inherits v202's exclusion of vuln-session-hijack.http

v204:
  inherits: v203
  description: Manager Mode (r02/e04)
  tags: [r02, v204]
  exclude:
    # e04 intentionally fixed session hijack by setting g.email only after
    # password verification succeeds
    - orders/list/get/vuln-session-hijack.http

v205:
  inherits: v204
  description: Session Overwrite Vulnerability (r02/e05)
  tags: [r02, v205]
  exclude:
    # v205 fixes the session hijack vulnerability from v201
    - orders/list/get/vuln-session-hijack.http

v206:
  inherits: v205
  description: Session Overwrite Fixed (r02/e06)
  tags: [r02, v206]
  exclude:
    # v206 fixes the session overwrite vulnerability
    - auth/login/post/vuln-session-overwrite.http

# =============================================================================
# Authorization Confusion (r03) - Multi-tenant versions
# =============================================================================

v301:
  description: Dual-Auth Refund Approval
  tags: [r03, v301]
  inherits: v206
  exclude:
    # v301 introduces multi-restaurant model (requires restaurant_id parameter)
    # These files use POST /cart without restaurant_id - must be overridden
    - cart/create/post/happy.http
    - cart/checkout/post/pollution.http
    - cart/items/post/pollution.http
    # v301 returns tip as decimal string "0.00" vs v206's numeric 0
    - cart/checkout/post/validation.http
    # v301 has local overrides with different test assertions
    - orders/refund/post/happy.http
    - orders/refund-status/patch/happy.http
    - orders/refund-status/get/happy.http

  # Pattern-based tag additions (glob patterns)
  tag_rules:
    # By test type (filename convention)
    "**/authn.http": [authn]          # Authentication boundary tests
    "**/authz.http": [authz]          # Authorization tests
    "**/happy.http": [happy]          # Happy path tests
    "**/vuln-*.http": [vulnerable]    # Vulnerability demonstrations

    # By resource (directory)
    "auth/**": [auth]                 # Auth endpoints
    "account/**": [account]           # Account endpoints
    "cart/**": [cart]                 # Cart endpoints
    "orders/**": [orders]             # Order endpoints
    "menu/**": [menu]                 # Menu endpoints
    "restaurants/**": [restaurants]   # Restaurant endpoints

v302:
  inherits: v301
  description: Cart Swap Checkout (session vs path confusion)
  tags: [r03, v302]
  exclude:
    # v302 fixes the dual-auth vulnerability, so exclude that vuln test
    - orders/refund-status/patch/vuln-dual-auth-refund.http
    # exclude obsolete validation test as v302 now accepts JSON as well
    - account/credits/post/validation.http
  # Inherits tag_rules from v301
  # New files in v302/:
  #   - cart/create/post/v302.http (session cart behavior)
  #   - cart/checkout/post/vuln-cart-swap-checkout.http (new vulnerability)
  #   - orders/refund-status/patch/v302.http (tests the fix)

v303:
  inherits: v302
  description: Menu Edits Without Restaurant ID (cross-tenant menu tampering)
  tags: [r03, v303]
  exclude:
    # v303 fixes the cart swap vulnerability from v302
    # The fix stores the resolved cart in g during the decorator and reuses it
    # in the handler, preventing session/path confusion
    - cart/checkout/post/vuln-cart-swap-checkout.http
  # Inherits tag_rules from v302
  # New files in v303/:
  #   - menu/item/patch/happy.http (manager updates own menu item)
  #   - menu/item/patch/authn.http (requires restaurant API key auth)
  #   - menu/item/patch/vuln-cross-tenant-menu.http (new vulnerability)

v304:
  inherits: v303
  description: Body Override Leaks Competitor Orders (query vs body confusion)
  tags: [r03, v304]
  exclude:
    # v304 fixes the cross-tenant menu edit vulnerability from v303
    # The fix adds proper restaurant_id validation to the menu edit route
    - menu/item/patch/vuln-cross-tenant-menu.http
  # New files in v304/:
  #   - orders/list/get/vuln-body-override-orders.http (new vulnerability)

v305:
  inherits: v304
  description: Failed Update Leaks Order Data (validation before authorization)
  tags: [r03, v305]
  exclude:
    # v305 fixes the body override vulnerability from v304
    # The fix ensures bind_to_restaurant() only reads from authorized sources
    - orders/list/get/vuln-body-override-orders.http
    # v305 vulnerability: idempotency check runs before authorization, so these
    # tests that use idempotent requests on cancelled orders will leak data
    # instead of returning auth errors (the vulnerability is demonstrated in
    # vuln-failed-update-leaks.http instead)
    - orders/status/patch/authz.http
    - orders/status/patch/transitions.http
  # New files in v305/:
  #   - orders/status/patch/vuln-failed-update-leaks.http (new vulnerability)

v306:
  inherits: v305
  description: Domain Tokens Accept Any Mailbox (token scope confusion)
  tags: [r03, v306]
  exclude:
    # v306 fixes the failed update leak vulnerability from v305
    # The fix returns appropriate error without leaking order data
    - orders/status/patch/vuln-failed-update-leaks.http
  # New files in v306/:
  #   - restaurants/post/vuln-domain-token-any-mailbox.http (new vulnerability)

v307:
  inherits: v306
  description: Token Swap Hijacks Restaurants (middleware confusion)
  tags: [r03, v307]
  exclude:
    # v307 fixes the domain token any mailbox vulnerability from v306
    # The fix verifies the token email matches admin@domain
    - restaurants/post/vuln-domain-token-any-mailbox.http
  # New files in v307/:
  #   - restaurants/patch/vuln-token-swap-hijack.http (new vulnerability)

v308:
  inherits: v307
  description: The fixed v307 version
  tags: [r03, v308]
  exclude:
    - restaurants/patch/vuln-token-swap-hijack.http

v401:
  inherits: v308
  description: Coupon Stacking
  tags: [r04, v401]

v402:
  inherits: v401
  description: Zero Quantity Free Items
  tags: [r04, v402]
  exclude:
    # v402 fixes the coupon stacking vulnerability from v401
    # The fix adds a check: if any cart_item.coupon_id is not None, skip applying
    - cart/apply-coupons/get/vuln-stacking.http

v403:
  inherits: v402
  description: Duplicate Coupon Replay
  tags: [r04, v403]
  # v403 vulnerabilities are in checkout coupon handling - no v402 exclusions needed

v404:
  inherits: v403
  description: Batch Refund Bypass
  tags: [r04, v404]
  # v404 introduces batch refund endpoint with authz flaw - no v403 exclusions needed yet
