# @import ../common.http

# PATCH /orders/{id}/refund/status guardrails
# Tests refund approval workflow and state transitions

# =============================================================================
# SETUP: Order with delivered status and pending refund
# =============================================================================

### Create an order and request a refund
{{
  await platform.seed({
    squidward: 200
  });
}}
# @name cart
POST /cart?restaurant_id=1
Authorization: {{auth.basic("squidward")}}

@cart_id = {{$(response).field("cart_id")}}

### Add item
# @name add_item
# @forceRef cart
POST /cart/{{cart_id}}/items
Authorization: {{auth.basic("squidward")}}
Content-Type: application/json

{ "item_id": "4" }

### Checkout
# @name checkout
# @forceRef add_item
POST /cart/{{cart_id}}/checkout
Authorization: {{auth.basic("squidward")}}
Content-Type: application/json

{ "delivery_address": "Squidward House", "tip": 1 }

@order_id = {{$(response).field("order_id")}}
@order_total = {{$(response).total()}}
?? js $(response).status() == 201

### Restaurant marks order as delivered
# @name delivered
# @forceRef checkout
PATCH /orders/{{order_id}}/status
X-API-Key: {{auth.restaurant("krusty_krab")}}
Content-Type: application/x-www-form-urlencoded

status=delivered

?? js $(response).isOk() == true

### Request a large refund (requires manual approval)
# @name refund
# @forceRef delivered
POST /orders/{{order_id}}/refund
Authorization: {{auth.basic("squidward")}}
Content-Type: application/x-www-form-urlencoded

amount={{order_total}}&reason=Too salty

@refund_id = {{$(response).field("refund_id")}}
?? js $(response).isOk() == true
?? js $(response).field("status") == pending

# =============================================================================
# PENDING REFUND: Authorization checks
# =============================================================================

### Customer's balance unchanged while refund pending
# @name balance
# @forceRef refund
# @tag ci, r03, vulnerable
GET /account/info
Authorization: {{auth.basic("squidward")}}

@customer_balance = {{$(response).field("balance")}}
?? js $(response).field("balance") == {{200 - order_total}}

### Customer cannot approve their own refund
# @ref refund
# @tag ci, r03, vulnerable
PATCH /orders/{{order_id}}/refund/status
Authorization: {{auth.basic("squidward")}}
Content-Type: application/x-www-form-urlencoded

status=approved

?? js $(response).isError() == true

### Other restaurant cannot approve refund
# @ref refund
# @tag ci, r03, vulnerable
PATCH /orders/{{order_id}}/refund/status
X-API-Key: {{auth.restaurant("chum_bucket")}}
Content-Type: application/x-www-form-urlencoded

status=approved

?? js $(response).isError() == true

# =============================================================================
# APPROVED REFUND: State becomes immutable
# =============================================================================

### Restaurant manager approves refund
# @name approved
# @forceRef refund
PATCH /orders/{{order_id}}/refund/status
X-API-Key: {{auth.restaurant("krusty_krab")}}
Content-Type: application/x-www-form-urlencoded

status=approved

?? js $(response).isOk() == true
?? js $(response).field("status") == approved

### Customer's balance restored after approval
# @forceRef approved
# @tag ci, r03, vulnerable
GET /account/info
Authorization: {{auth.basic("squidward")}}

?? js $(response).field("balance") == 200.00

### Cannot approve already approved refund
# @ref approved
# @tag ci, r03, vulnerable
PATCH /orders/{{order_id}}/refund/status
X-API-Key: {{auth.restaurant("krusty_krab")}}
Content-Type: application/x-www-form-urlencoded

status=approved

?? js $(response).isError() == true

### Cannot reject already approved refund
# @ref approved
# @tag ci, r03, vulnerable
PATCH /orders/{{order_id}}/refund/status
X-API-Key: {{auth.restaurant("krusty_krab")}}
Content-Type: application/x-www-form-urlencoded

status=rejected

?? js $(response).isError() == true

### Cannot set approved refund back to pending
# @ref approved
# @tag ci, r03, vulnerable
PATCH /orders/{{order_id}}/refund/status
X-API-Key: {{auth.restaurant("krusty_krab")}}
Content-Type: application/x-www-form-urlencoded

status=pending

?? js $(response).isError() == true

# =============================================================================
# REJECTED REFUND: State becomes immutable
# =============================================================================

### Refund can be set to rejected
# @name rejected
# @forceRef refund
PATCH /orders/{{order_id}}/refund/status
X-API-Key: {{auth.restaurant("krusty_krab")}}
Content-Type: application/x-www-form-urlencoded

status=rejected

?? js $(response).isOk() == true
?? js $(response).field("status") == rejected

### Customer's balance unchanged after rejection
# @forceRef rejected
# @tag ci, r03, vulnerable
GET /account/info
Authorization: {{auth.basic("squidward")}}

?? js $(response).field("balance") == {{200 - order_total}}

### Cannot set rejected refund back to pending
# @ref rejected
# @tag ci, r03, vulnerable
PATCH /orders/{{order_id}}/refund/status
X-API-Key: {{auth.restaurant("krusty_krab")}}
Content-Type: application/x-www-form-urlencoded

status=pending

?? js $(response).isError() == true

### Cannot approve rejected refund
# @ref rejected
# @tag ci, r03, vulnerable
PATCH /orders/{{order_id}}/refund/status
X-API-Key: {{auth.restaurant("krusty_krab")}}
Content-Type: application/x-www-form-urlencoded

status=approved

?? js $(response).isError() == true
