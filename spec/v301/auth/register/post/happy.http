# @import ../_imports.http

# POST /auth/register happy path
# Complete email verification registration flow

# =============================================================================
# STEP 1: Initiate registration
# =============================================================================

### Start registration sends verification email
# @name start_registration
{{
  await platform.reset();
  await mailpit.clear();
  exports.regEmail = testEmail("reg");
}}
# @tag auth, happy, r03, v301
POST /auth/register
Content-Type: application/json

{
  "email": "{{regEmail}}",
  "password": "password123"
}

?? js $(response).isOk() == true
?? js $(response).hasFields("email", "status") == true
?? js $(response).field("email") == {{regEmail}}
?? js $(response).field("status") == verification_email_sent

# =============================================================================
# STEP 2: Verify email receipt
# =============================================================================

### Verification email is sent to correct address
# @name find_email
# @forceRef start_registration
# @tag auth, happy, r03, v301
GET {{mailpitBase}}/messages?limit=1

@mail_id = {{ $(response).field("messages")[0].ID }}
?? js $(response).isOk() == true
?? js $(response).field("count") == 1
?? js $(response).field("messages")[0].From.Address == no-reply@app.cheeky.sea
?? js $(response).field("messages")[0].To[0].Address == {{regEmail}}

### Verification email contains valid token
# @name find_token
# @forceRef find_email
# @tag auth, happy, r03, v301
GET {{mailpitBase}}/message/{{mail_id}}

@token = {{ $(response).field("Text").match(/token=([A-Za-z0-9._-]+)/)[1] }}
?? js $(response).isOk() == true
?? js $(response).field("Text").includes("Click the link") == true

# =============================================================================
# STEP 3: Complete registration
# =============================================================================

### Token completes registration and creates account
# @forceRef find_token
# @tag auth, happy, r03, v301
POST /auth/register
Content-Type: application/json

{
  "token": "{{token}}",
  "password": "password123",
  "name": "Test User"
}

?? js $(response).isOk() == true
?? js $(response).hasFields("email", "status") == true
?? js $(response).field("email") == {{regEmail}}
?? js $(response).field("status") == user_created
