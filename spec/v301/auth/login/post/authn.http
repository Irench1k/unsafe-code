# @import ../_imports.http

# POST /auth/login guardrails
# Content type enforcement, credential validation, and pollution defenses

# =============================================================================
# CONTENT TYPE VALIDATION
# =============================================================================

### Login fails with urlencoded body (JSON required)
{{
    await platform.reset();
}}
# @tag auth, authn, r03, v301
POST /auth/login
Content-Type: application/x-www-form-urlencoded

email={{user("spongebob").email}}&password={{user("spongebob").password}}

?? js $(response).isError() == true

# =============================================================================
# CREDENTIAL VALIDATION
# =============================================================================

### Login fails with wrong password
# @tag auth, authn, r03, v301
POST /auth/login
Content-Type: application/json

{
  "email": "{{user("spongebob").email}}",
  "password": "wrongpassword"
}

?? js $(response).isError() == true

# =============================================================================
# PARAMETER POLLUTION: Query vs Body email
# =============================================================================

### Login uses email from body, not query
# @tag auth, authn, r03, v301
POST /auth/login?email={{user("spongebob").email}}
Content-Type: application/json

{
  "email": "{{user("plankton").email}}",
  "password": "{{user("plankton").password}}"
}

?? js $(response).isOk() == true
?? js $(response).hasFields("email", "message") == true
?? js $(response).field("email") == {{user("plankton").email}}
?? js $(response).field("message") == Login successful
?? js extractCookie(response) != null == true

# =============================================================================
# HEADER POLLUTION: Basic Auth does not bypass login
# =============================================================================

### Basic Auth header does not bypass login authentication
# @tag auth, authn, r03, v301
POST /auth/login
Authorization: {{auth.basic("plankton")}}
Content-Type: application/json

{
  "email": "{{user("spongebob").email}}",
  "password": "{{user("plankton").password}}"
}

@potentiallyPollutedCookie = {{extractCookie(response)}}
?? js $(response).field("email") == {{user("plankton").email}}

### Cookie is bound to correct user
# @tag auth, authn, r03, v301
GET /account/info
Cookie: {{potentiallyPollutedCookie}}

?? js $(response).field("email") == {{user("plankton").email}}

# =============================================================================
# SESSION FIXATION: Cookie header does not bypass login
# =============================================================================

### Cookie header does not bypass login authentication
# @name sessionFixation
{{
  exports.anotherCookie = auth.login("plankton");
}}
# @tag auth, authn, r03, v301
POST /auth/login
Cookie: {{anotherCookie}}
Content-Type: application/json

{
  "email": "{{user("spongebob").email}}",
  "password": "{{user("plankton").password}}"
}

?? js $(response).field("email") == {{user("plankton").email}}

### Original session is not hijacked
# @ref sessionFixation
# @tag auth, authn, r03, v301
GET /account/info
Cookie: {{anotherCookie}}

?? js $(response).field("email") == {{user("plankton").email}}
