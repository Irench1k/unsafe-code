# @import ../common.http

# POST /auth/logout happy path
# Tests logout flow and session behavior

# =============================================================================
# SETUP: Establish session
# =============================================================================

### Login to establish session
# @name login
{{
  await platform.reset();
}}
POST /auth/login
Content-Type: application/json

{
  "email": "{{user("spongebob").email}}",
  "password": "{{user("spongebob").password}}"
}

@sessionCookie = {{extractCookie(response)}}
?? js $(response).isOk() == true

# =============================================================================
# SESSION VALIDATION
# =============================================================================

### Session works before logout
# @forceRef login
# @tag ci, r03, vulnerable
GET /account/info
Cookie: {{sessionCookie}}

?? js $(response).isOk() == true
?? js $(response).field("email") == {{user("spongebob").email}}

# =============================================================================
# LOGOUT FLOW
# =============================================================================

### Logout returns success message
# @ref login
# @tag ci, r03, vulnerable
POST /auth/logout
Cookie: {{sessionCookie}}

?? js $(response).isOk() == true
?? js $(response).field("message") == Logout successful

# NOTE: Flask doesn't invalidate sessions server-side, only removes claims from the
# session cookie or deletes the cookie entirely (both are client-side).
# Consider building a vulnerability demonstration out of it? Right now our demo app
# doesn't have any scenarios where old claims could cause a security issue.
