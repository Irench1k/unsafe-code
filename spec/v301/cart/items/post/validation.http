# @import ../_imports.http
# @import _fixtures.http

# POST /cart/{id}/items validation guardrails
# Item validation, ownership, parameter pollution, cross-restaurant

# =============================================================================
# ITEM VALIDATION
# =============================================================================

### Add item with invalid item_id fails
# @ref patrick_cart
# @tag cart, r03, v301
POST /cart/{{cart_id}}/items
Authorization: {{auth.basic("patrick")}}
Content-Type: application/json

{ "item_id": "9999" }

?? js $(response).isError() == true

### Add item with unavailable item_id fails
# @ref patrick_cart
# @tag cart, r03, v301
POST /cart/{{cart_id}}/items
Authorization: {{auth.basic("patrick")}}
Content-Type: application/json

{ "item_id": "{{unavailable_item_id}}" }

?? js $(response).isError() == true

# =============================================================================
# OWNERSHIP
# =============================================================================

### Cannot add items to another user's cart - Basic Auth
# @ref patrick_cart
# @tag cart, r03, v301
POST /cart/{{cart_id}}/items
Authorization: {{auth.basic("plankton")}}
Content-Type: application/json

{ "item_id": "{{item_id}}" }

?? js $(response).isError() == true

### Cannot add items to another user's cart - Cookie Auth
# @ref patrick_cart
# @tag cart, r03, v301
POST /cart/{{cart_id}}/items
Cookie: {{auth.login("plankton")}}
Content-Type: application/json

{ "item_id": "{{item_id}}" }

?? js $(response).isError() == true

# =============================================================================
# PARAMETER POLLUTION
# =============================================================================

### Cannot inject cart_id via query + body - Basic Auth
# @forceRef patrick_cart
# @forceRef plankton_cart
# @tag cart, r03, v301
POST /cart/{{cart_id}}/items?cart_id={{plankton_cart_id}}
Authorization: {{auth.basic("plankton")}}
Content-Type: application/json

{ "item_id": "{{item_id}}", "cart_id": "{{plankton_cart_id}}" }

?? js $(response).isError() == true

### Cannot inject cart_id via query + body - Cookie Auth
# @ref patrick_cart
# @ref plankton_cart
# @tag cart, r03, v301
POST /cart/{{cart_id}}/items?cart_id={{plankton_cart_id}}
Cookie: {{auth.login("plankton")}}
Content-Type: application/json

{ "item_id": "{{item_id}}", "cart_id": "{{plankton_cart_id}}" }

?? js $(response).isError() == true

# =============================================================================
# CROSS-RESTAURANT
# =============================================================================

### Items can't be added from another restaurant
# @forceRef chum_bucket_cart
# @ref patrick_cart
# @tag cart, r03, v301
POST /cart/{{chum_bucket_cart_id}}/items
Authorization: {{auth.basic("plankton")}}
Content-Type: application/json

{ "item_id": "{{item_id}}" }

?? js $(response).isError() == true
