# @import ../_imports.http
# @import ../../items/post/happy.http

# POST /cart/{id}/checkout reuse isolation
# Reusing a cart after checkout should create new orders

### First checkout from happy path cart
# @name first_order
# @forceRef cart_with_one_item
# @tag cart, r03, v301
POST /cart/{{cart_id}}/checkout
Authorization: {{auth.basic("patrick")}}
Content-Type: application/json

{ "delivery_address": "Chum Bucket", "tip": 1.00 }

@first_order_id = {{$(response).field("order_id")}}
?? js $(response).isOk() == true

### Re-add item after checkout to reuse cart
# @name cart_reloaded
# @forceRef first_order
# @ucskip endpoint
# @tag cart, r03, v301
POST /cart/{{cart_id}}/items
Authorization: {{auth.basic("patrick")}}
Content-Type: application/json

{ "item_id": {{item_secondary}} }

?? js $(response).isOk() == true

### Second checkout creates new order
# @name second_order
# @forceRef cart_reloaded
# @tag cart, r03, v301
POST /cart/{{cart_id}}/checkout
Authorization: {{auth.basic("patrick")}}
Content-Type: application/json

{ "delivery_address": "Chum Bucket", "tip": 1.00 }

@second_order_id = {{$(response).field("order_id")}}
?? js $(response).isOk() == true
?? js $(response).field("order_id") != {{first_order_id}}

### Add another item and checkout again
# @name cart_with_more_items
# @forceRef second_order
# @ucskip endpoint
# @tag cart, r03, v301
POST /cart/{{cart_id}}/items
Authorization: {{auth.basic("patrick")}}
Content-Type: application/json

{ "item_id": {{item_secondary}} }

?? js $(response).isOk() == true

### Third checkout yields another distinct order
# @name third_order
# @forceRef cart_with_more_items
# @tag cart, r03, v301
POST /cart/{{cart_id}}/checkout
Authorization: {{auth.basic("patrick")}}
Content-Type: application/json

{ "delivery_address": "New Location", "tip": 5.00 }

@third_order_id = {{$(response).field("order_id")}}
?? js $(response).isOk() == true
?? js $(response).field("order_id") != {{first_order_id}}
?? js $(response).field("order_id") != {{second_order_id}}
