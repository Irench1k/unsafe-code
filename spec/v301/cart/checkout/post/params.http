# @import ../_imports.http
# @import ../../items/post/happy.http

# POST /cart/{id}/checkout parameter pollution & restaurant immutability

# =============================================================================
# CART ID INJECTION
# =============================================================================

### Injection via query param fails
# Attempts to checkout Patrick's cart while injecting Plankton's cart_id
# @forceRef cart_with_one_item
# @forceRef cart_with_one_item_plankton
# @tag cart, r03, v301
POST /cart/{{cart_id}}/checkout?cart_id={{plankton_cart_id}}
Authorization: {{auth.basic("plankton")}}
Content-Type: application/json

{ "delivery_address": "Chum Bucket", "tip": 0 }

?? js $(response).isError() == true

### Injection via body param fails
# @ref cart_with_one_item_plankton
# @tag cart, r03, v301
POST /cart/{{cart_id}}/checkout
Authorization: {{auth.basic("plankton")}}
Content-Type: application/json

{ "delivery_address": "Chum Bucket", "tip": 0, "cart_id": "{{plankton_cart_id}}" }

?? js $(response).isError() == true

### Injection via query + body fails - Basic Auth
# @ref cart_with_one_item_plankton
# @tag cart, r03, v301
POST /cart/{{cart_id}}/checkout?cart_id={{plankton_cart_id}}
Authorization: {{auth.basic("plankton")}}
Content-Type: application/json

{ "delivery_address": "Chum Bucket", "tip": 0, "cart_id": "{{plankton_cart_id}}" }

?? js $(response).isError() == true

### Injection via query + body fails - Cookie Auth
# @ref cart_with_one_item_plankton
# @tag cart, r03, v301
POST /cart/{{cart_id}}/checkout?cart_id={{plankton_cart_id}}
Cookie: {{auth.login("plankton")}}
Content-Type: application/json

{ "delivery_address": "Chum Bucket", "tip": 0, "cart_id": "{{plankton_cart_id}}" }

?? js $(response).isError() == true

# =============================================================================
# RESTAURANT ID IMMUTABILITY
# =============================================================================

### Restaurant ID ignored via query - JSON
# @ref cart_with_one_item_plankton
# @tag cart, r03, v301
POST /cart/{{plankton_cart_id}}/checkout?restaurant_id=2
Authorization: {{auth.basic("plankton")}}
Content-Type: application/json

{ "delivery_address": "Chum Bucket", "tip": 0 }

?? js $(response).isOk() == true
?? js $(response).field("restaurant_id") == 1

### Restaurant ID ignored via body - JSON
# @ref cart_with_one_item_plankton
# @tag cart, r03, v301
POST /cart/{{plankton_cart_id}}/checkout
Authorization: {{auth.basic("plankton")}}
Content-Type: application/json

{ "delivery_address": "Chum Bucket", "tip": 0, "restaurant_id": 2 }

?? js $(response).isOk() == true
?? js $(response).field("restaurant_id") == 1

### Restaurant ID ignored via query + body - JSON
# @ref cart_with_one_item_plankton
# @tag cart, r03, v301
POST /cart/{{plankton_cart_id}}/checkout?restaurant_id=2
Authorization: {{auth.basic("plankton")}}
Content-Type: application/json

{ "delivery_address": "Chum Bucket", "tip": 0, "restaurant_id": 2 }

?? js $(response).isOk() == true
?? js $(response).field("restaurant_id") == 1

### Restaurant ID ignored via query + body - Form
# @ref cart_with_one_item_plankton
# @tag cart, r03, v301
POST /cart/{{plankton_cart_id}}/checkout?restaurant_id=2
Authorization: {{auth.basic("plankton")}}
Content-Type: application/x-www-form-urlencoded

tip=0&delivery_address=Chum Bucket&restaurant_id=2

?? js $(response).isOk() == true
?? js $(response).field("restaurant_id") == 1
