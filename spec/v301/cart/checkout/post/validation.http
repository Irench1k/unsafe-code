# @import ../_imports.http
# @import ../../items/post/~happy.http

# POST /cart/{id}/checkout validation guardrails (v301+)
# Optional fields and balance requirements

### Tip is optional (defaults to 0)
# @forceRef cart_with_item
{{
  await platform.seedCredits("patrick", 200);
}}
# @tag cart, r03, v301
POST /cart/{{cart_id}}/checkout
Authorization: {{auth.basic("patrick")}}
Content-Type: application/json

{ "delivery_address": "Under the Rock" }

?? js $(response).status() == 201
?? js $(response).hasFields("order_id", "total", "items") == true
?? js Number($(response).field("tip")) == 0

### Insufficient balance fails checkout
# @ref cart_with_item
{{
  // Set balance to less than item cost
  await platform.seedCredits("patrick", 0.50);
}}
# @tag cart, r03, v301
POST /cart/{{cart_id}}/checkout
Authorization: {{auth.basic("patrick")}}
Content-Type: application/json

{ "delivery_address": "Under the Rock", "tip": 1 }

?? js $(response).isError() == true
