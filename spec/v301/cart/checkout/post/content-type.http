# @import ../_imports.http
# @import ../../items/post/~happy.http

# POST /cart/{id}/checkout content type variations (v301+ multi-tenant)
# Auth + content-type combinations for single and multi-item carts
# This version creates carts with restaurant_id for multi-tenant support

# =============================================================================
# SINGLE ITEM CHECKOUT (reuses imported fixtures from items/post/_fixtures.http)
# =============================================================================

### Checkout - Basic Auth + Form
# @forceRef cart_with_item
{{
  await platform.seedCredits("patrick", 200);
}}
# @tag cart, r03, v301
POST /cart/{{cart_id}}/checkout
Authorization: {{auth.basic("patrick")}}
Content-Type: application/x-www-form-urlencoded

tip=2&delivery_address=Under the Rock

?? js $(response).status() == 201
?? js $(response).hasFields("order_id", "total", "items") == true

### Checkout - Cookie Auth + Form
# @ref cart_with_item
{{
  await platform.seedCredits("patrick", 200);
}}
# @tag cart, r03, v301
POST /cart/{{cart_id}}/checkout
Cookie: {{auth.login("patrick")}}
Content-Type: application/x-www-form-urlencoded

tip=2&delivery_address=Under the Rock

?? js $(response).status() == 201
?? js $(response).hasFields("order_id", "total", "items") == true

# =============================================================================
# MULTIPLE ITEMS CHECKOUT - Create fresh cart with restaurant_id
# =============================================================================

### Create new cart for multi-item content type tests
# @name ct_cart
# @tag cart, r03, v301
POST /cart?restaurant_id=1
Authorization: {{auth.basic("patrick")}}

@ct_cart_id = {{$(response).field("cart_id")}}
?? js $(response).status() == 201


### Add first item to content-type test cart
# @name ct_item1
# @forceRef ct_cart
# @tag cart, r03, v301
POST /cart/{{ct_cart_id}}/items
Authorization: {{auth.basic("patrick")}}
Content-Type: application/json

{ "item_id": "{{menu.item("Krabby Patty").id}}" }

?? js $(response).isOk() == true


### Add second item to content-type test cart
# @name ct_item2
# @forceRef ct_item1
# @tag cart, r03, v301
POST /cart/{{ct_cart_id}}/items
Authorization: {{auth.basic("patrick")}}
Content-Type: application/json

{ "item_id": "{{menu.item("Fries").id}}" }

?? js $(response).isOk() == true


### Add third item to content-type test cart
# @name cart_three_items
# @forceRef ct_item2
# @tag cart, r03, v301
POST /cart/{{ct_cart_id}}/items
Authorization: {{auth.basic("patrick")}}
Content-Type: application/json

{ "item_id": "{{menu.item("Kelp Shake").id}}" }

?? js $(response).isOk() == true
?? js $(response).field("items").length == 3


### Multiple items checkout - Basic Auth + Form
# @forceRef cart_three_items
{{
  await platform.seedCredits("patrick", 200);
}}
# @tag cart, r03, v301
POST /cart/{{ct_cart_id}}/checkout
Authorization: {{auth.basic("patrick")}}
Content-Type: application/x-www-form-urlencoded

tip=2&delivery_address=Under the Rock

?? js $(response).status() == 201
?? js $(response).hasFields("order_id", "total", "items") == true
?? js $(response).field("items").length >= 2


### Create another cart for Cookie Auth + JSON test
# @name ct_cart2
# @tag cart, r03, v301
POST /cart?restaurant_id=1
Authorization: {{auth.basic("patrick")}}

@ct_cart2_id = {{$(response).field("cart_id")}}
?? js $(response).status() == 201


### Add items to second content-type test cart
# @name ct2_item1
# @forceRef ct_cart2
# @tag cart, r03, v301
POST /cart/{{ct_cart2_id}}/items
Authorization: {{auth.basic("patrick")}}
Content-Type: application/json

{ "item_id": "{{menu.item("Krabby Patty").id}}" }

?? js $(response).isOk() == true


### Add second item to second cart
# @name ct2_item2
# @forceRef ct2_item1
# @tag cart, r03, v301
POST /cart/{{ct_cart2_id}}/items
Authorization: {{auth.basic("patrick")}}
Content-Type: application/json

{ "item_id": "{{menu.item("Fries").id}}" }

?? js $(response).isOk() == true
?? js $(response).field("items").length == 2


### Multiple items checkout - Cookie Auth + JSON
# @forceRef ct2_item2
{{
  await platform.seedCredits("patrick", 200);
}}
# @tag cart, r03, v301
POST /cart/{{ct_cart2_id}}/checkout
Cookie: {{auth.login("patrick")}}
Content-Type: application/json

{ "delivery_address": "Under the Rock", "tip": 2 }

?? js $(response).status() == 201
?? js $(response).hasFields("order_id", "total", "items") == true
?? js $(response).field("items").length >= 2


### Create another cart for Cookie Auth + Form test
# @name ct_cart3
# @tag cart, r03, v301
POST /cart?restaurant_id=1
Authorization: {{auth.basic("patrick")}}

@ct_cart3_id = {{$(response).field("cart_id")}}
?? js $(response).status() == 201


### Add items to third content-type test cart
# @name ct3_item1
# @forceRef ct_cart3
# @tag cart, r03, v301
POST /cart/{{ct_cart3_id}}/items
Authorization: {{auth.basic("patrick")}}
Content-Type: application/json

{ "item_id": "{{menu.item("Krabby Patty").id}}" }

?? js $(response).isOk() == true


### Add second item to third cart
# @name ct3_item2
# @forceRef ct3_item1
# @tag cart, r03, v301
POST /cart/{{ct_cart3_id}}/items
Authorization: {{auth.basic("patrick")}}
Content-Type: application/json

{ "item_id": "{{menu.item("Fries").id}}" }

?? js $(response).isOk() == true
?? js $(response).field("items").length == 2


### Multiple items checkout - Cookie Auth + Form
# @forceRef ct3_item2
{{
  await platform.seedCredits("patrick", 200);
}}
# @tag cart, r03, v301
POST /cart/{{ct_cart3_id}}/checkout
Cookie: {{auth.login("patrick")}}
Content-Type: application/x-www-form-urlencoded

tip=2&delivery_address=Under the Rock

?? js $(response).status() == 201
?? js $(response).hasFields("order_id", "total", "items") == true
?? js $(response).field("items").length >= 2
