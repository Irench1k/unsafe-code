# @import ../common.http

# GET /orders guardrails
# Tests access control and data isolation for order listing

# =============================================================================
# AUTHENTICATION REQUIRED
# =============================================================================

### Orders list requires authentication
{{
  await platform.seed({
    plankton: 200,
    squidward: 150,
    spongebob: 100
  });
}}
# @tag ci, r03, vulnerable
GET /orders

?? js $(response).isError() == true
?? js $(response).field("error") == Authentication required

# =============================================================================
# CUSTOMER DATA ISOLATION
# =============================================================================

### Customer sees only their own orders - Basic Auth
# @tag ci, r03, vulnerable
GET /orders
Authorization: {{auth.basic("spongebob")}}

?? js $(response).isOk() == true
?? js $(response).hasOnlyUserData("spongebob") == true

### Customer sees only their own orders - Cookie Auth
# @tag ci, r03, vulnerable
GET /orders
Cookie: {{auth.login("plankton")}}

?? js $(response).isOk() == true
?? js $(response).hasOnlyUserData("plankton") == true

# =============================================================================
# RESTAURANT DATA ISOLATION
# =============================================================================

### Restaurant manager sees only their restaurant's orders
# @tag ci, r03, vulnerable
GET /orders
X-API-Key: {{auth.restaurant("krusty_krab")}}

?? js $(response).isOk() == true
?? js $(response).every(o => o.restaurant_id === 1) == true

### Different restaurant sees only their orders
# @tag ci, r03, vulnerable
GET /orders
X-API-Key: {{auth.restaurant("chum_bucket")}}

?? js $(response).isOk() == true
?? js $(response).every(o => o.restaurant_id === 2) == true

# =============================================================================
# AUTH PRIORITY: Customer auth takes precedence
# =============================================================================

### Customer cookie takes precedence over restaurant header
# @tag ci, r03, vulnerable
GET /orders
Cookie: {{auth.login("spongebob")}}
X-API-Key: {{auth.restaurant("krusty_krab")}}

?? js $(response).isOk() == true
