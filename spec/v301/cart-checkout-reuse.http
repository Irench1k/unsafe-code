# @import ../common.http

# Cart reuse isolation
# Verifies that reusing a cart after checkout creates NEW orders
# and does NOT modify or overwrite the original order

# =============================================================================
# SETUP: Initial cart with item
# =============================================================================

### Create cart
# @name cart
{{
  await platform.seed({
    plankton: 500
  });
}}
POST /cart?restaurant_id=1
Authorization: {{auth.basic("plankton")}}

@cart_id = {{$(response).field("cart_id")}}
?? js $(response).status() == 201

### Add initial item
# @name cart_with_item
# @forceRef cart
POST /cart/{{cart_id}}/items
Authorization: {{auth.basic("plankton")}}
Content-Type: application/json

{ "item_id": "4" }

?? js $(response).isOk() == true

# =============================================================================
# FIRST CHECKOUT: Creates order #1
# =============================================================================

### First checkout
# @name first_order
# @forceRef cart_with_item
POST /cart/{{cart_id}}/checkout
Authorization: {{auth.basic("plankton")}}
Content-Type: application/json

{ "delivery_address": "Chum Bucket", "tip": 1.00 }

@first_order_id = {{$(response).field("order_id")}}
@first_order_total = {{$(response).field("total")}}
@first_order_items_count = {{$(response).field("items").length}}
?? js $(response).isOk() == true

# =============================================================================
# IMMEDIATE REUSE: Should create NEW order, not overwrite
# =============================================================================

### Second checkout (immediate reuse)
# @name second_order
# @forceRef first_order
POST /cart/{{cart_id}}/checkout
Authorization: {{auth.basic("plankton")}}
Content-Type: application/json

{ "delivery_address": "Chum Bucket", "tip": 1.00 }

@second_order_id = {{$(response).field("order_id")}}
?? js $(response).isOk() == true
?? js $(response).field("order_id") != {{first_order_id}}

# =============================================================================
# CART MODIFICATION + REUSE: Third checkout with more items
# =============================================================================

### Add another item to cart
# @name second_order_with_more_items
# @forceRef second_order
POST /cart/{{cart_id}}/items
Authorization: {{auth.basic("plankton")}}
Content-Type: application/json

{ "item_id": "6" }

?? js $(response).isOk() == true

### Third checkout with different data
# @name third_order
# @forceRef second_order_with_more_items
POST /cart/{{cart_id}}/checkout
Authorization: {{auth.basic("plankton")}}
Content-Type: application/json

{ "delivery_address": "New Location", "tip": 5.00 }

@third_order_id = {{$(response).field("order_id")}}
@third_order_total = {{$(response).field("total")}}
@third_order_items_count = {{$(response).field("items").length}}
?? js $(response).isOk() == true
?? js $(response).field("order_id") != {{first_order_id}}
?? js $(response).field("order_id") != {{second_order_id}}

# =============================================================================
# VERIFICATION: Original orders remain unchanged
# =============================================================================

### Verify first order remains completely unchanged
# @forceRef third_order
# @tag ci, r03, vulnerable
GET /orders
Authorization: {{auth.basic("plankton")}}

?? js $(response).isOk() == true
{{
    const firstOrder = $(response).find(o => o.order_id == first_order_id);

    test("first order still exists", () => firstOrder != null);
    test("first order has original item count", () => firstOrder.items.length == first_order_items_count);
    test("first order has original total", () => firstOrder.total == first_order_total);
    test("first order has original tip", () => firstOrder.tip == 1.00);
    test("first order has original address", () => firstOrder.delivery_address == "Chum Bucket");

    // Third order should be different
    const thirdOrder = $(response).find(o => o.order_id == third_order_id);
    test("third order exists", () => thirdOrder != null);
    test("third order has more items", () => thirdOrder.items.length > first_order_items_count);
    test("third order has different total", () => thirdOrder.total != first_order_total);
    test("third order has different tip", () => thirdOrder.tip == 5.00);
    test("third order has different address", () => thirdOrder.delivery_address == "New Location");
}}
