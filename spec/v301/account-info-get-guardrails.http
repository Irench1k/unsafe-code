# @import ../common.http

# GET /account/info guardrails
# Tests authentication requirements and credential validation

# =============================================================================
# INVALID CREDENTIALS: Short username format
# =============================================================================

### Basic Auth requires correct credentials (short username)
{{
  await platform.seed({
    plankton: 200,
    squidward: 150
  });
}}
# @tag ci, r03, vulnerable
GET /account/info
Authorization: Basic plankton:wrongpassword

?? js $(response).isError() == true
?? js $(response).field("error") == Authentication required

### Basic Auth rejects empty password (short username)
# @tag ci, r03, vulnerable
GET /account/info
Authorization: Basic plankton:

?? js $(response).isError() == true
?? js $(response).field("error") == Authentication required

# =============================================================================
# INVALID CREDENTIALS: Email format
# =============================================================================

### Basic Auth requires correct credentials (email format)
# @tag ci, r03, vulnerable
GET /account/info
Authorization: Basic {{user("plankton").email}}:wrongpassword

?? js $(response).isError() == true
?? js $(response).field("error") == Authentication required

### Basic Auth rejects empty password (email format)
# @tag ci, r03, vulnerable
GET /account/info
Authorization: Basic {{user("plankton").email}}:

?? js $(response).isError() == true
?? js $(response).field("error") == Authentication required

# =============================================================================
# AUTH PRIORITY: Cookie takes precedence
# =============================================================================

### Cookie Auth takes precedence over invalid Basic Auth
# @tag ci, r03, vulnerable
GET /account/info
Cookie: {{auth.login("plankton")}}
Authorization: Basic squidward:wrongpassword

?? js $(response).isOk() == true
?? js $(response).hasFields("balance", "email") == true
?? js $(response).field("email") == {{user("plankton").email}}
?? js $(response).field("balance") == 200.00
?? js $(response).hasOnlyUserData("plankton") == true
