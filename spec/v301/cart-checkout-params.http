# @import ../common.http

# Cart checkout parameter injection resistance
# Verifies cart_id from path cannot be overridden via query or body params
# Verifies restaurant_id cannot be changed at checkout time

# =============================================================================
# SETUP: Two users with their own carts
# =============================================================================

### Patrick creates a cart (target for injection)
# @name patricks_cart
{{
  await platform.seed({
    patrick: 200,
    plankton: 500
  });
}}
POST /cart?restaurant_id=1
Authorization: {{auth.basic("patrick")}}

@patricks_cart_id = {{$(response).field("cart_id")}}
?? js $(response).status() == 201

### Patrick adds item
# @name patricks_cart_with_item
# @forceRef patricks_cart
POST /cart/{{patricks_cart_id}}/items
Authorization: {{auth.basic("patrick")}}
Content-Type: application/json

{ "item_id": "4" }

?? js $(response).isOk() == true

### Plankton creates own cart
# @name planktons_cart
# @forceRef patricks_cart_with_item
POST /cart?restaurant_id=1
Authorization: {{auth.basic("plankton")}}

@planktons_cart_id = {{$(response).field("cart_id")}}
?? js $(response).status() == 201

### Plankton adds item to own cart
# @name planktons_cart_with_item
# @forceRef planktons_cart
POST /cart/{{planktons_cart_id}}/items
Authorization: {{auth.basic("plankton")}}
Content-Type: application/json

{ "item_id": "5" }

?? js $(response).isOk() == true

# =============================================================================
# CART ID INJECTION: Path says Patrick's cart, attacker injects own cart_id
# =============================================================================

### Injection via query param fails
# @forceRef planktons_cart_with_item
# @tag ci, r03, vulnerable
POST /cart/{{patricks_cart_id}}/checkout?cart_id={{planktons_cart_id}}
Authorization: {{auth.basic("plankton")}}
Content-Type: application/json

{ "delivery_address": "Chum Bucket", "tip": 0 }

?? js $(response).isError() == true

### Injection via body param fails
# @ref planktons_cart_with_item
# @tag ci, r03, vulnerable
POST /cart/{{patricks_cart_id}}/checkout
Authorization: {{auth.basic("plankton")}}
Content-Type: application/json

{ "delivery_address": "Chum Bucket", "tip": 0, "cart_id": "{{planktons_cart_id}}" }

?? js $(response).isError() == true

### Injection via query + body fails - Basic Auth
# @ref planktons_cart_with_item
# @tag ci, r03, vulnerable
POST /cart/{{patricks_cart_id}}/checkout?cart_id={{planktons_cart_id}}
Authorization: {{auth.basic("plankton")}}
Content-Type: application/json

{ "delivery_address": "Chum Bucket", "tip": 0, "cart_id": "{{planktons_cart_id}}" }

?? js $(response).isError() == true

### Injection via query + body fails - Cookie Auth
# @ref planktons_cart_with_item
# @tag ci, r03, vulnerable
POST /cart/{{patricks_cart_id}}/checkout?cart_id={{planktons_cart_id}}
Cookie: {{auth.login("plankton")}}
Content-Type: application/json

{ "delivery_address": "Chum Bucket", "tip": 0, "cart_id": "{{planktons_cart_id}}" }

?? js $(response).isError() == true

# =============================================================================
# RESTAURANT ID IMMUTABILITY: Checkout uses cart's restaurant_id
# =============================================================================

### Restaurant ID ignored via query - JSON
# @ref planktons_cart_with_item
# @tag ci, r03, vulnerable
POST /cart/{{planktons_cart_id}}/checkout?restaurant_id=2
Authorization: {{auth.basic("plankton")}}
Content-Type: application/json

{ "delivery_address": "Chum Bucket", "tip": 0 }

?? js $(response).isOk() == true
?? js $(response).field("restaurant_id") == 1

### Restaurant ID ignored via body - JSON
# @ref planktons_cart_with_item
# @tag ci, r03, vulnerable
POST /cart/{{planktons_cart_id}}/checkout
Authorization: {{auth.basic("plankton")}}
Content-Type: application/json

{ "delivery_address": "Chum Bucket", "tip": 0, "restaurant_id": 2 }

?? js $(response).isOk() == true
?? js $(response).field("restaurant_id") == 1

### Restaurant ID ignored via query + body - JSON
# @ref planktons_cart_with_item
# @tag ci, r03, vulnerable
POST /cart/{{planktons_cart_id}}/checkout?restaurant_id=2
Authorization: {{auth.basic("plankton")}}
Content-Type: application/json

{ "delivery_address": "Chum Bucket", "tip": 0, "restaurant_id": 2 }

?? js $(response).isOk() == true
?? js $(response).field("restaurant_id") == 1

### Restaurant ID ignored via query + body - Form
# @ref planktons_cart_with_item
# @tag ci, r03, vulnerable
POST /cart/{{planktons_cart_id}}/checkout?restaurant_id=2
Authorization: {{auth.basic("plankton")}}
Content-Type: application/x-www-form-urlencoded

tip=0&delivery_address=Chum Bucket&restaurant_id=2

?? js $(response).isOk() == true
?? js $(response).field("restaurant_id") == 1
