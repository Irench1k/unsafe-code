# @import ../_imports.http
# @import ../../refund/post/happy.http

# PATCH /orders/{id}/refund/status transitions & guardrails
# Approval workflow, immutability, and access control

# =============================================================================
# PENDING REFUND
# =============================================================================

### Customer's balance unchanged while refund pending
# @forceRef large_refund_pending
# @tag orders, r03, v301
GET /account/info
Authorization: {{auth.basic("plankton")}}

?? js $(response).field("balance") == {{200 - order_total}}

# =============================================================================
# APPROVED REFUND: Immutable
# =============================================================================

### Restaurant manager approves refund
# @name approved_refund
# @forceRef large_refund_pending
# @tag orders, r03, v301
PATCH /orders/{{order_id}}/refund/status
X-API-Key: {{auth.restaurant("krusty_krab")}}
Content-Type: application/x-www-form-urlencoded

status=approved

?? js $(response).isOk() == true
?? js $(response).field("status") == approved

### Customer's balance restored after approval
# @forceRef approved_refund
# @tag orders, r03, v301
GET /account/info
Authorization: {{auth.basic("plankton")}}

?? js $(response).field("balance") == 200.00

### Cannot approve already approved refund
# @ref approved_refund
# @tag orders, r03, v301
PATCH /orders/{{order_id}}/refund/status
X-API-Key: {{auth.restaurant("krusty_krab")}}
Content-Type: application/x-www-form-urlencoded

status=approved

?? js $(response).isError() == true

### Cannot reject already approved refund
# @ref approved_refund
# @tag orders, r03, v301
PATCH /orders/{{order_id}}/refund/status
X-API-Key: {{auth.restaurant("krusty_krab")}}
Content-Type: application/x-www-form-urlencoded

status=rejected

?? js $(response).isError() == true

### Cannot set approved refund back to pending
# @ref approved_refund
# @tag orders, r03, v301
PATCH /orders/{{order_id}}/refund/status
X-API-Key: {{auth.restaurant("krusty_krab")}}
Content-Type: application/x-www-form-urlencoded

status=pending

?? js $(response).isError() == true

# =============================================================================
# REJECTED REFUND: Immutable
# =============================================================================

### Refund can be set to rejected
# @name rejected_refund
# @forceRef large_refund_pending
# @tag orders, r03, v301
PATCH /orders/{{order_id}}/refund/status
X-API-Key: {{auth.restaurant("krusty_krab")}}
Content-Type: application/x-www-form-urlencoded

status=rejected

?? js $(response).isOk() == true
?? js $(response).field("status") == rejected

### Customer's balance unchanged after rejection
# @forceRef rejected_refund
# @tag orders, r03, v301
GET /account/info
Authorization: {{auth.basic("plankton")}}

?? js $(response).field("balance") == {{200 - order_total}}

### Cannot set rejected refund back to pending
# @ref rejected_refund
# @tag orders, r03, v301
PATCH /orders/{{order_id}}/refund/status
X-API-Key: {{auth.restaurant("krusty_krab")}}
Content-Type: application/x-www-form-urlencoded

status=pending

?? js $(response).isError() == true

### Cannot approve rejected refund
# @ref rejected_refund
# @tag orders, r03, v301
PATCH /orders/{{order_id}}/refund/status
X-API-Key: {{auth.restaurant("krusty_krab")}}
Content-Type: application/x-www-form-urlencoded

status=approved

?? js $(response).isError() == true
