# @import ../_imports.http
# @import ../../status/patch/happy.http
# @import ../../../cart/checkout/post/happy.http

# POST /orders/{id}/refund guardrails
# Authentication, state, and duplicate protections

# =============================================================================
# AUTHENTICATION: Refund requires auth
# =============================================================================

### Refund requires authentication
# @forceRef delivered_order
# @tag authn, orders, r03, v301
POST /orders/{{order_id}}/refund
Content-Type: application/x-www-form-urlencoded

amount=1.00

?? js $(response).isError() == true

# =============================================================================
# STATE REQUIREMENTS: Must be delivered first
# =============================================================================

### Refund requires order to be delivered
# @forceRef order_checkout_plankton
# @tag authn, orders, r03, v301
POST /orders/{{order_id}}/refund
Authorization: {{auth.basic("plankton")}}
Content-Type: application/x-www-form-urlencoded

amount=1.00

?? js $(response).isError() == true

# =============================================================================
# DELIVERED ORDER: Process refund flow
# =============================================================================

### Regular refund succeeds
# @name refunded
# @forceRef delivered_order
# @tag authn, orders, r03, v301
POST /orders/{{order_id}}/refund
Authorization: {{auth.basic("plankton")}}
Content-Type: application/x-www-form-urlencoded

amount=1.00

?? js $(response).isOk() == true

# =============================================================================
# DUPLICATE REFUND: Already refunded
# =============================================================================

### Cannot request refund for already refunded order
# @forceRef refunded
# @tag authn, orders, r03, v301
POST /orders/{{order_id}}/refund
Authorization: {{auth.basic("plankton")}}
Content-Type: application/x-www-form-urlencoded

amount=0.50

?? js $(response).isError() == true

# =============================================================================
# ACCESS CONTROL: Cross-user protection
# =============================================================================

### Cannot request refund for another user's order
# @forceRef delivered_order
# @tag authn, orders, r03, v301
POST /orders/{{order_id}}/refund
Authorization: {{auth.basic("spongebob")}}
Content-Type: application/x-www-form-urlencoded

amount=1.00

?? js $(response).isError() == true
