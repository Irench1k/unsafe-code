# @import ../_imports.http

# POST /auth/login session security tests
# Verifies that authentication headers/cookies cannot hijack the login session
#
# These tests verify the FIX for v205's session overwrite vulnerability.
# In v205, an attacker could hijack another user's session by:
# 1. Logging in legitimately (get a valid session cookie)
# 2. Sending another login request with victim's email (wrong password)
# 3. The server would overwrite session["email"] without re-authenticating
#
# v206 FIXES this by checking credentials BEFORE modifying session state.

# =============================================================================
# HEADER POLLUTION: Basic Auth does not bypass login
# =============================================================================

### Basic Auth header does not pollute login session
# @name header_pollution_test
# @tag auth, r02, v206
POST /auth/login
Authorization: {{auth.basic("plankton")}}
Content-Type: application/json

{
  "email": "{{user("spongebob").email}}",
  "password": "{{user("plankton").password}}"
}

# Should fail because password doesn't match SpongeBob's
# OR if it succeeds, the response should show Plankton (from Basic Auth), not SpongeBob
{{
  exports.pollutedCookie = hasCookie(response) ? extractCookie(response) : null;
}}
?? js $(response).field("email") != {{user("spongebob").email}}

### Verify: Polluted cookie (if any) still shows correct user
# @forceRef header_pollution_test
# @ucskip
# @tag auth, r02, v206
GET /account/info
Cookie: {{pollutedCookie || auth.login("plankton")}}

# If we got a cookie, it should belong to the user whose password we provided (Plankton)
?? js $(response).status() == 200
?? js $(response).field("email") == {{user("plankton").email}}

# =============================================================================
# SESSION FIXATION: Existing cookie does not bypass login credentials check
# =============================================================================

### Existing cookie does not bypass login authentication
# @name session_fixation_test
# @tag auth, r02, v206
POST /auth/login
Cookie: {{auth.login("plankton")}}
Content-Type: application/json

{
  "email": "{{user("spongebob").email}}",
  "password": "wrong_password_doesnt_matter"
}

# Should fail because SpongeBob's password is wrong
# The existing Plankton cookie should NOT allow hijacking to SpongeBob
{{
  exports.fixationCookie = hasCookie(response) ? extractCookie(response) : null;
}}
?? js $(response).field("email") != {{user("spongebob").email}}

### Verify: Original cookie not hijacked after failed fixation attempt
# @forceRef session_fixation_test
# @ucskip
# @tag auth, r02, v206
GET /account/info
Cookie: {{auth.login("plankton")}}

# Session should still be Plankton's, NOT SpongeBob's
?? js $(response).status() == 200
?? js $(response).field("email") == {{user("plankton").email}}
