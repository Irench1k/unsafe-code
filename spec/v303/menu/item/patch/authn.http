# @import ../_imports.http

# =============================================================================
# Authentication Tests: PATCH /menu/<item_id> requires restaurant API key
# =============================================================================
#
# ENDPOINT: PATCH /menu/<item_id>
# EXPECTED AUTH: Restaurant API key (X-API-Key header)
#
# This tests that the endpoint properly requires authentication.
# Customer auth (cookie/basic auth) should NOT be sufficient.
# =============================================================================

### Seed the database
# @name seed
{{
  await platform.seed();
}}
# @ucskip
# @tag authn, menu, r03, v303
GET /menu

@krabby_patty_id = {{$(response).find(i => i.name === "Krabby Patty").id}}

# =============================================================================
# TEST: No authentication → rejected
# =============================================================================

### Anonymous request should be rejected
# @name no_auth
# @forceRef seed
# @tag authn, menu, r03, v303
PATCH /menu/{{krabby_patty_id}}
Content-Type: application/json

{ "price": "1.00" }

?? js $(response).isError() == true

# =============================================================================
# TEST: Customer auth (cookie) → rejected
# =============================================================================

### Customer cookie auth is insufficient for menu management
# @name customer_cookie
# @forceRef seed
{{
  exports.cookie = await auth.login("spongebob");
}}
# @tag authn, menu, r03, v303
PATCH /menu/{{krabby_patty_id}}
Cookie: {{cookie}}
Content-Type: application/json

{ "price": "1.00" }

?? js $(response).isError() == true

# =============================================================================
# TEST: Customer auth (basic) → rejected
# =============================================================================

### Customer basic auth is insufficient for menu management
# @name customer_basic
# @forceRef seed
# @tag authn, menu, r03, v303
PATCH /menu/{{krabby_patty_id}}
Authorization: {{auth.basic("spongebob")}}
Content-Type: application/json

{ "price": "1.00" }

?? js $(response).isError() == true

# =============================================================================
# TEST: Restaurant API key → allowed (happy path)
# =============================================================================

### Restaurant API key authentication is required and sufficient
# @name restaurant_api_key
# @forceRef seed
# @tag authn, menu, r03, v303
PATCH /menu/{{krabby_patty_id}}
X-API-Key: {{auth.restaurant("krusty_krab")}}
Content-Type: application/json

{ "price": "9.99" }

?? js $(response).isOk() == true
