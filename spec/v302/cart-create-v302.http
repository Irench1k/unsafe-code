# @import ../common.http

# POST /cart - v302 changes
# Tests session-based cart storage with spam prevention

# =============================================================================
# SESSION CART STORAGE
# =============================================================================

### Create cart stores cart_id in session
# @name first_cart
{{
  await platform.seed({plankton: 200});
  exports.session = await auth.login("plankton");
}}
POST /cart?restaurant_id=1
Cookie: {{session}}

@session = {{extractCookie(response)}}
@cart_id = {{$(response).field("cart_id")}}
?? js $(response).status() == 201
?? js $(response).hasFields("cart_id", "restaurant_id") == true

# =============================================================================
# SPAM PREVENTION: Session carts are reused
# =============================================================================

### Creating another cart returns SAME cart (spam prevention)
# @name second_cart
# @forceRef first_cart
POST /cart?restaurant_id=1
Cookie: {{session}}

?? js $(response).status() == 200
?? js $(response).hasFields("cart_id") == true
?? js $(response).field("cart_id") == {{cart_id}}

# =============================================================================
# BYPASS: Basic Auth creates new cart
# =============================================================================

### Basic Auth bypasses session cart (creates new)
# @forceRef second_cart
# @tag ci, r03, vulnerable
POST /cart?restaurant_id=1
Authorization: {{auth.basic("plankton")}}

?? js $(response).status() == 201
?? js $(response).hasFields("cart_id", "restaurant_id") == true
?? js $(response).field("cart_id") != {{cart_id}}

# =============================================================================
# USER ISOLATION: Different users get different carts
# =============================================================================

### Different user gets their own cart
# @ref second_cart
# @tag ci, r03, vulnerable
POST /cart?restaurant_id=1
Cookie: {{auth.login("squidward")}}

?? js $(response).status() == 201
?? js $(response).hasFields("cart_id", "restaurant_id") == true
?? js $(response).field("cart_id") != {{cart_id}}
