# @import ../common.http

# PATCH /orders/{id}/refund/status - v302 FIX
# Tests that restaurant ownership is now properly checked (dual-auth exploit fixed)

# =============================================================================
# SETUP: Create order at Krusty Krab
# =============================================================================

### Plankton logs in and creates cart at Krusty Krab
# @name cart
{{
  await platform.seed({plankton: 200});
  exports.session = await auth.login("plankton");
}}
POST /cart?restaurant_id=1
Cookie: {{session}}

@cart_id = {{$(response).field("cart_id")}}
?? js $(response).status() == 201

### Add Krabby Patty to cart
# @name add_item
# @forceRef cart
POST /cart/{{cart_id}}/items
Cookie: {{session}}
Content-Type: application/json

{ "item_id": "4" }

?? js $(response).isOk() == true

### Checkout the order
# @name checkout
# @forceRef add_item
POST /cart/{{cart_id}}/checkout
Cookie: {{session}}
Content-Type: application/json

{ "tip": 1, "delivery_address": "Chum Bucket" }

@order_id = {{$(response).field("order_id")}}
@order_total = {{$(response).total()}}
?? js $(response).status() == 201

### Verify balance decreased after order
# @forceRef checkout
# @tag ci, r03, vulnerable
GET /account/credits
Cookie: {{session}}

@balance_after = {{$(response).balance()}}
?? js $(response).balance() == {{200 - order_total}}

# =============================================================================
# DELIVER ORDER
# =============================================================================

### Restaurant delivers the order
# @name deliver_order
# @forceRef checkout
PATCH /orders/{{order_id}}/status
X-API-Key: {{auth.restaurant("krusty_krab")}}
Content-Type: application/x-www-form-urlencoded

status=delivered

?? js $(response).isOk() == true

# =============================================================================
# REQUEST REFUND
# =============================================================================

### Request large refund (requires manual approval)
# @name refund_request
# @forceRef deliver_order
POST /orders/{{order_id}}/refund
Cookie: {{session}}
Content-Type: application/x-www-form-urlencoded

amount={{order_total}}&reason=Bad service

?? js $(response).isOk() == true
?? js $(response).field("status") == pending

# =============================================================================
# v302 FIX: Dual-auth exploit blocked
# =============================================================================

### (FIXED) Plankton cannot approve with Chum Bucket API key
# @name approve_refund
# @forceRef refund_request
PATCH /orders/{{order_id}}/refund/status
Cookie: {{session}}
X-API-Key: {{auth.restaurant("chum_bucket")}}
Content-Type: application/x-www-form-urlencoded

status=approved

?? js $(response).isError() == true

### (FIXED) Plankton's balance unchanged (exploit blocked)
# @forceRef approve_refund
# @tag ci, r03, vulnerable
GET /account/credits
Cookie: {{session}}

?? js $(response).balance() == {{200 - order_total}}
