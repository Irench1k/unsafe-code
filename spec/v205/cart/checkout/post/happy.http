# @import ../_imports.http
# @import ../../items/post/happy.http

# POST /cart/{id}/checkout happy path
# Checkout flow with different auth methods
#
# Exports (for @forceRef by other tests):
#   new_order - Completed order (canonical fixture for orders tests)

### Checkout - Basic Auth + JSON
# @name new_order
# @forceRef cart_with_item
{{
  await platform.seedCredits("patrick", 200);
}}
# @tag cart, happy, r02, v205
POST /cart/{{cart_id}}/checkout
Authorization: {{auth.basic("patrick")}}
Content-Type: application/json

{ "delivery_address": "124 Conch Street, Bikini Bottom", "tip": 1 }

@order_id = {{$(response).field("order_id")}}
?? js $(response).status() == 201
?? js $(response).hasFields("order_id", "total", "items") == true

### Multi-item checkout - Cookie Auth + JSON
# Add second item first, then checkout
# @forceRef cart_with_item
{{
  await platform.seedCredits("patrick", 200);
  // Add second item to the cart
  const resp = await fetch(url("/cart/" + cart_id + "/items"), {
    method: "POST",
    headers: {
      "Authorization": auth.basic("patrick"),
      "Content-Type": "application/json"
    },
    body: JSON.stringify({ item_id: menu.item("Fries").id })
  });
}}
# @tag cart, happy, r02, v205
POST /cart/{{cart_id}}/checkout
Cookie: {{auth.login("patrick")}}
Content-Type: application/json

{ "delivery_address": "Under the Rock", "tip": 2 }

?? js $(response).status() == 201
?? js $(response).hasFields("order_id", "total", "items") == true
?? js $(response).field("items").length == 2
