# @import ../_imports.http

# POST /cart/{id}/items coupon application (v401)
#
# When a user has a coupon in their session (via shareable link),
# the coupon is applied when they add a SECOND item to the cart.
# This is because @handle_shareable_coupons decorator runs BEFORE
# the item is added - so it checks existing cart items, not the new one.
#
# Flow:
# 1. Login -> get session cookie
# 2. Click shareable link -> coupon stored in session
# 3. Create cart -> cart exists but coupon not applied yet
# 4. Add first matching item -> coupon NOT applied yet (cart empty at check time)
# 5. Add second item -> coupon applied to first item (now in cart)

### Setup - seed balances
# @name setup_coupon
{{
  await platform.seed({ plankton: 200 });
}}
# @ucskip
# @tag cart, r04, v401
GET /menu

### Step 1: Login
# @name login_coupon
# @forceRef setup_coupon
# @ucskip
# @tag cart, r04, v401
POST /auth/login
Content-Type: application/json

{"email": "{{user("plankton").email}}", "password": "{{user("plankton").password}}"}

@session = {{extractCookie(response)}}
?? js $(response).isOk() == true

### Step 2: Click shareable coupon link - coupon stored in cookie
# @name click_coupon_link
# @forceRef login_coupon
# @no-redirect
# @ucskip
# @tag cart, r04, v401
GET /cart/apply-coupons?code=BURGER-50
Cookie: {{session}}

# Response is redirect with Set-Cookie containing coupon_code
# CRITICAL: Capture the updated cookie with coupon
@session_with_coupon = {{extractCookie(response)}}
?? js $(response).status() == 302
?? js hasCookie(response) == true

### Step 3: Create cart - coupon not applied yet (no items)
# @name create_cart_coupon
# @forceRef click_coupon_link
# @tag cart, r04, v401
POST /cart?restaurant_id=1
Cookie: {{session_with_coupon}}

@cart_id = {{$(response).field("cart_id")}}
?? js $(response).status() == 201
?? js $(response).field("items").length == 0

### Step 4: Add Krabby Patty - NOT discounted yet!
# @name add_patty_coupon
# @forceRef create_cart_coupon
# @tag cart, r04, v401
POST /cart/{{cart_id}}/items
Cookie: {{session_with_coupon}}
Content-Type: application/json

{"item_id": "{{menu.item("Krabby Patty").id}}"}

# Coupon check runs BEFORE item is added, so no discount yet
# Item is at full price $3.99, coupon_id is null
?? js $(response).isOk() == true
?? js $(response).field("items")[0].name == Krabby Patty
?? js $(response).field("items")[0].price == 3.99
?? js $(response).field("items")[0].coupon_id == null

### Step 5: Add Fries - THIS triggers coupon on Krabby Patty!
# @forceRef add_patty_coupon
# @tag cart, r04, v401
POST /cart/{{cart_id}}/items
Cookie: {{session_with_coupon}}
Content-Type: application/json

{"item_id": "{{menu.item("Fries").id}}"}

?? js $(response).isOk() == true
?? js $(response).field("items").length == 2

# NOW Krabby Patty is discounted (coupon applied when Fries was added)
?? js $(response).field("items").find(i => i.name == "Krabby Patty").price == 1.99
?? js $(response).field("items").find(i => i.name == "Krabby Patty").coupon_id != null

# Fries at full price (coupon only applies to matching item)
?? js $(response).field("items").find(i => i.name == "Fries").price == 2.49
?? js $(response).field("items").find(i => i.name == "Fries").coupon_id == null
