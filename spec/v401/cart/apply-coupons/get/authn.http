# @import ../_imports.http

# GET /cart/apply-coupons authentication behavior (v401)
#
# This endpoint is a "shareable link" that works for both authenticated and
# unauthenticated users. It stores the coupon code in the session cookie
# and redirects to an appropriate page.
#
# Authentication behavior:
# - Unauthenticated: stores coupon, redirects to /register
# - Authenticated without cart: stores coupon, redirects to /menu
# - Authenticated with cart: applies coupon directly, redirects to checkout

### Setup
# @name setup
{{
  await platform.seed({ plankton: 200 });
}}
# @ucskip
# @tag authn, cart, r04, v401
GET /menu

# =============================================================================
# TEST: Anonymous user can click link (stores coupon in cookie)
# =============================================================================

### Anonymous user clicks shareable link - redirected to register
# @name anon_click
# @forceRef setup
# @no-redirect
# @tag authn, cart, r04, v401
GET /cart/apply-coupons?code=BURGER-50

# Unauthenticated users get redirected to registration page
# The coupon code is stored in the session cookie for later use
?? js $(response).status() == 302
?? js hasCookie(response) == true

# =============================================================================
# TEST: Authenticated user can click link (stores coupon in cookie)
# =============================================================================

### Login first
# @name login
# @forceRef setup
# @ucskip
# @tag authn, cart, r04, v401
POST /auth/login
Content-Type: application/json

{"email": "{{user("plankton").email}}", "password": "{{user("plankton").password}}"}

@session = {{extractCookie(response)}}
?? js $(response).isOk() == true

### Authenticated user clicks shareable link - redirected to menu
# @name auth_click
# @forceRef login
# @no-redirect
# @tag authn, cart, r04, v401
GET /cart/apply-coupons?code=BURGER-50
Cookie: {{session}}

# Authenticated users without a cart are redirected to menu page
# The coupon code is stored in the session cookie
?? js $(response).status() == 302
?? js hasCookie(response) == true
