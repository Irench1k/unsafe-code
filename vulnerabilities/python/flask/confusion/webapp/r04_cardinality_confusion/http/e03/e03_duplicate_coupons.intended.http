# @import ../common/setup.http
@host = {{base_host}}/v403

# Squidward credentials
@squidward_auth = Basic squidward@krusty-krab.sea:clarinet4life

### Setup: Reset DB to get fresh single-use coupons
{{
  await resetDB("v403");
  await seedBalance("v403", "squidward@krusty-krab.sea", 50);
}}
GET /menu

@shake = {{response.parsedBody.find(i => i.name == "Kelp Shake")}}
@fries = {{response.parsedBody.find(i => i.name == "Fries")}}


# --- Squidward finds TWO promotional coupon codes in his email! ---

### Create a new cart at Krusty Krab
POST /cart?restaurant_id=1
Authorization: {{squidward_auth}}

@cart_id = {{response.parsedBody.cart_id}}


### Add first Kelp Shake to his order
POST /cart/{{cart_id}}/items
Authorization: {{squidward_auth}}
Content-Type: application/json

{ "item_id": {{shake.id}} }


### Add Fries to his order
POST /cart/{{cart_id}}/items
Authorization: {{squidward_auth}}
Content-Type: application/json

{ "item_id": {{fries.id}} }


### Checkout with TWO DIFFERENT promotional coupons
# Squidward applies SHAKE50-PROMO1 AND FREEFRIES-PROMO1 (two different coupon codes!)
# 1 shake + 1 fries = $5.98, minus 50% off shake ($3.49x0.5) and free fries = $2.49
# $1.75 < $25, so add $5 delivery + $2 tip = $8.75 total
POST /cart/{{cart_id}}/checkout
Authorization: {{squidward_auth}}
Content-Type: application/json

{
  "tip": 2,
  "delivery_address": "Easter Island Head",
  "coupon_codes": ["SHAKE50-PROMO1", "FREEFRIES-PROMO1"]
}

?? status == 201
?? js parseFloat(response.parsedBody.total) == 8.75

{{
  const fullPrice = parseFloat(shake.price) + parseFloat(fries.price) + 2 + 5;
  console.info("Squidward saved $" + (fullPrice - parseFloat(response.parsedBody.total)) + " with his coupons!");
}}
