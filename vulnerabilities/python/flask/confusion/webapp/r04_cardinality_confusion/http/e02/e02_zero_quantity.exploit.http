# @import ../common/setup.http
@host = {{base_host}}/v402

### Setup
# @name seed
{{
  await seedBalance("v402", "plankton@chum-bucket.sea", 100);
}}
GET /menu

@krabby_patty = {{response.parsedBody.find(i => i.name == "Krabby Patty")}}
@fries = {{response.parsedBody.find(i => i.name == "Fries")}}


# ===== Cookie Based Testing =====

### Plankton (existing user) is logged in, but does not have a cart yet.
# @name login
# @ref seed
POST /auth/login
Content-Type: application/json

{
    "email": "plankton@chum-bucket.sea",
    "password": "i_love_my_wife"
}

@session = {{refreshCookie(response)}}


### Plankton clicks the coupon link, and is redirected to the menu page
# @name promo_link_clicked
# @ref login
# @no-redirect
GET /cart/apply-coupons?code=BURGER-50
Cookie: {{session}}

@session = {{refreshCookie(response, session)}}

// Cookie contains coupon code BURGER-50, to be applied to the future cart!


### Create new cart at Krusty Krab
# @name new_cart
# @ref promo_link_clicked
POST /cart?restaurant_id=1
Cookie: {{session}}

@session = {{refreshCookie(response, session)}}
@cart_id = {{response.parsedBody.cart_id}}

// Cart ID is added to the cookie


### Add Krabby Patty to the cart
# @name cart_with_krabby_patty
# @ref new_cart
POST /cart/{{cart_id}}/items
Content-Type: application/json
Cookie: {{session}}

{ "item_id": {{krabby_patty.id}} }

@session = {{refreshCookie(response, session)}}

// Coupon is NOT applied yet, and remains in the cookie

?? js response.parsedBody.items[0].price == 3.99


### Add Fries to the cart, and notice coupon applied to the Krabby Patty!
# @name cart_with_patty_and_fries
# @ref cart_with_krabby_patty
POST /cart/{{cart_id}}/items
Content-Type: application/json
Cookie: {{session}}

{ "item_id": {{fries.id}} }

// The server is sending updated cookie with coupon removed, but we ignore this
// set-cookie update and continue using the original cookie, to get more coupons applied!
//@session = {{refreshCookie(response, session)}}

?? js response.parsedBody.items.find(i => i.item_id == krabby_patty.id).price == 1.99


### Apply coupon repeatedly, notice the price of the Krabby Patty is reduced by 50% each time!
# @name more_coupons
# @ref cart_with_patty_and_fries
POST /cart/{{cart_id}}/items
Content-Type: application/json
Cookie: {{session}}

{ }

?? js response.parsedBody.items.find(i => i.item_id == krabby_patty.id).price == 0.99

### Again, and again - each request with the old cookie slashes the price by half!
# @name even_more_coupons
# @ref more_coupons
POST /cart/{{cart_id}}/items
Content-Type: application/json
Cookie: {{session}}

{ }

@session = {{refreshCookie(response, session)}}
?? js response.parsedBody.items.find(i => i.item_id == krabby_patty.id).price == 0.49

### Checkout the cart - only paying $0.49 for the Krabby Patty!
# @name checkout_cart
# @ref even_more_coupons
POST /cart/{{cart_id}}/checkout
Cookie: {{session}}
Content-Type: application/json

{
  "tip": "0",
  "delivery_address": "Chum Bucket"
}

@session = {{refreshCookie(response, session)}}
?? js response.parsedBody.items.find(i => i.item_id == krabby_patty.id).price == 0.49
