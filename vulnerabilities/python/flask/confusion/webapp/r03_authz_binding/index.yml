version: '1'
root: .
category: ii.r03-authz-binding
namespace: flask-ii-r03-authz-binding
examples:
  1:
    id: 1
    kind: block
    title: Secure Authorization Binding Baseline [Not Vulnerable]
    notes: >-
      This demonstrates the correct way to handle authorization binding in a multi-user application.
      Authentication establishes WHO the user is, and authorization checks verify that the
      authenticated identity has access to the requested resource.


      Key security properties:

      - Authentication via Basic Auth establishes `g.user` (WHO)

      - Authorization checks use the SAME source for the resource identifier (group parameter)

      - The data retrieval also uses the SAME source for the resource identifier

      - No user-controlled parameters can rebind the resource after authorization


      This example provides two endpoints:

      1. `/groups/<group>/messages` - Returns messages from a specific group (path parameter)

      2. `/user/messages` - Returns user's private messages, or group messages if `group`
      query param provided


      In both cases, the authorization check and the data access use the same source, preventing
      any binding drift attacks.
    http: null
    language: python
    parts:
    - part: 1
      file: e01_baseline/routes.py
      code_start_line: 28
      code_end_line: 58
    file_hashes:
      e01_baseline/routes.py: fc04772439cbb19dfd24c894f725815464b82c1f74ae2464f39620a3e8c99f15
    fingerprint: 5c5e169b40086e05953e84f3865ea4833ad38064fc36c77840e9db5d0bc9746a
  2:
    id: 2
    kind: block
    title: Authorization Binding Drift via Path-Query Confusion
    notes: >-
      This example demonstrates authorization binding drift caused by a decorator that merges
      path and query parameters with query-priority.


      THE VULNERABILITY: Authorization binding drift, NOT source precedence.

      - Authentication establishes WHO: Plankton (verified identity)

      - Authorization checks WHICH resource: staff@chum-bucket.sea (from query param)

      - Action accesses DIFFERENT resource: staff@krusty-krab.sea (from path param)


      The key insight: We know WHO Plankton is (authentication succeeded), but we allow him
      to control WHICH resource the authorization checks versus WHICH resource gets accessed.


      Attack flow:

      1. Plankton authenticates as himself (WHO = plankton@chum-bucket.sea) ✓

      2. Authorization decorator checks access to staff@chum-bucket.sea (query param) ✓

      3. Handler retrieves messages from staff@krusty-krab.sea (path param) ✗


      This is binding drift because the authenticated identity is correct, but the resource
      identifier gets rebound between authorization and action.
    http: null
    language: python
    parts:
    - part: 1
      file: e02_path_query_confusion/routes.py
      code_start_line: 35
      code_end_line: 50
    file_hashes:
      e02_path_query_confusion/routes.py: d895161f324e649c4e9aecb08607e32199cb4b160ca67bc79449cb9e1f1d48b2
    fingerprint: f2003d4f81ac47163e7f327d3dc1e1c5535ae6226aab8be0dff2f9358c61f18e
  3:
    id: 3
    kind: block
    title: Authorization Binding Drift Despite Global Source of Truth
    notes: >-
      This example attempts to fix the binding drift by introducing a single source of truth
      (g.group), but the vulnerability persists because handlers still use path parameters
      directly.


      THE VULNERABILITY: Authorization binding drift via inconsistent source usage.

      - Authentication establishes WHO: Plankton (stored in g.user) ✓

      - Decorator sets g.group using query-priority merging ✓

      - Authorization checks WHICH resource: g.group (staff@chum-bucket.sea from query) ✓

      - Action accesses DIFFERENT resource: group parameter (staff@krusty-krab.sea from path)
      ✗


      This demonstrates that even "single source of truth" patterns can fail if:

      1. The source is populated with user-controlled priority logic

      2. Some code paths ignore the source and use raw request data


      Attack flow (same as Example 2):

      1. Plankton authenticates as himself ✓

      2. Decorator sets g.group = "staff@chum-bucket.sea" (query param) ✓

      3. Authorization checks membership in g.group ✓

      4. Handler uses path param "staff@krusty-krab.sea" instead of g.group ✗


      The fix would be to either: a) Always use g.group in handlers (never path params directly),
      OR b) Don't set g.group with merging logic - use path param directly everywhere
    http: null
    language: python
    parts:
    - part: 1
      file: e02_path_query_confusion/routes.py
      code_start_line: 82
      code_end_line: 97
    file_hashes:
      e02_path_query_confusion/routes.py: d895161f324e649c4e9aecb08607e32199cb4b160ca67bc79449cb9e1f1d48b2
    fingerprint: 987a40e15b53f408439b1c8872756253036dfeee97033911e03d2b45a7cccce1
  4:
    id: 4
    kind: block
    title: Classic Authorization Binding Drift - User Identity Rebinding
    notes: >-
      This demonstrates the most straightforward form of authorization binding drift: the
      application authenticates WHO the user is, verifies they have access to a resource,
      but then trusts a user-controlled parameter to determine which identity to ACT AS.


      THE VULNERABILITY: Identity rebinding after successful authorization.

      - Authentication establishes WHO: Squidward (verified via Basic Auth) ✓

      - Authorization checks WHICH resource: staff@krusty-krab.sea (verified member) ✓

      - Action uses DIFFERENT identity: spongebob@krusty-krab.sea (from request body) ✗


      This is the purest form of authorization binding drift: we authenticate the user correctly,
      we authorize them for the correct resource, but then we let them rebind their identity
      when performing the action.


      Key insight: This is NOT about confused parameters or different sources. It's about
      trusting user input for identity AFTER authentication succeeded.


      Attack scenario:

      1. Mr. Krabs announces Employee of the Month voting in the staff group

      2. Squidward (who desperately wants the recognition) authenticates as himself

      3. He's authorized to post to staff@krusty-krab.sea (he's a member)

      4. But the API trusts the "from_user" parameter from the request body

      5. Squidward posts a vote for himself while claiming it's from SpongeBob


      Impact: Squidward can impersonate SpongeBob and manipulate the vote!
    http: null
    language: python
    parts:
    - part: 1
      file: e03_simple_rebinding/routes.py
      code_start_line: 39
      code_end_line: 76
    file_hashes:
      e03_simple_rebinding/routes.py: 73a675e0a9b855a0e7228611d4538c0c6a14223751a5a9dda5c72230e6ac8e2d
    fingerprint: f84a6d5f04d03e09ca68e4252afdf0fad65b94c53fd5bfe9519720373d41be68
  13:
    id: 13
    kind: block
    title: null
    notes: null
    http: null
    language: python
    parts:
    - part: 2
      file: e01_baseline/decorator.py
      code_start_line: 20
      code_end_line: 36
    file_hashes:
      e01_baseline/decorator.py: 98c5ae44a827092c44cafac85c292e7e8987c75107be513318db33ac74221185
    fingerprint: 9e42a6dbfd745953b427f2c84810c962fdd693e24f1ff557e9fbb8f163ed4b50
  14:
    id: 14
    kind: block
    title: null
    notes: null
    http: null
    language: python
    parts:
    - part: 2
      file: e02_path_query_confusion/decorator.py
      code_start_line: 21
      code_end_line: 50
    file_hashes:
      e02_path_query_confusion/decorator.py: cba6f891e7df11e98d2e9a434c625757d9bf4a33eb080d3d7af656b4dfdb5b80
    fingerprint: 0675da6d4209ba980387172cf3e185e88e250b03616c5f94538a81df0dd0eea6
  15:
    id: 15
    kind: block
    title: null
    notes: null
    http: null
    language: python
    parts:
    - part: 2
      file: e02_path_query_confusion/decorator.py
      code_start_line: 59
      code_end_line: 92
    file_hashes:
      e02_path_query_confusion/decorator.py: cba6f891e7df11e98d2e9a434c625757d9bf4a33eb080d3d7af656b4dfdb5b80
    fingerprint: 6adf80555c57870225e606a30831381bca08debd22472b9c30dec05841f2d6c5
attachments:
  http/exploit-1.http: 499a2390053183f5ba9ee9c551af9f19efaa8fab8aac5f18159403a297c9efc1
  http/exploit-2.http: 9316699c101e94b322480c5bf1e35ada343c3260b8c4ecd6aca00a7d40e7fab2
  http/exploit-3.http: df3bb095cf96ff74b343ce71554cd5834d20bd04c6a63431ba216f9a1f080666
  http/exploit-4.http: c795cfe84b25ee8e9aff44b69124a454bb198c7307e8ce28aa51a7a40a232a0e
build_signature: e3e3f6a956a45b74ac28ef1296526406ed8a2779695e05c718b46af9c791fd6c
last_readme_fingerprint: da72d2b3b97a7b56db5b9b8b5a7dba01a301bff6f65fe18646420ed396958e68
