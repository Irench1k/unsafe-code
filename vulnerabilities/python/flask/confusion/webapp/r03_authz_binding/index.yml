version: '1'
root: .
category: ii.r03-authz-binding
namespace: flask-ii-r03-authz-binding
examples:
  1:
    id: 1
    kind: block
    title: Secure Authorization Binding Baseline [Not Vulnerable]
    notes: >-
      This demonstrates the correct way to handle authorization binding in a multi-user application.
      Authentication establishes WHO the user is, and authorization checks verify that the
      authenticated identity has access to the requested resource.


      Key security properties:

      - Authentication via Basic Auth establishes `g.user` (WHO)

      - Authorization checks use the SAME source for the resource identifier (group parameter)

      - The data retrieval also uses the SAME source for the resource identifier

      - No user-controlled parameters can rebind the resource after authorization


      This example provides two endpoints:

      1. `/groups/<group>/messages` - Returns messages from a specific group (path parameter)

      2. `/user/messages` - Returns user's private messages, or group messages if `group`
      query param provided


      In both cases, the authorization check and the data access use the same source, preventing
      any binding drift attacks.
    http: null
    language: python
    parts:
    - part: 1
      file: e01_baseline/routes.py
      code_start_line: 28
      code_end_line: 58
    file_hashes:
      e01_baseline/routes.py: 5f671caa90a924061941f71f9e508519ff84e306865fb6ddefb99f85a26c2207
    fingerprint: 5c53c7215d6cd1e8afec9cf2f91620ee105a4e033b52f8afa563627e7149f40b
  2:
    id: 2
    kind: block
    title: Authorization Binding Drift via Path-Query Confusion
    notes: >-
      This example demonstrates authorization binding drift caused by a decorator that merges
      path and query parameters with query-priority.


      THE VULNERABILITY: Authorization binding drift, NOT source precedence.

      - Authentication establishes WHO: Plankton (verified identity)

      - Authorization checks WHICH resource: staff@chum-bucket.sea (from query param)

      - Action accesses DIFFERENT resource: staff@krusty-krab.sea (from path param)


      The key insight: We know WHO Plankton is (authentication succeeded), but we allow him
      to control WHICH resource the authorization checks versus WHICH resource gets accessed.


      Attack flow:

      1. Plankton authenticates as himself (WHO = plankton@chum-bucket.sea) ✓

      2. Authorization decorator checks access to staff@chum-bucket.sea (query param) ✓

      3. Handler retrieves messages from staff@krusty-krab.sea (path param) ✗


      This is binding drift because the authenticated identity is correct, but the resource
      identifier gets rebound between authorization and action.
    http: null
    language: python
    parts:
    - part: 1
      file: e02_path_query_confusion/routes.py
      code_start_line: 35
      code_end_line: 50
    file_hashes:
      e02_path_query_confusion/routes.py: 340e8de944fa34db6fe8ff8e79d0bab99654e8a7bddec5ab7dbb1cb0fdf530af
    fingerprint: 196a9acfcfe429a21484374f90d95d3b996a3df5b56cd4e6bceb0b2d768ff43f
  3:
    id: 3
    kind: block
    title: Authorization Binding Drift Despite Global Source of Truth
    notes: >-
      This example attempts to fix the binding drift by introducing a single source of truth
      (g.group), but the vulnerability persists because handlers still use path parameters
      directly.


      THE VULNERABILITY: Authorization binding drift via inconsistent source usage.

      - Authentication establishes WHO: Plankton (stored in g.user) ✓

      - Decorator sets g.group using query-priority merging ✓

      - Authorization checks WHICH resource: g.group (staff@chum-bucket.sea from query) ✓

      - Action accesses DIFFERENT resource: group parameter (staff@krusty-krab.sea from path)
      ✗


      This demonstrates that even "single source of truth" patterns can fail if:

      1. The source is populated with user-controlled priority logic

      2. Some code paths ignore the source and use raw request data


      Attack flow (same as Example 2):

      1. Plankton authenticates as himself ✓

      2. Decorator sets g.group = "staff@chum-bucket.sea" (query param) ✓

      3. Authorization checks membership in g.group ✓

      4. Handler uses path param "staff@krusty-krab.sea" instead of g.group ✗


      The fix would be to either: a) Always use g.group in handlers (never path params directly),
      OR b) Don't set g.group with merging logic - use path param directly everywhere
    http: null
    language: python
    parts:
    - part: 1
      file: e02_path_query_confusion/routes.py
      code_start_line: 82
      code_end_line: 97
    file_hashes:
      e02_path_query_confusion/routes.py: 340e8de944fa34db6fe8ff8e79d0bab99654e8a7bddec5ab7dbb1cb0fdf530af
    fingerprint: c8923084b869726579dca2e85259006fd1d1a58d13c3b2b38ae70921b5cc5e6e
  4:
    id: 4
    kind: block
    title: Classic Authorization Binding Drift - User Identity Rebinding
    notes: >-
      This demonstrates the most straightforward form of authorization binding drift: the
      application authenticates WHO the user is, verifies they have access to a resource,
      but then trusts a user-controlled parameter to determine which identity to ACT AS.


      THE VULNERABILITY: Identity rebinding after successful authorization.

      - Authentication establishes WHO: Squidward (verified via Basic Auth) ✓

      - Authorization checks WHICH resource: staff@krusty-krab.sea (verified member) ✓

      - Action uses DIFFERENT identity: spongebob@krusty-krab.sea (from request body) ✗


      This is the purest form of authorization binding drift: we authenticate the user correctly,
      we authorize them for the correct resource, but then we let them rebind their identity
      when performing the action.


      Key insight: This is NOT about confused parameters or different sources. It's about
      trusting user input for identity AFTER authentication succeeded.


      Attack scenario:

      1. Mr. Krabs announces Employee of the Month voting in the staff group

      2. Squidward (who desperately wants the recognition) authenticates as himself

      3. He's authorized to post to staff@krusty-krab.sea (he's a member)

      4. But the API trusts the "from_user" parameter from the request body

      5. Squidward posts a vote for himself while claiming it's from SpongeBob


      Impact: Squidward can impersonate SpongeBob and manipulate the vote!
    http: null
    language: python
    parts:
    - part: 1
      file: e03_simple_rebinding/routes.py
      code_start_line: 39
      code_end_line: 76
    file_hashes:
      e03_simple_rebinding/routes.py: 9717ac94f8b5082bc0654fbba25c79420b6edd295ec1ea29608023adba8bff84
    fingerprint: 0da3c12f4f9868f914db00fd09872ec897a04fe0c19469d268e8878f4d6e6902
  13:
    id: 13
    kind: block
    title: null
    notes: null
    http: null
    language: python
    parts:
    - part: 2
      file: e01_baseline/decorator.py
      code_start_line: 20
      code_end_line: 36
    file_hashes:
      e01_baseline/decorator.py: 8b681ce69fafe2466d6980fd3567d52452842e936238402fae306655d919583d
    fingerprint: 0d2dc73df2479b718730e57fa2d079096c6f374dd15ebb93b23670e6629fb00f
  14:
    id: 14
    kind: block
    title: null
    notes: null
    http: null
    language: python
    parts:
    - part: 2
      file: e02_path_query_confusion/decorator.py
      code_start_line: 21
      code_end_line: 50
    file_hashes:
      e02_path_query_confusion/decorator.py: 32a3e8ade10bcca35dfc72824a86a68329bdbb61891fd23ac26bf61fcf152214
    fingerprint: c7d5bacb6a22918b1d4ba26e0f8209388a804fc44ead3e891c493085b2eeca30
  15:
    id: 15
    kind: block
    title: null
    notes: null
    http: null
    language: python
    parts:
    - part: 2
      file: e02_path_query_confusion/decorator.py
      code_start_line: 59
      code_end_line: 92
    file_hashes:
      e02_path_query_confusion/decorator.py: 32a3e8ade10bcca35dfc72824a86a68329bdbb61891fd23ac26bf61fcf152214
    fingerprint: 1f913a207d57aae50e6a95dd83f80f0ab87004de4f62576e9dc9e2c8395d67e5
attachments:
  http/exploit-1.http: 77bc81050ebdbc3adfc49c0c3a5ca3ca7bfce0704e59188365721cd164a4166c
  http/exploit-2.http: 8a4f38f146750b0f86cf4506bcf8e404084d3ca6de90d7a2d9376e6e6373c1ad
  http/exploit-3.http: 2fcb8ab484c3d6d390a8d245105961d71ba4fc88f14c1218e44461fad8ce12eb
  http/exploit-4.http: 3714f6759a61e296218d5ab3545a140d25eca48f0dacd2d777428d12a74fb832
build_signature: e3c2f20c3debfe710047a1315b35480b9a449d62d453bf77a6d2b222cc5eb299
last_readme_fingerprint: d0e5b6f73d67cb86357dd7b72bf819c09fa9961db1b460bcc6a8ada4cba99e19
