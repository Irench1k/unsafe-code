# @import ../common/setup.http
@host = {{base_host}}/v308

# FIX for v307: The token's restaurant_id is now validated against the URL's restaurant_id.
# Plankton can no longer swap tokens between restaurants!

### Clear mailpit

{{
  await mailpit.clear();
}}

# --- Setup: Capture initial state ---

### Check current Krusty Krab state
GET /restaurants/1

?? status == 200

{{
  exports.originalDomain = response.parsedBody.domain;
  console.info("ü¶Ä Krusty Krab domain before attack attempt:", response.parsedBody.domain);
}}


# --- Plankton attempts the same exploit ---

### Step 1: Plankton requests a domain change for Krusty Krab (restaurant 1)
# First he's blocked - he's not the owner of restaurant 1!
PATCH /restaurants/1
Authorization: {{plankton_auth}}
Content-Type: application/json

{
  "name": "HACKED by Plankton!",
  "domain": "chum-bucket.sea"
}

?? status == 400
?? body error == Unauthorized

{{
  console.info("üõ°Ô∏è FIX #1: Ownership check now runs BEFORE token generation");
}}


# --- Plankton tries a different approach ---

### Step 2: Plankton legitimately requests a token for HIS restaurant
PATCH /restaurants/2
Authorization: {{plankton_auth}}
Content-Type: application/json

{
  "name": "Chum Bucket Deluxe",
  "domain": "chum-bucket.sea"
}

?? status == 200
?? body status == verification_email_sent

@token = {{(await mailpit.lastEmail("admin@chum-bucket.sea").userToken())}}

### Step 3: Plankton tries to use his Chum Bucket token on Krusty Krab
# The token contains restaurant_id: 2, but the URL is /restaurants/1
PATCH /restaurants/1
Authorization: {{plankton_auth}}
Content-Type: application/json

{
  "domain": "chum-bucket.sea",
  "token": "{{token}}"
}

?? status == 400
?? body error == Unauthorized

{{
  console.info("üõ°Ô∏è FIX #2: Token's restaurant_id must match URL - swap blocked!");
}}


# --- Verify Krusty Krab is safe ---

### Krusty Krab remains unchanged
GET /restaurants/1

?? status == 200

{{
  const domainUnchanged = response.parsedBody.domain === originalDomain;
  console.info("‚úÖ Krusty Krab domain still:", response.parsedBody.domain);
  console.info("   Domain unchanged:", domainUnchanged ? "YES - Mr. Krabs' restaurant is safe!" : "NO - SOMETHING WENT WRONG");
  if (!domainUnchanged) throw new Error("Domain was changed - this shouldn't happen in the fixed version!");
}}
