# @import ../common/setup.http
@host = {{base_host}}/v302

# v302 FIX: Refund approval now requires the restaurant's own API key
#
# The refund approval endpoint checks that the X-API-Key belongs to
# the restaurant that received the order, not just ANY restaurant.

### Plankton logs in and orders from Krusty Krab
POST /auth/login
Content-Type: application/json

{
    "email": "plankton@chum-bucket.sea",
    "password": "i_love_my_wife"
}

@session = {{refreshCookie(response)}}

### Plankton creates a cart at Krusty Krab
{{
  await seedBalance("v302", "plankton@chum-bucket.sea", 100);
}}
POST /cart?restaurant_id=1
Cookie: {{session}}

@cart_id = {{response.parsedBody.cart_id}}

### Plankton checks the menu
GET /menu?restaurant_id=1
Cookie: {{session}}

{{
  exports.krabby_patty = response.parsedBody.find(i => i.name === "Krabby Patty" && i.available);
}}


### Plankton adds a Krabby Patty to his cart
POST /cart/{{cart_id}}/items
Cookie: {{session}}
Content-Type: application/json

{ "item_id": "{{krabby_patty.id}}" }


### Plankton checks out and pays
POST /cart/{{cart_id}}/checkout
Cookie: {{session}}
Content-Type: application/x-www-form-urlencoded

tip=1&delivery_address=Chum Bucket

@order_id = {{response.parsedBody.order_id}}


### Krusty Krab processes and delivers the order
PATCH /orders/{{order_id}}/status
X-API-Key: {{krabs_api_key}}
Content-Type: application/x-www-form-urlencoded

status=delivered


### Plankton's balance is now lower
GET /account/credits
Cookie: {{session}}

@balance_before = {{response.parsedBody.balance}}


### Plankton requests a refund for his order
POST /orders/{{order_id}}/refund
Cookie: {{session}}
Content-Type: application/x-www-form-urlencoded

amount=2.50


### Plankton tries to approve his own refund using Chum Bucket API key
PATCH /orders/{{order_id}}/refund/status
Cookie: {{session}}
X-API-Key: {{chum_bucket_api_key}}
Content-Type: application/x-www-form-urlencoded

status=approved

# FIX WORKING: v302 rejects because Chum Bucket API key doesn't match Krusty Krab order
?? status >= 400


### Plankton did NOT receive his refund
GET /account/credits
Cookie: {{session}}

?? js parseFloat(response.parsedBody.balance) == {{balance_before}}
