version: '1'
root: .
category: confusion.parameter-source
namespace: flask-vuln-confusion-parameter-source
examples:
  0:
    id: 0
    kind: function
    title: Secure Implementation
    notes: >-
      Here you can see a secure implementation that consistently uses query string parameters
      for both authentication and data retrieval.
    http: open
    language: python
    parts:
    - part: 1
      file: routes.py
      code_start_line: 51
      code_end_line: 67
    file_hashes:
      routes.py: aca7420dd5ebb30826aa31ff431da7c9ba4dd2a43c3841d719d659f005b0d234
    fingerprint: 51df7f513aaa7e5931eb8357f99aaac183787b8ff850a9caa234ba4adb274e5d
  1:
    id: 1
    kind: function
    title: Basic Parameter Source Confusion
    notes: >-
      Demonstrates the most basic form of parameter source confusion where authentication
      uses **query** parameters but data retrieval uses **form** data.


      We take the user name from the query string during the validation, but during the data
      retrieval another value is used, taken from the request body (form). This does not look
      very realistic, but it demonstrates the core of the vulnerability, we will build upon
      this further.


      Here you can see if we provide bob's name in the request body, we can access his messages
      without his password.
    http: null
    language: python
    parts:
    - part: 1
      file: r01_simplified_patterns/routes.py
      code_start_line: 40
      code_end_line: 54
    file_hashes:
      r01_simplified_patterns/routes.py: 23b903051e442e42b651db63c35ac475fb501c0f630bdfb7a92fa9dec34ac1ad
    fingerprint: d05ffae5a9eccdbf63f0d2d9416e9769d5fe41b4c7436f4e9eb053994a5466d3
  2:
    id: 2
    kind: block
    title: Function-Level Parameter Source Confusion
    notes: >-
      Functionally equivalent to example 1, but shows how separating authentication and data
      retrieval into different functions can make the vulnerability harder to spot.
    http: open
    language: python
    parts:
    - part: 1
      file: r01_simplified_patterns/routes.py
      code_start_line: 64
      code_end_line: 88
    file_hashes:
      r01_simplified_patterns/routes.py: 23b903051e442e42b651db63c35ac475fb501c0f630bdfb7a92fa9dec34ac1ad
    fingerprint: a9d72d50b633a45873e707cc16f08300dd8aace400134f1aa8c36b04bcb2109f
  3:
    id: 3
    kind: block
    title: Cross-Module Parameter Source Confusion
    notes: >-
      In the previous example, you can still see that the `user` value gets retrieved from
      the `request.args` during validation but from the `request.form` during data retrieval.


      A more subtle example, where this is not immediately obvious (imagine, `authenticate_user`
      is defined in an another file altogether):
    http: null
    language: python
    parts:
    - part: 1
      file: r01_simplified_patterns/routes.py
      code_start_line: 104
      code_end_line: 120
    file_hashes:
      r01_simplified_patterns/routes.py: 23b903051e442e42b651db63c35ac475fb501c0f630bdfb7a92fa9dec34ac1ad
    fingerprint: 32d5e563917be3f356963f3dfb2eabfef910e9181d2334fd09d82d5b22e2e465
  4:
    id: 4
    kind: block
    title: Form-Query Priority Resolution
    notes: >-
      Shows how a helper function that implements source prioritization can create vulnerabilities.


      In Example 4 we don't need to specify body parameters to get a result (which is now
      more realistic!), but if we want, we can still access bob's messages by passing his
      user name in the request body:
    http: null
    language: python
    parts:
    - part: 1
      file: r02_custom_helpers/routes.py
      code_start_line: 54
      code_end_line: 69
    file_hashes:
      r02_custom_helpers/routes.py: 8bb18abd1ea679f7a0f6f209094bdda4759879992d7f60c59c51042182971226
    fingerprint: 4e4d02d1b027ed7e9edc8fbaafa4c860240cfee31d7ffac5ef02d44aa822a6c7
  5:
    id: 5
    kind: block
    title: Mixed-Source Authentication
    notes: >-
      Shows how authentication and data access can use different combinations of sources.


      This one is interesting, because you can access Bob's messages by providing his username
      and Alice's password in the request query, while providing Alice's username in the request
      body:
    http: null
    language: python
    parts:
    - part: 1
      file: r02_custom_helpers/routes.py
      code_start_line: 83
      code_end_line: 98
    file_hashes:
      r02_custom_helpers/routes.py: 8bb18abd1ea679f7a0f6f209094bdda4759879992d7f60c59c51042182971226
    fingerprint: 2cabfa43092951a036c3b6b2995f167075de5510b5855ae44bef1d8acc0e1725
  6:
    id: 6
    kind: block
    title: Form Authentication Bypass
    notes: >-
      The endpoint uses form data for authentication, but request.values.get() allows query
      parameters to override form values, creating a vulnerability. Although designed for
      POST requests, the endpoint accepts both GET and POST methods, enabling the attack.


      Note that although the regular usage would rely on POST request (or PUT, PATCH, etc.),
      and wouldn't work with GET (because flask's request.values ignores form data in GET
      requests), the attacker can send both GET and POST requests (if the endpoint is configured
      to accept both methods).


      ```http

      POST /vuln/confusion/parameter-source/example6? HTTP/1.1

      Content-Type: application/x-www-form-urlencoded

      Content-Length: 26


      user=alice&password=123456

      ```


      However, the attacker can send both GET and POST requests (if the endpoint is configured
      to accept both methods).
    http: open
    language: python
    parts:
    - part: 1
      file: r03_request_values/routes.py
      code_start_line: 70
      code_end_line: 87
    file_hashes:
      r03_request_values/routes.py: 92f0ad9ba4bf3c219479e941dd835fcfb9bd5ae95e78acdea2c7588216c87d3c
    fingerprint: 7c9a7414ea64de7cc2bc8cebb0918c6e656c13bf8c7070e9f54621d480b252a2
  7:
    id: 7
    kind: block
    title: Request.Values in Authentication
    notes: >-
      Demonstrates how using request.values in authentication while using form data for access
      creates vulnerabilities.


      This is an example of a varient of example 6, as we do the similar thing, but now we
      can pass Bob's username in the request body with Alice's password, while passing Alice's
      username in the request query. Note that this example does not work with GET request,
      use POST.
    http: null
    language: python
    parts:
    - part: 1
      file: r03_request_values/routes.py
      code_start_line: 102
      code_end_line: 118
    file_hashes:
      r03_request_values/routes.py: 92f0ad9ba4bf3c219479e941dd835fcfb9bd5ae95e78acdea2c7588216c87d3c
    fingerprint: 1088bdcf5fb2b812ddf8900b12659a4e881dde6a1a3065eb830005d7eb5650ca
  8:
    id: 8
    kind: block
    title: Decorator-based Authentication
    notes: >-
      Shows how using decorators can obscure parameter source confusion.


      Example 8 is functionally equivalent to Example 4, but it may be harder to spot the
      vulnerability while using decorators.
    http: null
    language: python
    parts:
    - part: 1
      file: r04_decorator/routes.py
      code_start_line: 18
      code_end_line: 24
    - part: 2
      file: r04_decorator/decorator.py
      code_start_line: 9
      code_end_line: 16
    file_hashes:
      r04_decorator/decorator.py: 4619e3f8fb6e690326ceb8031b6e7477058159b2ce82632968c0ab22f5be0bf2
      r04_decorator/routes.py: 874362cadbb60eaefbe3932f90b23c7c5013d86d7d92df7167f741003ee79eb4
    fingerprint: b52e3eea2437e98917745d06ee2482c2dd9dc04659ae80f8a1574b1a05139c67
  9:
    id: 9
    kind: block
    title: Middleware-based Authentication
    notes: >-
      Demonstrates how Flask's middleware system can contribute to parameter source confusion.


      Example 9 is functionally equivalent to Example 4, but it may be harder to spot the
      vulnerability while using middleware.
    http: null
    language: python
    parts:
    - part: 1
      file: r05_middleware/routes.py
      code_start_line: 18
      code_end_line: 23
    - part: 2
      file: r05_middleware/middleware.py
      code_start_line: 9
      code_end_line: 22
    file_hashes:
      r05_middleware/middleware.py: 7be8f54cda7ee73c500580ef9b605340802d6bfcdca640d15a4c00e95ef50c11
      r05_middleware/routes.py: c1a6fce737d4d19c625ce265aac66435105170dc85611abeacf3bf61948a57cc
    fingerprint: b576312ef0e55d83e1ec8475f4e2be795dffeed76f03af1733a17b94883af89c
  11:
    id: 11
    kind: block
    title: '[Not Vulnerable] First Item Checked, First Item Used'
    notes: >-
      This example is not vulnerable and is meant to demonstrate how the vulnerability could
      realistically get added to the codebase during refactoring.


      We start by implementing a helper function `@check_group_membership` that checks that
      the user is a member of the group which messages are being accessed.
    http: null
    language: python
    parts:
    - part: 1
      file: r06_multi_value/routes.py
      code_start_line: 18
      code_end_line: 23
    - part: 2
      file: r06_multi_value/decorator.py
      code_start_line: 24
      code_end_line: 33
    file_hashes:
      r06_multi_value/decorator.py: 2227ae829d4ace127dc01b1d77556618d58793139ff96ea60ab1ad9c5225ce2c
      r06_multi_value/routes.py: 9d9d7a2dac8c80da6210d99a8a7742d854357d2f4b8e5ca58e5527e3d9a04a6b
    fingerprint: c23bc6cdc421528102550c688d87cf61e5522d8e9bcc7c948e7e75c00e2ae7a6
  12:
    id: 12
    kind: block
    title: Utility Reuse Mismatch — .get vs .getlist
    notes: >-
      Builds upon the previous example. Consider that we need to add a new API endpoint that
      allows the user to access the messages of multiple groups in a single request.


      We start by copying the previous implementation and changing the function body to iterate
      over all the groups in the request.


      The code looks clean and works nicely for the "happy path", but it is vulnerable as
      the function body now acts on the unverified data – remember that `@check_group_membership`
      only checks the first group in the request.
    http: null
    language: python
    parts:
    - part: 1
      file: r06_multi_value/routes.py
      code_start_line: 41
      code_end_line: 49
    file_hashes:
      r06_multi_value/routes.py: 9d9d7a2dac8c80da6210d99a8a7742d854357d2f4b8e5ca58e5527e3d9a04a6b
    fingerprint: 96ad1d3d64f76f616355f2b04444974cbda0eefbfeb8b6afc1f7bc246f43cd28
  13:
    id: 13
    kind: block
    title: Any vs All — Fail-Open Authorization for Batch Actions
    notes: >-
      Authorization incorrectly uses `any()` over the requested groups, allowing a user who
      is an admin of one group to grant membership for additional groups in the same request.
      The action then applies to every provided group. Correct behavior would require `all()`.
    http: null
    language: python
    parts:
    - part: 1
      file: r06_multi_value/routes.py
      code_start_line: 61
      code_end_line: 68
    - part: 2
      file: r06_multi_value/decorator.py
      code_start_line: 41
      code_end_line: 50
    file_hashes:
      r06_multi_value/decorator.py: 2227ae829d4ace127dc01b1d77556618d58793139ff96ea60ab1ad9c5225ce2c
      r06_multi_value/routes.py: 9d9d7a2dac8c80da6210d99a8a7742d854357d2f4b8e5ca58e5527e3d9a04a6b
    fingerprint: ddd6f335d601d52edd3535a7dd278e3ccdd98c7825b5e7bafd6d30d9511247a2
attachments:
  http/exploit-0.http: 0798c02c1757012b268c8a201890fbb4fb53418c868be6897354ce2812fd824d
  http/exploit-1.http: db134e194cdb975b2646d9f916473df14f9805b439e1e2f26b13c3277322047e
  http/exploit-11.http: d78d4707248df931747c5f745356ccc5e3d877b24460a48cb22379518de6ca2c
  http/exploit-12.http: 83469682c3db11147ae00d0d9c493c03c9b0ba1efba6b71f4fa72f02240bae6a
  http/exploit-13.http: 2f2a44507d831b9d1b8e6ee8ce76c4a5ce96664d5ae1a0ea18477ebbc7c7f417
  http/exploit-2.http: 9a833a312abbab4518989681ba072b44edf35439601aa0de692267b57419cfe8
  http/exploit-3.http: 910d836ddb592bdffeed7b881180b06f0343a2772570ae4aeca6ef7038de06c9
  http/exploit-4.http: 289a818dc4a304cb4e9f412af41054a8c839e5ad704a951eaffda1b68254efb1
  http/exploit-5.http: ff28093f43df1d503b3853c2777bb74be07be0f832b3022134aa67ce6b362f1c
  http/exploit-6.http: 988543b43aaf95700e915cd7d69ae2d0c5d617520a10cbe2f6777a9d871bd7cc
  http/exploit-7.http: b6b38780e020c72a15ca9063a6f9f7e0f75bc6eb15115813a1b0fd11478a419b
  http/exploit-8.http: 030669f0df5e2c44a0a2bb1a145f0208f3390acf5053cbb1e96d053cb8827eff
  http/exploit-9.http: 030669f0df5e2c44a0a2bb1a145f0208f3390acf5053cbb1e96d053cb8827eff
  images/image-0.png: bb70a6dffd6f2d4fced85c5020d2608458849ad86b20ddb54387ae4267f50f3c
  images/image-1.png: f1ad5afa27e0e8e9c7df1e2b15fcc58aaf02afbf352535d2014bfd8dae2ecae2
  images/image-3.png: e3d237f1d43aae13b6294025bf92d68347342edb9d9407870b9646d217d0a075
  images/image-5.png: 9d6a637120034fdc72780422ac73eb858c6479f2d36e6980bdf7fd38edbe68dc
  images/image-6.png: 596a59ba2f347f1e82b0144531369e174dc5b6782fa8aa5129199344687aaf18
  images/image-7.png: c6a8e3dbdf09c9a4d810330cabc6638feb8d3f9c874220e7407f917b17d08cf4
  images/image-source-merging.png: 226b0c9334337b8519564db5335dbee60e5b2e4021622fdac601ee0bd09e85b2
build_signature: a95e4e9a9d5213ed194c618234eebb36ad6cd486e891aeba7ebc3109a589048f
last_readme_fingerprint: c9d69ee488a712af0b4755e70be16bda612ef110910789dbab9c2ec87bfc7ff9
