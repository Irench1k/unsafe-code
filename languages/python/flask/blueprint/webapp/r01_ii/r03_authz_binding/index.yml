version: '1'
root: .
category: ii.r03-authz-binding
namespace: flask-ii-r03-authz-binding
examples:
  1:
    id: 1
    kind: block
    title: Secure Authorization Binding Baseline [Not Vulnerable]
    notes: >-
      This demonstrates the correct way to handle authorization binding in a multi-user application.
      Authentication establishes WHO the user is, and authorization checks verify that the
      authenticated identity has access to the requested resource.


      Key security properties:

      - Authentication via Basic Auth establishes `g.user` (WHO)

      - Authorization checks use the SAME source for the resource identifier (group parameter)

      - The data retrieval also uses the SAME source for the resource identifier

      - No user-controlled parameters can rebind the resource after authorization


      This example provides two endpoints:

      1. `/groups/<group>/messages` - Returns messages from a specific group (path parameter)

      2. `/user/messages` - Returns user's private messages, or group messages if `group`
      query param provided


      In both cases, the authorization check and the data access use the same source, preventing
      any binding drift attacks.
    http: null
    language: python
    parts:
    - part: 1
      file: r01_baseline/routes.py
      code_start_line: 28
      code_end_line: 58
    file_hashes:
      r01_baseline/routes.py: 5f671caa90a924061941f71f9e508519ff84e306865fb6ddefb99f85a26c2207
    fingerprint: 4005aa378fdf52a2624f8537118dbe95608dac27b0b6788ad8354d6c10808fb7
  2:
    id: 2
    kind: block
    title: Authorization Binding Drift via Path-Query Confusion
    notes: >-
      This example demonstrates authorization binding drift caused by a decorator that merges
      path and query parameters with query-priority.


      THE VULNERABILITY: Authorization binding drift, NOT source precedence.

      - Authentication establishes WHO: Plankton (verified identity)

      - Authorization checks WHICH resource: staff@chum-bucket.sea (from query param)

      - Action accesses DIFFERENT resource: staff@krusty-krab.sea (from path param)


      The key insight: We know WHO Plankton is (authentication succeeded), but we allow him
      to control WHICH resource the authorization checks versus WHICH resource gets accessed.


      Attack flow:

      1. Plankton authenticates as himself (WHO = plankton@chum-bucket.sea) ✓

      2. Authorization decorator checks access to staff@chum-bucket.sea (query param) ✓

      3. Handler retrieves messages from staff@krusty-krab.sea (path param) ✗


      This is binding drift because the authenticated identity is correct, but the resource
      identifier gets rebound between authorization and action.
    http: null
    language: python
    parts:
    - part: 1
      file: r02_path_query_confusion/routes.py
      code_start_line: 35
      code_end_line: 50
    file_hashes:
      r02_path_query_confusion/routes.py: 340e8de944fa34db6fe8ff8e79d0bab99654e8a7bddec5ab7dbb1cb0fdf530af
    fingerprint: d2a8205376fa9dd9ce445495606c3b98db4ed3624af05463eddde9dea5e44bc1
  3:
    id: 3
    kind: block
    title: Authorization Binding Drift Despite Global Source of Truth
    notes: >-
      This example attempts to fix the binding drift by introducing a single source of truth
      (g.group), but the vulnerability persists because handlers still use path parameters
      directly.


      THE VULNERABILITY: Authorization binding drift via inconsistent source usage.

      - Authentication establishes WHO: Plankton (stored in g.user) ✓

      - Decorator sets g.group using query-priority merging ✓

      - Authorization checks WHICH resource: g.group (staff@chum-bucket.sea from query) ✓

      - Action accesses DIFFERENT resource: group parameter (staff@krusty-krab.sea from path)
      ✗


      This demonstrates that even "single source of truth" patterns can fail if:

      1. The source is populated with user-controlled priority logic

      2. Some code paths ignore the source and use raw request data


      Attack flow (same as Example 2):

      1. Plankton authenticates as himself ✓

      2. Decorator sets g.group = "staff@chum-bucket.sea" (query param) ✓

      3. Authorization checks membership in g.group ✓

      4. Handler uses path param "staff@krusty-krab.sea" instead of g.group ✗


      The fix would be to either: a) Always use g.group in handlers (never path params directly),
      OR b) Don't set g.group with merging logic - use path param directly everywhere
    http: null
    language: python
    parts:
    - part: 1
      file: r02_path_query_confusion/routes.py
      code_start_line: 82
      code_end_line: 97
    file_hashes:
      r02_path_query_confusion/routes.py: 340e8de944fa34db6fe8ff8e79d0bab99654e8a7bddec5ab7dbb1cb0fdf530af
    fingerprint: 695f807cb798e0c4f7174bc27e3f8549f4f1034d744aadbc4b5f48038c0e41db
  4:
    id: 4
    kind: block
    title: Classic Authorization Binding Drift - User Identity Rebinding
    notes: >-
      This demonstrates the most straightforward form of authorization binding drift: the
      application authenticates WHO the user is, verifies they have access to a resource,
      but then trusts a user-controlled parameter to determine which identity to ACT AS.


      THE VULNERABILITY: Identity rebinding after successful authorization.

      - Authentication establishes WHO: Squidward (verified via Basic Auth) ✓

      - Authorization checks WHICH resource: staff@krusty-krab.sea (verified member) ✓

      - Action uses DIFFERENT identity: spongebob@krusty-krab.sea (from request body) ✗


      This is the purest form of authorization binding drift: we authenticate the user correctly,
      we authorize them for the correct resource, but then we let them rebind their identity
      when performing the action.


      Key insight: This is NOT about confused parameters or different sources. It's about
      trusting user input for identity AFTER authentication succeeded.


      Attack scenario:

      1. Mr. Krabs announces Employee of the Month voting in the staff group

      2. Squidward (who desperately wants the recognition) authenticates as himself

      3. He's authorized to post to staff@krusty-krab.sea (he's a member)

      4. But the API trusts the "from_user" parameter from the request body

      5. Squidward posts a vote for himself while claiming it's from SpongeBob


      Impact: Squidward can impersonate SpongeBob and manipulate the vote!
    http: null
    language: python
    parts:
    - part: 1
      file: r03_simple_rebinding/routes.py
      code_start_line: 39
      code_end_line: 76
    file_hashes:
      r03_simple_rebinding/routes.py: 9717ac94f8b5082bc0654fbba25c79420b6edd295ec1ea29608023adba8bff84
    fingerprint: a9c14168a31c5075013ba1e0009b9ba9b20907111e248ccbb65399c9a1cea313
  13:
    id: 13
    kind: block
    title: null
    notes: null
    http: null
    language: python
    parts:
    - part: 2
      file: r01_baseline/decorator.py
      code_start_line: 20
      code_end_line: 36
    file_hashes:
      r01_baseline/decorator.py: 8b681ce69fafe2466d6980fd3567d52452842e936238402fae306655d919583d
    fingerprint: 1af00a9e12f69d4b9f54c4a960c60e7f63d109f3b85ea3ffa6815d193f5c8adb
  14:
    id: 14
    kind: block
    title: null
    notes: null
    http: null
    language: python
    parts:
    - part: 2
      file: r02_path_query_confusion/decorator.py
      code_start_line: 21
      code_end_line: 50
    file_hashes:
      r02_path_query_confusion/decorator.py: 32a3e8ade10bcca35dfc72824a86a68329bdbb61891fd23ac26bf61fcf152214
    fingerprint: cdf60a2a236775d760db7afb19925e39baafafed4ae34be03ec09da1adecd1d6
  15:
    id: 15
    kind: block
    title: null
    notes: null
    http: null
    language: python
    parts:
    - part: 2
      file: r02_path_query_confusion/decorator.py
      code_start_line: 59
      code_end_line: 92
    file_hashes:
      r02_path_query_confusion/decorator.py: 32a3e8ade10bcca35dfc72824a86a68329bdbb61891fd23ac26bf61fcf152214
    fingerprint: 2c4e7305eabdcc7837671be88295ff33f6d64b87c1c033783ca3f600cff2da71
attachments:
  http/exploit-1.http: e097a7fe9c9d94974e5707d78b8dc74ee77eb53b27c239e80365a4496919a48c
  http/exploit-2.http: 0d0baef8a76d4f626944d9512ff14712a895e30156d620acb44f8442f7d75c9c
  http/exploit-3.http: 4df1dfed244b6dcc9e538905445f8d5246f6ab7ea3647878ea803233f1bb1bb4
  http/exploit-4.http: bcea218359dbc7834edabf86e73cc5b56ce9f09918a5e1e4e80906848f132cb1
build_signature: c653bcaa20d51d997b6972a778f8f267a0b760449a514ce2abd9b03dfbce9cae
last_readme_fingerprint: cc32f9fd4dd93aadd355776023eaf2ff250a174248e3aa05e5eaebe6c1a68588
